package com.energyict.protocolimpl.landisgyr.s4.protocol.dgcom.command;

import com.energyict.cbo.Unit;
import com.energyict.protocol.IntervalData;
import com.energyict.protocol.IntervalValue;
import com.energyict.protocol.MeterEvent;
import com.energyict.protocolimpl.landisgyr.s4.protocol.dgcom.S4;
import com.energyict.protocolimpl.utils.ProtocolTools;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;

import java.math.BigDecimal;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.TimeZone;

import static org.junit.Assert.assertEquals;
import static org.mockito.Matchers.anyInt;
import static org.mockito.Mockito.when;

/**
 * @author sva
 * @since 12/12/2016 - 10:37
 */
@RunWith(MockitoJUnitRunner.class)
public class LoadProfileDataCommandTest {

    @Mock
    S4 s4;
    @Mock
    CommandFactory commandFactory;
    @Mock
    LoadProfileAndSeasonChangeOptionsCommand loadProfileAndSeasonChangeOptionsCommand;

    @Before
    public void setUp() throws Exception {
        when(commandFactory.getS4()).thenReturn(s4);
        when(commandFactory.getLoadProfileAndSeasonChangeOptionsCommand()).thenReturn(loadProfileAndSeasonChangeOptionsCommand);
        when(loadProfileAndSeasonChangeOptionsCommand.getProfileInterval()).thenReturn(900);
        when(loadProfileAndSeasonChangeOptionsCommand.getLoadProfileChannelUnit(anyInt())).thenReturn(Unit.getUndefined());
        when(loadProfileAndSeasonChangeOptionsCommand.getNrOfActiveChannels()).thenReturn(2);
        when(s4.getTimeZone()).thenReturn(TimeZone.getTimeZone("GMT"));
    }

    @Test
    public void testCollect() throws Exception {
        LoadProfileDataCommand loadProfileDataCommand = new LoadProfileDataCommand(commandFactory);

        byte[] data = ProtocolTools.getBytesFromHexString("B3405A00C0005C00C5005A00B9405A00A9005C00AB405B40960057408C40574090005900A5005740B0405600B3405900B4005C00B5405C00AB405C00AC005C00AE405D40A7405A00A6005B40AB405C00B2005B40BA405F00B1005E40B0406500B1006500AE406300AF006000AC005E40B0405E40AE406000AE406000AF006000B9406140C4406140BD006140B2006000B7006300C7406140BF406240B9406440B5405F00B8005F00BA406240B7006000B7006240B2006000B2006140AA005D40C4406140C0005E40B2005E40A9005C00C2405F00D1005F00CD405F00CD405F00B3405C00B3405D40B2005C00AF005D40B0405D40B3405E40B1005D40B5406000B2005F00B1005F00B2006000B3405E40B2005E40B2005E40AE405B40AE405D40B4006240B6406300B0405F00A9005F00A60060008C40600089405E408F4061408D005B408700590087005A0022918A405B409E405E4096005C0089405A008B005C008B005C008A405A008C405C0089405A008C405A0091405A00BD005A00B1005740AE405900AA005600BE005840A7405840A6005B40A3005840B3405740A9005500AD405600B0405840B3405600B5405900B5405A00BD005C00B2005E40AC005D40A9005A00AF005D40A6005B40A6005A00B3405C00AF005B40B0405B40AE405F00AA006000AE406300AC005F00AD405F00AD406000A9005F00B0406000AD406000B4006000B2005F00B4006240CB406500B4005F00AF006000AF006000B0406240AE406000B4005F00C7406500B6406000B6406240B5406140B6406300AE406000A4405B40B5405F00BD005F00B8005D40BA405E40C3005E40D3406000D2006140CB405F00CE406000B5405F00B0405C00B3406240B0405E40B1005F00B0406000AF005F00B4006300AF006300B6406600B5406740AC005F00B1006140AF005F00AF005F00B7006440AF006000A8405E409E405B408800600082005D408540614088005A008700590087005C0023918E005E4088005C0087005C009B405C00A1405C008D005B4088005B4088005A0088005A0087005A008F405900B1005B40B04058409E405740B9405A00BF405900A5005740A3005A00A7405A00A4405840900056008F405600B2005740B0405740B1005600B5405B40B6405D40B2005E40AC005D40B2005E40AD405C00A9005C00A5005900AE405C00B5405E40B2005E40B3406300B2006740AF006300AD406440B0406500B4006240AD405F00AF006600B3406600C0006740B6406600BE006500D0406500C0006440BE006440BF406500BB006300B2006140B0406140C6006500CF006440D9406740D4006300D4006740CD406440C4406300C2406140AD405F00A8405D40AC005C00CA006000D1006000D4006300CE406140CA006240BB006840B4006440B6406440B3406240B2006140" +
                "B0406240B7006440B2006000B1006140B5406300B3406240B7006300B6406300B5406600B8006600B7006440B4006240B0406500A4405F008D0061408C4062408F40644089405D4088005D4088005E40249189405F0089405E4088005A0089405B4099005C0097405B408E005A008A405A0086405B408C405D40B4005D40AA005D40A3005E40B6405F00B9405D40C4405F00BF405C009E405D408B005C0090005F0089405B408A405B4095005B408E005B4090005B4093005D40B0405F00AB405C00A8405F00A4405E40A6006000A6005D40AA005D40AC005E40B3406000AD406000AF006000AC005F00AA006240AB406600A9006300A8406240A6006000A2405F00AA005F00AE405F00A8406000A8405E40AF005E40BC406000B1006000B4005F00B1006000B3406140AB405D40C3006140B1006240AA006000A7406140A6006000AA006240A3006140A3005F00B6405F00C0006000B5405C00BC406000CA006240CE406240D1006140D0406440BB006300B1005F00B3406140B4006440B4006600B5406500B4006440B2006240B3405E40AF005D40AD405E40AF005D40B1005D40B1006000AF005E40B4006140B0405E40AB405E409F005F008B005F008F405D4090005F0089405C0088005D4088005C002591914061408B0060008B005F008B005D408D005B4090005C008F405D408A405C008A405C008F405F00A3005F00A6005C009E405A00B9405E40BC405E40BF405C00B7005C00A5005E40A8405D409F005C008D005C0088005A008C405A008D0059008D00590090005D4092405D40B1005C00A6005C00A7405C00AA005D40A7405B40A8405840A7405B40B3405D40B0405A00B3405B40B0405C00A8405E40AF005F00A6005A00A5005B40AB405E40A7405C00B0406240AF006140B9406300B4006240AF006140C9006300BE006240AE406140B7006140B6406240C3006300BB006440B5406240B4006300AC006000AC006140AA006000B0405F00C0005E40B6406000A7405B40BD005E40CD405E40CA005E40CE406000CF005E40BE005F00B6406140B4006000B4006240B3406000B3406140B9406300B3405F00B7006140B2005F00B3405E40B8006140B1005F00B3405F00B5406240B3406240B7006840B6406600B0406000A4405F008D00624090006440900063008C405E408C405C008B005C0026918B005D408C405E408C405F008B005D409B4060008E005D408B005E408E005E4091405D409A005E40AD405B40A8405C00A3005840BD005B40BA405B40BC405C00AF005C008E005D4088005B4089405A0088005900880059008A40590089405A008A4059008C405C00A5005C00AF005D40B2005B40A7405A00A0005900A1405900A4405E40AF005E40AC005D40A5005D40A9005F00AD406440AC006140B5406240AA005C00A9005F00AE40" +
                "6300AA006140AE406140B6406440B0406000C0006300C8406440B7006240B5406240C8406500BB006900BA406900BB006740BC406840BF406840BC406740B8006740B3406740B5406440B4006000C8406440BE006240AE406000BC406140CF006240D1006140D1006300D1006140C2406440B3406300B5406240B8006500B5406440B6406440B7006440B5406440B6406440B7006500B6406440B5406300BB006600B4006300B7006500BA406740B7006300B6406240B4006240A3005F008F406240900064408D0063008D005E4089405C0088005A0027918A405B408E005D408D005E4089405E408C405E408A405E408B005D4089405C008C405C008F405E4094405D40A5005D40A9005B40B4005D40B6405E40BD005A00B2005740900058408E0059008D0058408D00584093005A0091405740944058408F4057408D005A009A005B40A9005A00A2405B40A3005C00A2405A00A0005B40A8405C00B1005E40A8405C00AC006000AD406240AF006240AA005D40A9005A00A9005E40A9005E40A9005C00A5005900AD405D40B9405F00B6405E40C4406140C1406000B1005E40AD405E40B7005E40B2005F00B2005F00B2005E40B3405E40BE006240B6406000B5405F00B3406000B6405D40C7405D40BF405E40AD405E40AC006000C2406440CC006140D6406740D4006500D0406440B9406500B3406140B9406740BE006C00B7006740BA406600B9406500B8006500B9406600B5406600B9406740B6406300B6406240B2006000B4006240B4005F00B5405F00B6405F00AE405D40A5005C008F4061408E005F008F4061408C405D408B005F008D005E4028918C405F008E005F008B005E408C405E4096005D408F405A008B005A008D005B4094405D40AD405E40B4005B40A2405900BF405D40BF405C00BB005A00C3005B40B80059009B405B408A4058408B0057408B00574090005A00A5005A00B4005A00B3405A00B3405E40B5405D40B6405E40AC005E40AC005F00AA005E40B3406000B5406300B1006240AE406140B1006500AE406440AF006140AE406000B0406140AE405F00B4006440AB405F00AF006140B5406500B3406300BA406440BC406240B9406440C3006240B8006240B9406240B3406440B4006140B7006140B9406140CC006500B8006240B1006300B2006140A9005E40B7006140BC406000B8005F00B3406140B0405E40CA006000D7006300CF006240C3006240B8006300B3406440B7006500B3406300B3406440B6406500B7006500B3406900B9406C00B6406A00B7006A00BA406B40B1006600B1006600B6406740B0406300B0406440B2006300AB406140A0006140900066008A4061409000644087005B4088005D4089405E40299190005F0087005D4087005D408A405F008B005D4089405E4088005E4088005F0090005E40" +
                "A1406140B8006000C0005E40BB005B40B1005C00A1405840BD005A00C2405A00A4405C009D405A0095005A009A00590096005740A2405B40B6405900B9405A00B6405F00B6405E40B6405E40B1005E40A9005E40A7405D40A9005D40B0405E40B4005F00B9406140AB405D40AE405F00AF006600AB406440A7405C00AB405F00AF006300AC006240AB406140B4006300B8006300CF006740C6006500B6406500B3406440B3406240CC006440C2406240299175DF299176DFAF00614075403F004EE056E056E099E05D403140B8006440BC406240BC406500B2006000AC005E40A7405D40AC005F00B1005D40B6405B40B2005F00B5406240CC006440D7006300CF006140CF006600B6406140B1006140B4006440B4006300B1006300B8006840B3406500BB006740B1006440B1006440BB006600AE406240AF006440B6406740B5406840B3406740B6406500AE4063009F0063008E006740944068408D00684089405E4089405E4087005D40309188005E408D0060008D0061408E00600088005E408D005F0089405F0088005E4087005D4091405E40A1405C00A2405D409D405A00A1405B40BB005C00C0005C00C5005D40C5005D40B6405A00A6005900AD405840A8405740AF005B40B3405A00B4005C00B2005E40B2005C00B4005D40AA005D40AD405D40B4006240AE405F00AB405E40B4005E40B9405F00B7006140BC406300B5406300B1006240B3406500B4006740B7006900B0406740B1006440BC406A00BA406240BA406500BA406300BC406300BC406300D3406600D8006500D0406440C1406300C6006500C1406300C6006300C0006440C6006600BE006440B5406140B8006000BC406000C0006000B6405E40BB006000C1405E40D8006300D7006300D3406140C5006240BD006140B9406140BD006300B9406240B6406140BA406240B6406240B8006240B6406240B9406300BC406440B4006140B3406000B7006600B8006740B9406840BB006500AE406240A30061408F4063008D0062408F40650088005D408B005E4089405E4001928C406140914062408C405E4089405E4094405F008B005E409B405D408F405D408D005C00A7405F00CA006000B5405B40C2405D40BD005C00C0005D40C3005B40B2005B408D005B408E005A008C4058408D0058408F405740B3405900B4005A00BB005F00B5405F00B8005E40B8005D40AC005D40AE405E40B7005F00B1006140B1005F00BA406140B9406240BB006740B3406440B1006500B0406300B4006000AD406000AB406000B1006240AC006000B0406300B9406840B9406440BC406740BA406600B6406440B8006600CA006900D1006740BF406440BB006600C0006740BB006500C2406740BE006440BC406300B0405F00B2006140AC005E40A6005C00AF005E40D5405F00C6006000BB006000" +
                "CF006140D2006300CB406300CF006900D5406F00B9406500B6406300BB006740B6406440B4006240BA406440B2006000B7006240BA406600B1006140B2006240B7006300B5406240B4006240B7006440AA0060009F0060008C4060008C4062408B0062408C405E4089405F008A405F0002928D0060008E00614088005F0087005C0097405D40AA006140A90061409F005F0095005F00A5006140AC005F00B0405C00BC405B40BE005A00BF405D40C0005A009F0058408700590084005840864058408640574086405840B0405C00BD005E40B7005E40B2005E40BA405E40B5405E40AA005E40AF005D40AC005F00A6005E40B5406240B0405F00A5005B40AF006300B4006440AC006240B3406500B0406300AF006300AB406440AB406140AA006300B0406440BD006500CC006500B4006440B2006500B2006740C3006600C4406840BB006440B6406740BD006840BF406900BC406900B8006740B6406840B3406600AA006300AC006000BD006140A6006140AC005F00C4405C00D3406300CC006140CE406240B3405F00AE405D40B5406000B1005E40B2005F00B8006000B4005F00B7006140B3406140B3405F00B2005F00B6406140AF005F00B0406000B5406000B2006140B7006600B9406900B6406440B1006140A30061408A40614093006240950064408F4062408F405F008C405D4003928D005F008E005F008E005F0099005F009F00600094405F008D005D408E005D408F405E4093005E40A3005E40BD006140BF405F00B4005C00B6405A00B0405900A7405C0091405B408F405C008C4059008E00590091405900900058408F4058409240584092405C00A7405B40B5405B40A7405A00AC005A00A5005840A8405900A8405840BC406140B1005D40B7006300AF006140B2006740AD406600AC006300AE406240AC006000AD406300B0406600AC006440B4006840AC006600B8006C00BB006900C7406A00B4006740BF406840AE406500BD006B40C6006740CC006840BE006900B8006B40B4006A00B0406500B1006500AE406240AA006140B1006000BA406140B8005E40D6406240D4006300D1006240BD006300B2006140B6406300BA406440B6406300B9406500BA406500B6406300B8006440B5406240B6406240BE006500B6406240B6406300BB006500B7006240B4006240BE006500BB006500B4006900AA006A0096006600930066009440674092406000914060009500624004928F405E4090005F008F405F0090005F008D005E408F405F008F405E408E005D40A3005F00BE006240B7005E40C1405C00C2405D40B9405C00A7405B40AC005A0095005A008C405B4090005D4090005C0092405D4093005A0096005B4092405B4091405B4098405D40A1406240BC405F00AF005D40AE405E40AB405D40A8405900AF005C00AB405A00B640" +
                "5C00BC405E40B6406140B7006600B7006600B5406140B2005F00B6406000AD405F00B2006440B4006440B3406140B8006500C2406440B4006240C0006300CF006500AE405F00AE406000B3406140B9406440BF406240B8006240BA406300B6406000B0406140B4005F00C7405F00AE405F00A7405B40B0405E40D7006240D7006240D6406240CC005F00B6405F00BC406300B8006000B9406240BD006300B8006000BB006500C0006900BC406500B9406300C1406600BA406440BC406440B9406140B9406140B7006140BE006240BD006500BF406500B9406500A9006140924060009440600095006300960062409300600092405E40059290005F009240600090005E409A005F0092405D40A140600091405C0090005B4090005C0095005C00B5405E40B8005C00BB005D40C4405C00BD005B40BE005A009A005B4095005B4091405900930059009000584094405900B6405B40B6405B40B5405C00BB005C00BF405F00BF405D40C1406000B4005D40B3405E40B9406240B9405F00BD005F00BC405F00BA406140BF406900BD006900BA406740BF406900B8006600B9406440BB006600BA406300B8006300C0006500D1006600D2006600D8006840CE406840BC406600BC406600BA406500BE006600C1406500BF406440D5406740C6006840CD406740B7006300B4006240B1005F00B0405F00C8406140B6406000BF405D40DF406140E0406600D9406300CF006240BF406000BA406000B9406240B6406000B6406140BB006440BD006440BB006240BB006300B8006240BA406440BB006500B5406500B6406440BC406500B9406A00BA406900BF406900B4006440AC00660094406440990067409440674091406240930060009000614006928C4060008F406000900061409F0061409F0060008B005E408A405F008B005E408D005D409C005F00BC405E40B8005E40BA405C00C6005D40C2405C00C6005C009E405C0091405B4090005B408D00590092405A0092405840B9405E40B9405B40B9405C00BC405F00C2406140C3006140BB006140B7006140B4006000B1006140B2006000B5405E40BA406000BC406240BA406500B0406140B6406440B6406440B2006240B5406240B7006500B1006000B5406240C2406600C9006300BC406440BA406500B7006500BC406500BB006600BB006600BD006500C7406600C4406500DB006840C5006440C0006600B5406240B7006240AD405E40AE405D40BD005E40B6405E40B9405B40D1006000DE006300DF406500C5006140DE006440DD006440C9006440C1406440BC406140B9406240BF406240BC406140BE006240BA406140BE006240BF406840BC406900BD006900BF406840BF406440BD006500BF406740B3406600A4406440974061409140614094406600930060008F405F008E00614007928C406000" +
                "8E00600095005F009E406140A0005F00950063008D005F0093005E409C006000A6005E40AC005C00B2005B40C3005C00C5005D40C2405B40B2005B408D0059008C4059008F405B4094405A009000590093005A00B9405B40BA405E40B9405E40BE006000BE006140C0006140C2406440BC406500B9406440B6406600B5406600BC406440C4406840BB006300B5406300BB006740B7006840B7006740C2406E40BD006740B7006300BC406840BC406A00BB006900C9006900D1006B40BD006840DA406B40C4406A00C9006740D1006840D2006B40E5406B40DB006740C7406840C5006A00C0006740B7006440B8006440BC406300C9006600C4406140B5406140C1406240D5406600DE006600E1006840DB006A00D0406A00C2406900BB006600C1406740BC406500BA406500C2406840BB006600BA406600BE006740C1406A00BA406500B8006500BE006740B9406600BA406600BA406740BD006900B3406740A8406600914064409300660094406840924064408F4060009140600008929300644091405F009B40600099005E40A00060009740614095005E4092405F00A90062409F005F00A8405F00C4406000B2005D40BE006000B2005D40B0405B40A4405E408E005B409440600091405B4094405C0092405A00B2005C00BF405E40BD005E40C2406240C2405F00BC406000C0006000B6406300B4006240B6406300AF006000BC406300BC406240BB006300B7006300B2006300B1006140B3406140B2005E40B5406000B4006240B5406140B4006300BB006740B7006300B7006500B9406600B9406440CE406600C1406600B2006300B5406240BB006300BD006440C0006600B6406500BB006840B1006140B1006440B1006440AA006300AB406300B9406440BA406300BF406600DD006B40D4006840DD007040C6006E40C1406900BA406C00B7006740B9406D40B0406740BB006C00B1006740B1006740B6406840B3406840B3406840B0406500AE406300B0406500AD406300B0406300B1006600AA0064409E4062408940650084006300880066008C405E408A405D408C40600009928B0060008D0060009440600095006000974060009500600090005E40950060009A00624092405E40B9406000C0006000BC405B40B9405900AD405B40B04058409E405840864058408A40584089405840894059008E005A00B0405C00B5405C00B7005D40B8006000B9406000B7005F00BA405D40B3405F00AC005F00AA006140AB406240B2006140BA406600B3406440AF006600B3406840AD406500B0406600B1006740B3406600AF006500B4006900B4006A00B2006600B5406B40BD006C00BA406E40B8006A00B6406C00B7006A00B9406900D3406C00D4006D40BE006900C3006E40BB006E40B3406900B8006A00AC006440AA006300A8406240A8406440", "");

        // Business method
        List<IntervalData> collectedIntervals = loadProfileDataCommand.collect(data);
        List<MeterEvent> meterEvents = loadProfileDataCommand.getMeterEvents();

        // Asserts
        assertEquals(1696, collectedIntervals.size());
        assertIntervalData(
                new IntervalData(
                        new Date(1479773700000L),
                        0, 0, 0,
                        Arrays.asList(new IntervalValue(new BigDecimal(138), 0, 0), new IntervalValue(new BigDecimal(91), 0, 0))
                ),
                collectedIntervals.get(0)
        );
        assertIntervalData(
                new IntervalData(
                        new Date(1481299200000L),
                        0, 0, 0,
                        Arrays.asList(new IntervalValue(new BigDecimal(168), 0, 0), new IntervalValue(new BigDecimal(100), 0, 0))
                ),
                collectedIntervals.get(1695)
        );
        assertMeterEvents(meterEvents);
    }

    private void assertIntervalData(IntervalData expectedIntervalData, IntervalData actualIntervalData) {
//        assertEquals(expectedIntervalData.getEndTime(), actualIntervalData.getEndTime());
        assertEquals(expectedIntervalData.getEiStatus(), actualIntervalData.getEiStatus());
        assertEquals(expectedIntervalData.getProtocolStatus(), actualIntervalData.getProtocolStatus());
        assertEquals(expectedIntervalData.getValueCount(), actualIntervalData.getIntervalValues().size());
        for (int i = 0; i < expectedIntervalData.getValueCount(); i++) {
            assertIntervalValue((IntervalValue) expectedIntervalData.getIntervalValues().get(i), (IntervalValue) actualIntervalData.getIntervalValues().get(i));
        }
    }

    private void assertIntervalValue(IntervalValue expectedIntervalValue, IntervalValue actualIntervalValue) {
        assertEquals(expectedIntervalValue.getEiStatus(), actualIntervalValue.getEiStatus());
        assertEquals(expectedIntervalValue.getProtocolStatus(), actualIntervalValue.getProtocolStatus());
        assertEquals(expectedIntervalValue.getNumber(), actualIntervalValue.getNumber());
    }

    private void assertMeterEvents(List<MeterEvent> meterEvents) {
        assertEquals(6, meterEvents.size());
        assertMeterEvent(meterEvents.get(0), new MeterEvent(new Date(1480425918000L), MeterEvent.SETCLOCK_BEFORE));
        assertMeterEvent(meterEvents.get(1), new MeterEvent(new Date(1480425924000L), MeterEvent.SETCLOCK_AFTER));
        assertMeterEvent(meterEvents.get(2), new MeterEvent(new Date(1480427220000L), MeterEvent.POWERDOWN));
        assertMeterEvent(meterEvents.get(3), new MeterEvent(new Date(1480427268000L), MeterEvent.POWERUP));
        assertMeterEvent(meterEvents.get(4), new MeterEvent(new Date(1480427268000L), MeterEvent.POWERDOWN));
        assertMeterEvent(meterEvents.get(5), new MeterEvent(new Date(1480427670000L), MeterEvent.POWERUP));
    }

    private void assertMeterEvent(MeterEvent actualMeterEvent, MeterEvent expectedMeterEvent) {
//        assertEquals(expectedMeterEvent.getTime(), actualMeterEvent.getTime());
        assertEquals(expectedMeterEvent.getEiCode(), actualMeterEvent.getEiCode());
        assertEquals(expectedMeterEvent.getProtocolCode(), actualMeterEvent.getProtocolCode());
        assertEquals(expectedMeterEvent.getMessage(), actualMeterEvent.getMessage());
    }
}