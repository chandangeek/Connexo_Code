Ext.define("Isu.override.ProxyOverride",{override:"Ext.data.proxy.Server",buildUrl:function(b){var a=this.callParent([b]);a=Ext.Loader.getBasePath()+a;return a}});Ext.define("Isu.controller.history.Workspace",{extend:"Uni.controller.history.Converter",rootToken:"workspace",previousPath:"",currentPath:null,routeConfig:{workspace:{title:"Workspace",route:"workspace",disabled:true,items:{datacollection:{title:"Data collection",route:"datacollection",controller:"Isu.controller.DataCollectionOverview",items:{issues:{title:"Issues",route:"issues",controller:"Isu.controller.Issues",action:"showDataCollection",items:{view:{title:"issue details",route:"{id}",controller:"Isu.controller.IssueDetail"},edit:{title:"Issue Edit",route:"{id}/addcomment",controller:"Isu.controller.IssueDetail"},assign:{title:"Issue Assign",route:"{id}/assign",controller:"Isu.controller.AssignIssues"},close:{title:"Issue Close",route:"{id}/close",controller:"Isu.controller.CloseIssues"},notify:{title:"Notify user",route:"{id}/notify",controller:"Isu.controller.NotifySend",action:"showNotifySend"},send:{title:"Send to inspect",route:"{id}/send",controller:"Isu.controller.NotifySend",action:"showNotifySend"}}},bulk:{title:"Bulk Changes",route:"bulkaction",controller:"Isu.controller.BulkChangeIssues"}}},datavalidation:{title:Uni.I18n.translate("router.datavalidation","ISE","Data validation"),route:"datavalidation",controller:"Isu.controller.DataValidation",action:"showOverview",items:{issues:{title:"Issues",route:"issues",controller:"Isu.controller.Issues",action:"showDataValidation",items:{view:{title:"issue details",route:"{id}",controller:"Isu.controller.IssueDetail"}}},bulk:{title:"Bulk Changes",route:"bulkaction",controller:"Isu.controller.BulkChangeIssues"}}}}}},init:function(){var a=this.getController("Uni.controller.history.Router");a.addConfig(this.routeConfig)}});Ext.define("Isu.controller.history.Administration",{extend:"Uni.controller.history.Converter",rootToken:"administration",routeConfig:{administration:{title:Uni.I18n.translate("route.administration","ISE","Administration"),route:"administration",disabled:true,items:{assignmentrules:{title:Uni.I18n.translate("route.assignmentRules","ISE","Assignment Rules"),route:"assignmentrules",controller:"Isu.controller.IssueAssignmentRules"},creationrules:{title:Uni.I18n.translate("route.issueCreationRules","ISE","Issue creation rules"),route:"creationrules",controller:"Isu.controller.IssueCreationRules",items:{add:{title:Uni.I18n.translate("route.addIssueCreationRule","ISE","Add issue creation rule"),route:"add",controller:"Isu.controller.IssueCreationRulesEdit",action:"showCreate",items:{addaction:{title:Uni.I18n.translate("route.addAction","ISE","Add action"),route:"addaction",controller:"Isu.controller.IssueCreationRulesActionsEdit",action:"showCreate"}}},edit:{title:"Edit",route:"{id}/edit",controller:"Isu.controller.IssueCreationRulesEdit",action:"showEdit"}}}}}},init:function(){var a=this.getController("Uni.controller.history.Router");a.addConfig(this.routeConfig)}});Ext.define("Isu.model.Assignee",{extend:"Ext.data.Model",fields:[{name:"id",displayValue:"ID",type:"int"},{name:"idx",displayValue:"IDX",type:"string",convert:function(b,a){return[a.get("id"),a.get("type")].join(":")}},{name:"type",displayValue:"Type",type:"auto"},{name:"name",displayValue:"Name",type:"auto"}],idProperty:"idx",proxy:{type:"rest",url:"/api/isu/assignees",reader:{type:"json",root:"data"},buildUrl:function(b){var a=b.params.id,c;if(a){c=a.split(":");return this.url+"/"+c[0]+"?assigneeType="+c[1]}else{return this.url}}}});Ext.define("Isu.model.IssueMeter",{extend:"Ext.data.Model",requires:["Ext.data.proxy.Rest"],fields:[{name:"id",type:"int"},{name:"name",type:"string"}],proxy:{type:"rest",url:"/api/isu/meters",reader:{type:"json",root:"data"}}});Ext.define("Isu.model.IssueReason",{extend:"Ext.data.Model",requires:["Ext.data.proxy.Rest"],fields:[{name:"id",type:"int"},{name:"name",type:"string"}],proxy:{type:"rest",url:"/api/isu/reasons",reader:{type:"json",root:"data"}}});Ext.define("Isu.model.IssueStatus",{extend:"Ext.data.Model",requires:["Ext.data.proxy.Rest"],fields:[{name:"id",type:"int"},{name:"name",type:"string"}],proxy:{type:"rest",url:"/api/isu/statuses",reader:{type:"json",root:"data"}}});Ext.define("Isu.model.IssueFilter",{extend:"Uni.component.filter.model.Filter",requires:["Isu.model.Assignee","Isu.model.IssueMeter","Isu.model.IssueReason","Isu.model.IssueStatus"],hasMany:{model:"Isu.model.IssueStatus",associationKey:"status",name:"status"},hasOne:[{model:"Isu.model.Assignee",associationKey:"assignee",name:"assignee",setterName:"setAssignee",getterName:"getAssignee"},{model:"Isu.model.IssueReason",associationKey:"reason",name:"reason",setterName:"setReason",getterName:"getReason"},{model:"Isu.model.IssueMeter",associationKey:"meter",name:"meter",setterName:"setMeter",getterName:"getMeter"}],getFields:function(){var a=this.callParent();a.push("assigneeId");a.push("assigneeType");return a},getPlainData:function(){var b=this.callParent();var a=this.get("assignee");if(a){b.assigneeId=a.get("id");b.assigneeType=a.get("type")}return b}});Ext.define("Isu.model.IssueSort",{extend:"Uni.component.sort.model.Sort",fields:[{name:"dueDate",displayValue:"Due date"}]});Ext.define("Isu.model.IssueGrouping",{extend:"Ext.data.Model",fields:[{name:"value",type:"string"},{name:"display",type:"string"}],idProperty:"value"});Ext.define("Isu.model.ExtraParams",{extend:"Ext.data.Model",requires:["Isu.model.IssueFilter","Isu.model.IssueSort","Isu.model.IssueGrouping","Uni.util.Hydrator","Uni.util.QueryString"],fields:[{name:"groupValue",type:"int",defaultValue:null}],hasOne:[{model:"Isu.model.IssueFilter",associationKey:"filter",name:"filter"},{model:"Isu.model.IssueSort",associationKey:"sort",name:"sort"},{model:"Isu.model.IssueGrouping",associationKey:"group",name:"group"}],getSorting:function(b){var a=b.charAt(0)=="-"?b.slice(1):b,c=b.charAt(0)=="-"?Uni.component.sort.model.Sort.DESC:Uni.component.sort.model.Sort.ASC;return{name:a,direction:c}},clearEmptyData:function(a){for(var b in a){!a[b]&&delete a[b]}return a},getDefaults:function(){return{sort:"dueDate",status:1,group:"none"}},setValuesFromQueryString:function(m){var i=this,o=new Uni.util.Hydrator(),e=new Isu.model.IssueFilter(),f=new Isu.model.IssueSort(),k,c=Ext.getStore("Isu.store.IssueGrouping"),a=Uni.util.QueryString.getQueryStringValues(),d,j,l,b,g={},h;delete a.limit;delete a.start;if(_.isEmpty(a)){a=i.getDefaults()}d=_.pick(a,e.getFields());j=_.pick(a,f.getFields()).sort;l=a.group;b=a.groupValue;if(l){k=c.getById(l)}else{k=c.getAt(0)}if(b){g.reason=b}i.set("group",k);i.set("groupValue",b);if(Ext.isArray(j)){Ext.Array.each(j,function(p){h=i.getSorting(p);f.addSortParam(h.name,h.direction)})}else{if(j){h=i.getSorting(j);f.addSortParam(h.name,h.direction)}}i.set("sort",f);Ext.merge(g,f.getPlainData());if(_.isEmpty(d)){i.set("filter",e);m&&m(i,i.clearEmptyData(g))}else{var n=o.hydrate(d,e);n.then(function(){i.set("filter",e);Ext.merge(g,e.getPlainData());m&&m(i,i.clearEmptyData(g))})}},getQueryStringFromValues:function(){var b=this.get("filter"),d=this.get("sort"),c=this.get("group"),a=this.get("groupValue")||[],e={};Ext.Array.each(b.getFields(),function(f){e[f]=[]});Ext.Array.each(d.getFields(),function(f){e[f]=[]});if(c&&c.get("value")){e.group=c.get("value");e.groupValue=!b.get(c.get("value"))?a:[]}else{e.groupValue=[]}Ext.merge(e,b.getPlainData());Ext.merge(e,d.getPlainData());return Uni.util.QueryString.buildHrefWithQueryString(this.clearEmptyData(e))}});Ext.define("Isu.util.IsuGrid",{setAssigneeTypeIconTooltip:function(b){var c=b.getEl(),a=c.query(".isu-assignee-type-icon");Ext.Array.each(a,function(e){var d=Ext.get(e),f;if(d.hasCls("isu-icon-USER")){f="User"}else{if(d.hasCls("isu-icon-GROUP")){f="User group"}else{if(d.hasCls("isu-icon-ROLE")){f="User role"}}}if(f){d.tooltip=Ext.create("Ext.tip.ToolTip",{target:d,html:f});b.on("destroy",function(){d.tooltip.destroy()});b.on("beforerefresh",function(){d.tooltip.destroy()})}})},setDescriptionTooltip:function(a){var b=a.getEl(),c=b.query(".isu-grid-description");Ext.Array.each(c,function(f){var d=Ext.get(f),e=d.down(".x-grid-cell-inner"),g=e.getHTML();d.tooltip=Ext.create("Ext.tip.ToolTip",{target:d,html:g});a.on("destroy",function(){d.tooltip&&d.tooltip.destroy()});a.on("beforerefresh",function(){d.tooltip&&d.tooltip.destroy()})})},loadGridItemDetail:function(a,b){var c=this.getItemPanel(),d=c.down("form");c.setLoading(true);this.gridItemModel.load(b.getId(),{success:function(e){if(!d.isDestroyed){d.loadRecord(e);d.up("panel").down("menu").record=e;c.setLoading(false);c.fireEvent("afterChange",c);c.setTitle(e.data.title)}}})},selectFirstGridRow:function(d){var c=this.getItemPanel(),b=0,e=d.getNode(b),a;if(e){c.show();a=d.getRecord(e);d.fireEvent("itemclick",d,a,e,b)}else{c.hide()}}});Ext.define("Isu.util.IsuComboTooltip",{setComboTooltip:function(a){a.tooltip=Ext.DomHelper.append(Ext.getBody(),{tag:"div",html:a.tooltipText||"Start typing",cls:"isu-combo-tooltip"},true);a.tooltip.hide();a.on("destroy",function(){a.tooltip.destroy()});a.on("focus",this.onFocusComboTooltip,this);a.on("blur",this.onBlurComboTooltip,this)},onFocusComboTooltip:function(c){var b=c.tooltip,a=Ext.get(c.getEl());b.setStyle({width:a.getWidth(false)+"px",top:a.getY()+a.getHeight(false)+"px",left:a.getX()+"px"});if(!c.getValue()){b.show()}c.on("change",this.clearComboTooltip,this)},onBlurComboTooltip:function(b){var a=b.tooltip;a&&a.hide();b.un("change",this.clearComboTooltip,this)},clearComboTooltip:function(d,c){var a=d.picker,b=d.tooltip;if(c==null){d.reset();a&&a.hide();b&&b.show()}else{b&&b.hide();if(a){a.show();Ext.get(a.getEl()).setStyle({visibility:"visible"})}}},limitNotification:function(b){var a=b.getPicker();if(a){a.un("refresh",this.triggerLimitNotification,this);a.on("refresh",this.triggerLimitNotification,this)}},triggerLimitNotification:function(a){var b=a.getStore(),c=a.getEl().down("."+Ext.baseCSSPrefix+"list-plain");if(b.getTotalCount()>b.getCount()){c.appendChild({tag:"li",html:"Keep typing to narrow down",cls:Ext.baseCSSPrefix+"boundlist-item isu-combo-limit-notification"})}}});Ext.define("Isu.view.workspace.issues.FilteringToolbar",{extend:"Uni.view.panel.FilterToolbar",requires:["Uni.view.button.TagButton"],alias:"widget.filtering-toolbar",title:"Filters",name:"filter",emptyText:"None",layout:{type:"hbox",align:"stretch"},addFilterButtons:function(b){var c=this,d="Uni.view.button.TagButton",a=c.getContainer();a.removeAll();if(b.get("assignee")){a.add(Ext.create(d,{itemId:"filter-by-assignee",text:"Assignee: "+b.get("assignee").get("name"),target:"assignee"}))}if(b.get("reason")){a.add(Ext.create(d,{itemId:"filter-by-reason",text:"Reason: "+b.get("reason").get("name"),target:"reason"}))}if(b.get("department")){a.add(Ext.create(d,{itemId:"filter-by-department",text:"Department: "+b.get("department").get("name"),target:"department"}))}if(b.get("meter")){a.add(Ext.create(d,{itemId:"filter-by-meter",text:"Meter: "+b.get("meter").get("name"),target:"meter"}))}if(b.status().count()){b.status().each(function(e){var f=a.add({xtype:"tag-button",itemId:"filter-by-status",text:"Status: "+e.get("name"),target:"status",targetId:e.getId()})})}}});Ext.define("Isu.view.workspace.issues.SortMenu",{extend:"Ext.menu.Menu",alias:"widget.issue-sort-menu",itemId:"SortMenu",shadow:false,border:false,plain:true,items:[{itemId:"sortEl",text:"Due date",action:"dueDate"}]});Ext.define("Isu.view.workspace.issues.SortingToolbar",{extend:"Uni.view.panel.FilterToolbar",requires:["Uni.view.button.SortItemButton","Isu.view.workspace.issues.SortMenu"],alias:"widget.sorting-toolbar",title:"Sort",name:"sortitemspanel",emptyText:"None",tools:[{itemId:"addSort",xtype:"button",action:"addSort",text:"Add sort",menu:{xtype:"issue-sort-menu"}}],addSortButtons:function(f){var c=this,b=c.getContainer(),e=f.getData(),d,a;b.removeAll();Ext.Object.each(e,function(g,h){if(g!="id"&&h){d=c.down("issue-sort-menu [action="+g+"]");a=h==Isu.model.IssueSort.ASC?"x-btn-sort-item-asc":"x-btn-sort-item-desc";b.add({itemId:"sortingBy",xtype:"sort-item-btn",text:d.text,sortName:g,sortDirection:h,iconCls:a})}})}});Ext.define("Isu.store.IssueGrouping",{extend:"Ext.data.Store",model:"Isu.model.IssueGrouping",data:[{value:"none",display:"None"},{value:"reason",display:"Reason"}]});Ext.define("Isu.view.workspace.issues.GroupingToolbar",{extend:"Uni.view.panel.FilterToolbar",requires:["Isu.store.IssueGrouping"],alias:"widget.grouping-toolbar",title:"Group",name:"group",showClearButton:false,content:{itemId:"group_combobox",xtype:"combobox",name:"groupingcombo",store:"Isu.store.IssueGrouping",editable:false,emptyText:"None",queryMode:"local",displayField:"display",valueField:"value",labelAlign:"left"}});Ext.define("Isu.model.IssuesGroups",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"reason",type:"text"},{name:"number",type:"int"}],proxy:{type:"rest",url:"/api/isu/issue/groupedlist",reader:{type:"json",root:"data",totalProperty:"totalCount"}}});Ext.define("Isu.store.IssuesGroups",{extend:"Ext.data.Store",model:"Isu.model.IssuesGroups",pageSize:10,autoLoad:false,listeners:{beforeload:function(){this.getProxy().setExtraParam("issueType","datacollection")}}});Ext.define("Isu.view.workspace.issues.GroupGrid",{extend:"Ext.grid.Panel",requires:["Uni.view.toolbar.PagingTop","Uni.view.toolbar.PagingBottom","Isu.store.IssuesGroups"],alias:"widget.issue-group-grid",store:"Isu.store.IssuesGroups",columns:{defaults:{sortable:false,menuDisabled:true},items:[{itemId:"reason",text:"Reason",dataIndex:"reason",flex:5},{itemId:"issues_num",text:"Issues",dataIndex:"number",flex:1}]},initComponent:function(){var a=this;a.dockedItems=[{xtype:"pagingtoolbartop",dock:"top",store:a.store,displayMsg:Uni.I18n.translate("workspace.issues.groupGrid.pagingtoolbartop.displayMsg","ISE","{0} - {1} of {2} items"),displayMoreMsg:Uni.I18n.translate("workspace.issues.groupGrid.pagingtoolbartop.displayMoreMsg","ISE","{0} - {1} of more than {2} items"),emptyMsg:"0 reasons"},{xtype:"pagingtoolbarbottom",dock:"bottom",store:a.store,itemsPerPageMsg:Uni.I18n.translate("workspace.issues.groupGrid.pagingtoolbartop.itemsPerPageMsg","ISE","Items per page")}];a.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.IssueGroup",{extend:"Ext.panel.Panel",requires:["Isu.view.workspace.issues.GroupGrid"],itemId:"IssueGroup",alias:"widget.issue-group",hidden:true,items:[{itemId:"issue-group-grid",xtype:"issue-group-grid"},{name:"issue-group-info",hidden:true}]});Ext.define("Isu.view.workspace.issues.Filter",{extend:"Ext.panel.Panel",requires:["Ext.menu.Separator","Isu.view.workspace.issues.FilteringToolbar","Isu.view.workspace.issues.SortingToolbar","Isu.view.workspace.issues.GroupingToolbar","Isu.view.workspace.issues.IssueGroup"],alias:"widget.issues-filter",layout:{type:"vbox",align:"stretch"},items:[{xtype:"filtering-toolbar"},{itemId:"menuseparator",xtype:"menuseparator"},{xtype:"grouping-toolbar"},{itemId:"menuseparator",xtype:"menuseparator"},{xtype:"sorting-toolbar"},{xtype:"issue-group"}]});Ext.define("Isu.view.workspace.issues.List",{extend:"Ext.grid.Panel",requires:["Ext.grid.column.Date","Ext.form.field.ComboBox","Ext.grid.column.Template","Uni.grid.column.Action","Uni.view.toolbar.PagingTop","Uni.view.toolbar.PagingBottom"],alias:"widget.issues-list",itemId:"issues-list",store:"Isu.store.Issues",columns:{defaults:{sortable:false,menuDisabled:true},items:[{itemId:"Title",header:Uni.I18n.translate("general.title.title","ISE","Title"),xtype:"templatecolumn",tpl:'<a href="#/workspace/datacollection/issues/{id}">{title}</a>',flex:2},{itemId:"dueDate",header:Uni.I18n.translate("general.title.dueDate","ISE","Due date"),dataIndex:"dueDate",xtype:"datecolumn",format:"M d Y",width:140},{itemId:"status",header:Uni.I18n.translate("general.title.status","ISE","Status"),dataIndex:"status_name",width:100},{itemId:"assignee",header:Uni.I18n.translate("general.title.assignee","ISE","Assignee"),xtype:"templatecolumn",tpl:'<tpl if="assignee_type"><span class="isu-icon-{assignee_type} isu-assignee-type-icon"></span></tpl> {assignee_name}',flex:1},{itemId:"action",xtype:"uni-actioncolumn",items:"Isu.view.workspace.issues.ActionMenu"}]},dockedItems:[{itemId:"pagingtoolbartop",xtype:"pagingtoolbartop",dock:"top",displayMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.displayMsg","ISE","{0} - {1} of {2} issues"),displayMoreMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.displayMoreMsg","ISE","{0} - {1} of more than {2} issues"),emptyMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.emptyMsg","ISE","There are no issues to display"),items:["->",{itemId:"bulkAction",xtype:"button",text:Uni.I18n.translate("general.title.bulkActions","ISE","Bulk action"),action:"bulkchangesissues",hrefTarget:"",href:"#/workspace/datacollection/bulkaction"}]},{itemId:"pagingtoolbarbottom",xtype:"pagingtoolbarbottom",dock:"bottom",itemsPerPageMsg:Uni.I18n.translate("workspace.issues.pagingtoolbarbottom.itemsPerPage","ISE","Issues per page")}],initComponent:function(){var b=this.store,a=Ext.Array.findBy(this.dockedItems,function(d){return d.xtype=="pagingtoolbartop"}),c=Ext.Array.findBy(this.dockedItems,function(d){return d.xtype=="pagingtoolbarbottom"});a&&(a.store=b);c&&(c.store=b);this.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.ActionMenu",{extend:"Ext.menu.Menu",alias:"widget.issue-action-menu",plain:true,items:[{itemId:"assign",text:"Assign",action:"assign"},{itemId:"close",text:"Close",action:"close"},{itemId:"addcomment",text:"Add comment",action:"addcomment"},{itemId:"notify",text:"Notify user",action:"notify"},{itemId:"send",text:"Send to inspect",action:"send"}]});Ext.define("Isu.view.workspace.issues.FormWithFilters",{extend:"Ext.form.Panel",alias:"widget.issue-form-with-filters",layout:"column",itemId:"issue-detailed-form",defaults:{xtype:"container",layout:"form",columnWidth:0.5},ui:"medium",items:[{defaults:{xtype:"displayfield",labelWidth:200},items:[{itemId:"_reason",fieldLabel:Uni.I18n.translate("general.title.reason","ISE","Reason"),name:"reason_name_f"},{itemId:"_customer",fieldLabel:Uni.I18n.translate("general.title.customer","ISE","Customer"),name:"customer"},{itemId:"_location",fieldLabel:Uni.I18n.translate("general.title.location","ISE","Location"),name:"service_location"},{itemId:"_usagepoint",fieldLabel:Uni.I18n.translate("general.title.usagePoint","ISE","Usage point"),name:"usage_point"},{itemId:"_devicename",fieldLabel:Uni.I18n.translate("general.title.device","ISE","Device"),name:"device_f"}]},{defaults:{xtype:"displayfield",labelWidth:200},items:[{itemId:"_status",fieldLabel:Uni.I18n.translate("general.title.status","ISE","Status"),name:"status_name_f"},{itemId:"_dueDate",fieldLabel:Uni.I18n.translate("general.title.dueDate","ISE","Due date"),name:"dueDate",renderer:Ext.util.Format.dateRenderer("M d, Y")},{itemId:"_assignee",fieldLabel:Uni.I18n.translate("general.title.assignee","ISE","Assignee"),name:"assignee_name_f"},{itemId:"_creationDate",fieldLabel:Uni.I18n.translate("general.title.creationDate","ISE","Creation date"),name:"creationDate",renderer:Ext.util.Format.dateRenderer("M d, Y H:i")},{itemId:"_serviceCat",fieldLabel:Uni.I18n.translate("general.title.serviceCategory","ISE","Service category"),name:"service_category"}]}]});Ext.define("Isu.view.workspace.issues.Item",{extend:"Ext.panel.Panel",alias:"widget.issues-item",itemId:"issues-item",requires:["Isu.view.workspace.issues.ActionMenu","Isu.view.workspace.issues.FormWithFilters"],title:"",frame:true,tools:[{xtype:"button",text:Uni.I18n.translate("general.actions","ISE","Actions"),iconCls:"x-uni-action-iconD",menu:{xtype:"issue-action-menu"}}],items:{itemId:"issue-form-with-filters",xtype:"issue-form-with-filters",bbar:{layout:{type:"vbox",align:"right"},items:{text:Uni.I18n.translate("general.title.viewDetails","ISE","View details"),itemId:"viewDetails",ui:"link",action:"view",listeners:{click:function(){window.location.href="#/workspace/datacollection/issues/"+this.up("form").getRecord().get("id")}}}}}});Ext.define("Isu.view.workspace.issues.component.AssigneeCombo",{extend:"Ext.ux.Rixo.form.field.GridPicker",alias:"widget.issues-assignee-combo",store:"Isu.store.Assignee",displayField:"name",valueField:"idx",triggerAction:"query",queryMode:"remote",queryParam:"like",allQuery:"",lastQuery:"",queryDelay:100,minChars:0,disableKeyFilter:true,queryCaching:false,formBind:true,typeAhead:true,anchor:"100%",forceSelection:true,gridConfig:{emptyText:"No assignee found",resizable:false,stripeRows:true,features:[{ftype:"grouping",groupHeaderTpl:"{name}",collapsible:false}],columns:[{header:false,xtype:"templatecolumn",tpl:'<tpl if="type"><span class="isu-icon-{type} isu-assignee-type-icon"></span></tpl> {name}',flex:1}]},listeners:{focus:{fn:function(a){if(!a.getValue()){a.doQuery(a.getValue())}}},change:{fn:function(b,a){if(!a){b.reset()}}},beforequery:{fn:function(b){var a=b.combo.store;if(b.query){a.group("type")}else{a.clearGrouping()}}}}});Ext.define("Isu.util.FilterCheckboxgroup",{extend:"Ext.form.CheckboxGroup",alias:"widget.filter-checkboxgroup",mixins:{bindable:"Ext.util.Bindable"},checkbox:{boxLabel:"name",inputValue:"id"},initComponent:function(){var a=this;a.bindStore(a.store||"ext-empty-store",true);this.callParent(arguments)},beforeRender:function(){this.callParent(arguments);if(!this.store.isLoading()){this.onLoad()}},onLoad:function(){var a=this;a.removeAll();Ext.Array.forEach(a.store.getRange(),function(b){a.add({xtype:"checkboxfield",boxLabel:b.data[a.checkbox.boxLabel],inputValue:b.data[a.checkbox.inputValue],name:a.name})});a.fireEvent("itemsadded",a,a.store)},setValue:function(b){var a={};a[this.name]=b;this.callParent([a])},getStoreListeners:function(){return{load:this.onLoad}}});Ext.define("Isu.store.IssueStatus",{extend:"Ext.data.Store",model:"Isu.model.IssueStatus",autoLoad:true});Ext.define("Isu.store.IssueReason",{extend:"Ext.data.Store",model:"Isu.model.IssueReason",autoLoad:false,listeners:{beforeload:function(){this.getProxy().setExtraParam("issueType","datacollection")}}});Ext.define("Isu.view.workspace.issues.SideFilter",{extend:"Ext.panel.Panel",alias:"widget.issues-side-filter",cls:"filter-form",width:200,title:Uni.I18n.translate("general.title.filter","ISE","Filter"),ui:"filter",requires:["Isu.view.workspace.issues.component.AssigneeCombo","Isu.util.FilterCheckboxgroup","Uni.component.filter.view.Filter","Isu.store.IssueStatus","Isu.store.IssueReason"],items:[{xtype:"filter-form",itemId:"filter-form",items:[{itemId:"filter-by-status",xtype:"filter-checkboxgroup",store:"Isu.store.IssueStatus",name:"status",fieldLabel:Uni.I18n.translate("general.title.status","ISE","Status"),labelAlign:"top",columns:1,vertical:true},{itemId:"filter-by-assignee",xtype:"issues-assignee-combo",name:"assignee",fieldLabel:Uni.I18n.translate("general.title.assignee","ISE","Assignee"),labelAlign:"top",forceSelection:true,anyMatch:true,emptyText:"select an assignee",tooltipText:"Start typing for assignee"},{itemId:"filter-by-reason",xtype:"combobox",name:"reason",fieldLabel:Uni.I18n.translate("general.title.reason","ISE","Reason"),labelAlign:"top",displayField:"name",valueField:"id",forceSelection:true,store:"Isu.store.IssueReason",listConfig:{cls:"isu-combo-color-list",emptyText:"No reason found"},queryMode:"remote",queryParam:"like",queryDelay:100,queryCaching:false,minChars:1,triggerAction:"query",anchor:"100%",emptyText:"select a reason",tooltipText:"Start typing for reason"},{itemId:"filter-by-meter",xtype:"combobox",name:"meter",fieldLabel:Uni.I18n.translate("general.title.meter","ISE","Meter"),labelAlign:"top",displayField:"name",valueField:"id",forceSelection:true,store:"Isu.store.IssueMeter",listConfig:{cls:"isu-combo-color-list",emptyText:"No meter found"},queryMode:"remote",queryParam:"like",queryDelay:100,queryCaching:false,minChars:1,triggerAction:"query",anchor:"100%",emptyText:"select a MRID of the meter",tooltipText:"Start typing for a MRID"}]}],dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{itemId:"fApply",ui:"action",text:"Apply",action:"filter"},{itemId:"fReset",text:"Clear all",action:"reset"}]}]});Ext.define("Isu.view.workspace.issues.Overview",{extend:"Uni.view.container.ContentContainer",alias:"widget.issues-overview",itemId:"issuesOverview",requires:["Uni.view.navigation.SubMenu","Isu.view.workspace.issues.Filter","Isu.view.workspace.issues.List","Isu.view.workspace.issues.Item","Isu.view.workspace.issues.SideFilter","Uni.view.container.PreviewContainer","Uni.view.notifications.NoItemsFoundPanel"],side:{itemId:"navigation",xtype:"panel",ui:"medium",title:"Navigation",layout:{type:"vbox",align:"stretch"},items:[{itemId:"overview",xtype:"menu",title:"Overview",ui:"side-menu",layout:{type:"vbox",align:"stretch"},floating:false,plain:true,items:[{text:"Issues",cls:"current"}]},{itemId:"issues-side-filter",xtype:"issues-side-filter"}]},content:[{xtype:"panel",ui:"large",title:Uni.I18n.translate("workspace.issues.title","ISE","Issues"),items:[{itemId:"issues-filter",xtype:"issues-filter"},{xtype:"preview-container",grid:{xtype:"issues-list"},emptyComponent:{xtype:"no-items-found-panel",title:Uni.I18n.translate("workspace.issues.empty.title","ISE","No issues found"),reasons:[Uni.I18n.translate("workspace.issues.empty.list.item1","ISE","No issues have been defined yet."),Uni.I18n.translate("workspace.issues.empty.list.item2","ISE","No issues comply to the filter.")]},previewComponent:{xtype:"issues-item"}}]}]});Ext.define("Isu.view.workspace.issues.IssueNoGroup",{extend:"Ext.panel.Panel",alias:"widget.issue-no-group",itemId:"IssueNoGroup",hidden:true,items:[{itemId:"NoGroup_text",html:"<h3>No group selected</h3><p>Select a group of issues.</p>",bodyPadding:10,border:false}]});Ext.define("Isu.view.ext.button.GridAction",{extend:"Ext.button.Button",alias:"widget.grid-action",cls:"isu-grid-action-btn",menuAlign:"tl-bl"});Ext.define("Isu.model.Device",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"name",type:"string"}]});Ext.define("Isu.model.Issues",{extend:"Ext.data.Model",requires:["Isu.model.IssueReason","Isu.model.IssueStatus","Isu.model.Device","Isu.model.Assignee"],fields:[{name:"id",displayValue:"ID",type:"int"},{name:"dueDate",displayValue:"Due date",dateFormat:"time",type:"date"},{name:"customer",displayValue:"Customer",type:"auto"},{name:"creationDate",displayValue:"Creation date",dateFormat:"time",type:"date"},{name:"version",displayValue:"Version",type:"auto"},{name:"device",type:"auto"},{name:"reason",type:"auto"},{name:"status",type:"auto"},{name:"assignee",type:"auto"},{name:"title",mapping:function(a){return a.reason.name+(a.device?" to "+a.device.name+" "+a.device.serialNumber:"")}},{name:"reason_name",mapping:"reason.name"},{name:"status_name",mapping:"status.name"},{name:"device_name",mapping:"device.name"},{name:"assignee_name",mapping:"assignee.name"},{name:"assignee_type",mapping:"assignee.type"},{name:"usage_point",mapping:"device.usagePoint.info"},{name:"service_location",mapping:"device.serviceLocation.info"},{name:"service_category",mapping:"device.serviceCategory.info"},{name:"status_name_f",mapping:function(b){var a;if(b.status){a='<span class="isu-icon-filter isu-apply-filter" data-filterType="status" data-filterValue="'+b.status.id+'"></span>';return b.status.name+" "+a}else{return""}}},{name:"reason_name_f",mapping:function(b){var a;if(b.reason){a='<span class="isu-icon-filter isu-apply-filter" data-filterType="reason" data-filterValue="'+b.reason.id+'" data-filterSearch="'+b.reason.name+'"></span>';return b.reason.name+" "+a}else{return""}}},{name:"device_f",mapping:function(b){var a;if(b.device){a='<span class="isu-icon-filter isu-apply-filter" data-filterType="meter" data-filterValue="'+b.device.id+'" data-filterSearch="'+b.device.serialNumber+'"></span>';return'<a href="#/devices/'+b.device.serialNumber+'">'+b.device.name+" "+b.device.serialNumber+"</a>"+a}else{return""}}},{name:"assignee_name_f",mapping:function(b){var a;if(b.assignee){a='<span class="isu-icon-filter isu-apply-filter" data-filterType="assignee" data-filterValue="'+b.assignee.id+":"+b.assignee.type+'" data-filterSearch="'+b.assignee.name+'"></span>';return b.assignee.name+a}else{return""}}},{name:"devicelink",mapping:function(a){if(a.device){return'<a href="#/devices/'+a.device.serialNumber+'">'+a.device.name+" "+a.device.serialNumber+"</a>"}else{return""}}}],associations:[{type:"hasOne",model:"Isu.model.IssueReason",associationKey:"reason",name:"reason"},{type:"hasOne",model:"Isu.model.IssueStatus",associationKey:"status",name:"status"},{type:"hasOne",model:"Isu.model.Device",associationKey:"device",name:"device"},{type:"hasOne",model:"Isu.model.Assignee",associationKey:"assignee",name:"assignee"},{type:"hasMany",model:"Isu.model.IssueComments",associationKey:"comments",name:"comments"}],proxy:{type:"rest",url:"/api/isu/issue",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.Issues",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest","Uni.component.filter.store.Filterable","Uni.component.sort.store.Sortable","Isu.model.IssueFilter","Uni.util.Hydrator"],mixins:["Uni.component.filter.store.Filterable","Uni.component.sort.store.Sortable"],model:"Isu.model.Issues",pageSize:10,autoLoad:false});Ext.define("Isu.store.Assignee",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],model:"Isu.model.Assignee",pageSize:100,groupField:"type",autoLoad:false,sorters:[{sorterFn:function(b,a){return b.get("name").toUpperCase()>a.get("name").toUpperCase()}}]});Ext.define("Isu.store.IssueMeter",{extend:"Ext.data.Store",model:"Isu.model.IssueMeter",pageSize:50,autoLoad:false});Ext.define("Isu.model.UserGroupList",{extend:"Ext.data.Model",fields:[{name:"id",type:"auto"},{name:"name",type:"auto"},{name:"version",type:"auto"}]});Ext.define("Isu.store.UserGroupList",{extend:"Ext.data.Store",model:"Isu.model.UserGroupList",autoLoad:true,proxy:{type:"rest",url:"/api/isu/assignees/groups",reader:{type:"json",root:"data"}}});Ext.define("Isu.controller.Issues",{extend:"Ext.app.Controller",requires:["Isu.model.ExtraParams"],stores:["Isu.store.Issues","Isu.store.IssuesGroups","Isu.store.Assignee","Isu.store.IssueStatus","Isu.store.IssueReason","Isu.store.IssueMeter","Isu.store.UserGroupList","Isu.store.IssueGrouping"],views:["workspace.issues.Overview","workspace.issues.Filter","workspace.issues.List","workspace.issues.Item","workspace.issues.IssueNoGroup","ext.button.GridAction","Uni.view.button.SortItemButton","Uni.view.button.TagButton"],mixins:["Isu.util.IsuGrid","Isu.util.IsuComboTooltip"],refs:[{ref:"issuesOverview",selector:"issues-overview"},{ref:"itemPanel",selector:"issues-item"},{ref:"issuesList",selector:"issues-list"},{ref:"noIssues",selector:"issues-overview [name=noIssues]"},{ref:"filteringToolbar",selector:"issues-overview filtering-toolbar"},{ref:"sortingToolbar",selector:"issues-overview sorting-toolbar"},{ref:"groupingToolbar",selector:"issues-overview grouping-toolbar"},{ref:"groupPanel",selector:"issues-overview issue-group"},{ref:"issueFilter",selector:"issues-side-filter"}],assignToMe:false,init:function(){this.control({"issues-overview":{afterrender:this.checkAssignee},"issues-overview issues-list":{select:this.loadGridItemDetail},"issues-overview issues-list gridview":{refresh:this.setAssigneeTypeIconTooltip},"issues-list uni-actioncolumn":{menuclick:this.chooseIssuesAction},"issue-action-menu":{click:this.chooseIssuesAction},"issues-overview issues-item":{afterChange:this.setFilterIconsActions},"issues-overview sorting-toolbar container sort-item-btn":{click:this.changeSortDirection,closeclick:this.removeSortItem},"issues-overview sorting-toolbar issue-sort-menu":{click:this.addSortParam},"issues-overview sorting-toolbar button[action=clear]":{click:this.clearSortParams},"issues-overview grouping-toolbar [name=groupingcombo]":{change:this.changeGrouping},"issues-overview filtering-toolbar tag-button":{closeclick:this.removeFilterItem},'issues-side-filter button[action="reset"]':{click:this.resetFilter},'issues-overview filtering-toolbar button[action="clear"]':{click:this.resetFilter},'issues-side-filter button[action="filter"]':{click:this.applyFilter},"issues-side-filter filter-form combobox[name=reason]":{render:this.setComboTooltip},"issues-side-filter filter-form combobox[name=meter]":{render:this.setComboTooltip,expand:this.limitNotification}});this.on("showIssuesAssignedOnMe",function(){this.assignToMe=true},this);this.gridItemModel=this.getModel("Isu.model.Issues")},checkAssignee:function(){if(this.assignToMe){this.assignedToMe()}},showOverview:function(){var a=this,e=this.getStore("Isu.store.Issues"),d=this.getStore("Isu.store.IssuesGroups"),c,b;a.extraParamsModel=new Isu.model.ExtraParams();a.extraParamsModel.setValuesFromQueryString(function(g,f){e.proxy.extraParams=f||{};a.setParamsForIssueGroups(g.get("filter"),g.get("group").get("value"));a.getApplication().fireEvent("changecontentevent",Ext.widget("issues-overview"));a.getFilteringToolbar().addFilterButtons(g.get("filter"));a.getSortingToolbar().addSortButtons(g.get("sort"));a.setFilterForm();d.on("load",function(){a.setGrouping()},a,{single:true})})},setFilterForm:function(){var a=this,c=this.extraParamsModel.get("filter"),b=a.getIssueFilter().down("filter-form"),d=b.down("filter-checkboxgroup");if(c.get("assignee")){b.down("combobox[name=assignee]").getStore().add(c.get("assignee"))}if(c.get("reason")){b.down("combobox[name=reason]").getStore().add(c.get("reason"))}if(c.get("meter")){b.down("combobox[name=meter]").getStore().add(c.get("meter"))}if(!d.store.getCount()){d.store.load(function(){b.loadRecord(c)})}else{b.loadRecord(c)}},removeFilterItem:function(a){this.extraParamsModel.get("filter").removeFilterParam(a.target,a.targetId);this.refresh()},applyFilter:function(){var b=this.getIssueFilter().down("filter-form"),a=b.getRecord();b.updateRecord(a);this.extraParamsModel.set("filter",a);this.refresh()},resetFilter:function(){var a=new Isu.model.IssueFilter();this.extraParamsModel.set("filter",a);this.refresh()},addSortParam:function(c,a){var b=this.extraParamsModel.get("sort");if(!b.data[a.action]){b.addSortParam(a.action);this.refresh()}},changeSortDirection:function(a){var b=this.extraParamsModel.get("sort");b.toggleSortParam(a.sortName);this.refresh()},removeSortItem:function(a){var b=this.extraParamsModel.get("sort");b.removeSortParam(a.sortName);this.refresh()},clearSortParams:function(){var a=this.extraParamsModel.get("sort");a.data={};this.refresh()},refresh:function(){window.location.replace(this.extraParamsModel.getQueryStringFromValues())},setGrouping:function(){var e=this.extraParamsModel.get("group").get("value"),d=this.getStore("Isu.store.IssuesGroups"),g=this.getGroupingToolbar().down("[name=groupingcombo]"),b=this.getGroupPanel(),c=b.down("issue-group-grid"),h=b.down("[name=issue-group-info]"),a=c.getSelectionModel(),f;g.setValue(e);if(e=="none"||!d.getCount()){b.hide()}else{if(this.extraParamsModel.get("filter").get(e)){f=d.getById(this.extraParamsModel.get("filter").get(e).getId())}else{f=d.getById(this.extraParamsModel.get("groupValue"));if(!f&&this.extraParamsModel.get("group")!="none"){f=d.getAt(0)}}c.on("itemclick",this.changeGroup,this);if(f){a.select(f);h.update("<h3>Issues for reason: "+f.get("reason")+"</h3>");h.show();c.fireEvent("itemclick",c,f)}else{this.getIssuesList().hide();this.getItemPanel().hide()}b.show()}},changeGroup:function(b,a){this.extraParamsModel.set("groupValue",a.getId());this.refresh()},changeGrouping:function(d,c){var b=d.getStore(),a=this.extraParamsModel.get("group");if(c!=="reason"){this.extraParamsModel.set("groupValue",null)}if(a!=b.getById(c)){this.extraParamsModel.set("group",b.getById(c));this.refresh()}},setParamsForIssueGroups:function(d,h){var b=this.getStore("Isu.store.IssuesGroups"),i=b.getProxy(),e=d.statusStore,a=[],f=d.get("reason"),g=d.get("assignee"),c=d.get("meter");if(h!="none"){i.setExtraParam("field",h)}else{i.setExtraParam("field","reason")}if(e){e.each(function(j){a.push(j.get("id"))});i.setExtraParam("status",a)}else{i.setExtraParam("status",[])}if(g){i.setExtraParam("assigneeId",g.get("id"));i.setExtraParam("assigneeType",g.get("type"))}else{i.setExtraParam("assigneeId",[]);i.setExtraParam("assigneeType",[])}if(f){i.setExtraParam("id",f.get("id"))}else{i.setExtraParam("id",[])}if(c){i.setExtraParam("meter",c.get("id"))}else{i.setExtraParam("meter",[])}},chooseIssuesAction:function(d,a){var b=a.action,c=d.record.getId();switch(b){case"assign":window.location.href="#/workspace/datacollection/issues/"+c+"/assign";break;case"close":window.location.href="#/workspace/datacollection/issues/"+c+"/close";break;case"addcomment":window.location.href="#/workspace/datacollection/issues/"+c+"/addcomment";break;case"notify":window.location.href="#/workspace/datacollection/issues/"+c+"/notify";break;case"send":window.location.href="#/workspace/datacollection/issues/"+c+"/send";break}},setGroupFields:function(a){var b=Ext.ModelManager.getModel("Isu.model.Issues"),c=b.getFields()[1];a.store=Ext.create("Ext.data.Store",{fields:["value","display"],data:[{value:0,display:"None"},{value:"reason",display:c.displayValue}]})},setFilterIconsActions:function(b){var a=this,c=Ext.get(b.getEl()).select(".isu-apply-filter");c.on("click",a.addFilterIconAction,a);b.on("destroy",function(){c.un("click",a.addFilterIconAction,a)})},addFilterIconAction:function(c,a){var b=a.getAttribute("data-filterType"),e=a.getAttribute("data-filterValue"),d=a.getAttribute("data-filterSearch");if(!b||!e){return}switch(b){case"status":this.setChecboxFilter(b,e);break;case"assignee":this.setComboFilter(b,e,d);break;case"reason":this.setComboFilter(b,parseInt(e),d);break;case"meter":this.setComboFilter(b,parseInt(e),d);break}},setChecboxFilter:function(b,f){var a=this,d=this.getIssueFilter().down("filter-form"),e=d.query("checkboxfield"),c=d.down("[name="+b+"] checkboxfield[inputValue="+f+"]");Ext.Array.each(e,function(g){g.setValue(false)});c.setValue(true);a.applyFilter()},setComboFilter:function(b,h,g){var a=this,d=this.getIssueFilter().down("filter-form"),f=d.down("[name="+b+"]"),c=f.getStore(),e=c.getProxy();e.setExtraParam(f.queryParam,g);c.load(function(){f.setValue(h);a.applyFilter()})},assignedToMe:function(){var c=this,b=c.getIssueFilter().down("combobox[name=assignee]"),d=b.getStore(),a;d.load({params:{me:true},callback:function(){a=d.getAt(0);b.setValue(a.get("idx"));c.applyFilter();c.assignToMe=false}})}});Ext.define("Isu.util.FormErrorMessage",{extend:"Ext.panel.Panel",alias:"widget.uni-form-error-message",ui:"form-error-framed",text:null,defaultText:"There are errors on this page that require your attention.",layout:{type:"hbox",align:"middle"},errorIcon:null,defaultErrorIcon:"x-uni-form-error-msg-icon",margin:"7 0 32 0",beforeRender:function(){var a=this;if(!a.text){a.text=a.defaultText}if(!a.errorIcon){a.errorIcon=a.defaultErrorIcon}a.renew();a.callParent(arguments)},renew:function(){var a=this;a.removeAll(true);a.add([{xtype:"box",height:22,width:26,cls:a.errorIcon},{ui:"form-error",name:"errormsgpanel",html:a.text}])},setText:function(b){var a=this;a.text=b;a.renew()}});Ext.define("Isu.view.workspace.issues.AssignForm",{extend:"Ext.form.Panel",defaults:{border:false},requires:["Ext.form.Panel","Ext.form.RadioGroup"],ui:"medium",title:"Assign issue",alias:"widget.issues-assign-form",items:[{xtype:"panel",margin:"0 0 20 0",layout:{type:"vbox",align:"left"},items:{itemId:"form-errors",xtype:"uni-form-error-message",name:"form-errors",hidden:true}},{margin:"0 0 0 100",defaults:{border:false},items:[{layout:"hbox",defaults:{border:false},items:[{width:80,items:{itemId:"AssignTo",xtype:"label",text:"Assign to *"}},{itemId:"radiogroup",xtype:"radiogroup",formBind:false,columns:1,vertical:true,width:100,defaults:{name:"assignTo",formBind:false,submitValue:false},listeners:{change:{fn:function(d,c,a){var b=d.up("issues-assign-form");b.assignToOnChange(d,c,a)}},afterrender:{fn:function(a){a.reset()}}},items:[{itemId:"USER",boxLabel:"User",inputValue:"USER"},{itemId:"ROLE",boxLabel:"User role",margin:"5 0 0 0",inputValue:"ROLE"},{itemId:"GROUP",boxLabel:"User group",margin:"5 0 0 0",inputValue:"GROUP"}]},{defaults:{xtype:"combobox",queryMode:"local",valueField:"id",forceSelection:true,anyMatch:true,msgTarget:"under",validateOnChange:false,validateOnBlur:false,width:300,listeners:{errorchange:{fn:function(c,a){var b=c.up("issues-assign-form");b.comboOnError(c,a)}},focus:{fn:function(b){var c=b.up().previousNode("radiogroup").down("[inputValue="+b.name+"]");c.setValue(true);var a=Ext.ComponentQuery.query("issues-assign-form combobox");Ext.Array.each(a,function(d){d.allowBlank=true});b.allowBlank=false}}}},items:[{itemId:"Ucombo",name:"USER",store:"Isu.store.UserList",allowBlank:false,displayField:"authenticationName"},{itemId:"Rcombo",name:"ROLE",store:"Isu.store.UserRoleList",displayField:"name"},{itemId:"Gcombo",name:"GROUP",store:"Isu.store.UserGroupList",displayField:"name"}]}]},{layout:"hbox",margin:"20 0 0 0",defaults:{border:false},items:[{width:80,items:{itemId:"Comment",xtype:"label",text:"Comment"}},{itemId:"commentarea",xtype:"textareafield",name:"comment",emptyText:"Provide a comment \r\n(optionally)",width:397}]}]}],listeners:{fielderrorchange:{fn:function(c,a,b){c.onFieldErrorChange(c,a,b)}},afterrender:function(d){var b=Ext.state.Manager.get("formAssignValues");Ext.ComponentQuery.query("issues-assign-form radiogroup")[0].down("[inputValue=USER]").setValue(true);if(b){Ext.Object.each(b,function(e,f){if(e=="comment"){d.down("textareafield").setValue(f)}if(e=="GROUP"){d.down("combobox[name=GROUP]").setValue(f)}if(e=="ROLE"){d.down("combobox[name=ROLE]").setValue(f)}if(e=="USER"){d.down("combobox[name=USER]").setValue(f)}})}var a=Ext.state.Manager.get("formAssignRadio");if(a){var c=d.down("radiogroup").down("[inputValue="+a+"]");c.setValue(true)}}},assignToOnChange:function(g,f,d){var c=g.next().down("[name="+f.assignTo+"]"),b=g.next().down("[name="+d.assignTo+"]"),a=g.down("[checked=true]").boxLabel,e=Ext.ComponentQuery.query("tooltip[anchor=top]");Ext.each(e,function(h){h.destroy()});Ext.create("Ext.tip.ToolTip",{target:c.getEl(),html:"Start typing for "+a.toLowerCase()+"s",anchor:"top"});if(!Ext.isEmpty(b)){b.allowBlank=true}c.setDisabled(false);c.allowBlank=false;c.focus()},comboOnError:function(e,a){var f=e.up().previousNode("radiogroup").down("[inputValue="+e.name+"]"),d=f.margin?f.margin.split(" "):[0,0,0,0],b=24,c;d[2]=a?parseInt(d[2])+b:parseInt(d[2])-b;c=d.join(" ");f.setMargin(c);f.margin=c},onFieldErrorChange:function(c,a,b){var d;if(c.xtype=="issues-assign-form"){d=c.down("[name=form-errors]");if(b){d.hide();d.removeAll();d.add({html:"There are errors on this page that require your attention.",itemId:"error"});d.show()}}},loadRecord:function(a){var b='Assign issue "'+a.get("title")+'"';this.setTitle(b);this.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.Assign",{extend:"Uni.view.container.ContentContainer",requires:["Ext.form.Panel","Ext.form.RadioGroup","Ext.form.field.Hidden","Isu.view.workspace.issues.AssignForm"],alias:"widget.issues-assign",content:{items:{xtype:"issues-assign-form"},buttons:[{itemId:"Assign",text:"Assign",name:"assign",formBind:false},{itemId:"Cancel",text:"Cancel",name:"cancel",ui:"link",hrefTarget:"",href:"#/workspace/datacollection/issues"}]}});Ext.define("Isu.model.UserList",{extend:"Ext.data.Model",fields:[{name:"id",type:"auto"},{name:"authenticationName",type:"auto"},{name:"description",type:"auto"},{name:"version",type:"auto"},{name:"groups",type:"auto"}]});Ext.define("Isu.store.UserList",{extend:"Ext.data.Store",model:"Isu.model.UserList",autoLoad:true,proxy:{type:"rest",url:"/api/usr/users",reader:{type:"json",root:"users"}}});Ext.define("Isu.model.UserRoleList",{extend:"Ext.data.Model",fields:[{name:"id",type:"auto"},{name:"name",type:"auto"},{name:"version",type:"auto"}]});Ext.define("Isu.store.UserRoleList",{extend:"Ext.data.Store",model:"Isu.model.UserRoleList",autoLoad:true,proxy:{type:"rest",url:"/api/isu/assignees/roles",reader:{type:"json",root:"data"}}});Ext.define("Isu.controller.AssignIssues",{extend:"Ext.app.Controller",requires:[],stores:["Isu.store.UserList","Isu.store.UserRoleList","Isu.store.UserGroupList"],views:["workspace.issues.Assign"],refs:[{ref:"itemPanel",selector:"issues-item"}],init:function(){this.control({"issues-assign button[name=assign]":{click:this.onSubmitForm}});this.getApplication().on("assignissue",this.onSubmitForm)},showOverview:function(d){var a=this,b=a.getModel("Issues"),c;b.load(d,{success:function(e){c=Ext.widget("issues-assign");c.getCenterContainer().down("issues-assign-form").loadRecord(e);a.getApplication().fireEvent("changecontentevent",c)}})},onSubmitForm:function(){var j=this,c=Ext.ComponentQuery.query("issues-assign")[0],d=c.down("issues-assign-form"),h=d.down("combobox[allowBlank=false]"),b=d.getForm(),e=d.getRecord(),f=b.getValues(),a="/api/isu/issue/assign",i={},g;if(b.isValid()){i.issues=[{id:e.getId(),version:e.get("version")}];i.assignee={id:h.findRecordByValue(h.getValue()).data.id,type:h.name,title:h.rawValue};i.comment=f.comment;g=Ext.create("Ext.LoadMask",{msg:"Assigning issue",name:"assign-issu-form-submit",target:c});g.show();Ext.Ajax.request({url:a,method:"PUT",jsonData:i,autoAbort:true,success:function(p){var k=Ext.JSON.decode(p.responseText),l=k.data.success,o=k.data.failure,n=c.down("issues-assign-form combobox[allowBlank=false]"),m=[];if(o.length>0){Ext.Array.each(o,function(q){Ext.Array.each(q.issues,function(r){var t={},s={};t.text="Failed to assign issue "+e.data.reason_name+(e.data.device_name?" to "+e.data.device_name+" "+e.raw.device.serialNumber:"")+" to "+n.rawValue;t.style="msgHeaderStyle";m.push(t);s.text=q.reason;s.style="msgItemStyle";m.push(s)})});if(m.length>0){j.getApplication().fireEvent("isushowmsg",{type:"error",closeBtn:true,msgBody:m,y:10,btns:[{text:"Retry",hnd:function(){c.enable();j.getApplication().fireEvent("assignissue")}},{text:"Cancel",cls:"isu-btn-link",hrefTarget:"",href:"#/workspace/datacollection/issues",hnd:function(){}}],listeners:{close:{fn:function(){c.enable()}}}});c.disable()}}m=[];if(l.length>0){Ext.Array.each(l,function(){j.getApplication().fireEvent("acknowledge","Issue assigned to "+n.rawValue)});window.location.href="#/workspace/datacollection/issues"}},callback:function(){g.destroy()}})}}});Ext.define("Isu.view.workspace.issues.CloseForm",{extend:"Ext.form.Panel",requires:["Ext.form.Panel","Ext.form.RadioGroup","Ext.form.field.TextArea"],alias:"widget.issues-close-form",defaults:{},items:[{xype:"container",border:0,items:[{itemId:"radiogroup",xtype:"radiogroup",fieldLabel:"Reason *",name:"status",columns:1,vertical:true,submitValue:false,items:[]},{itemId:"Comment",xtype:"textarea",fieldLabel:"Comment",name:"comment",width:500,height:150,emptyText:"Provide a comment (optionally)"}]}]});Ext.define("Isu.view.workspace.issues.Close",{extend:"Uni.view.container.ContentContainer",alias:"widget.issues-close",requires:["Isu.view.workspace.issues.CloseForm"],initComponent:function(){var a=this;a.callParent(arguments);a.addForm()},addForm:function(){var a=this;a.title='Close issue "'+a.record.data.reason_name+" to "+a.record.data.device_name+'"';a.getCenterContainer().add({flex:1,minHeight:305,border:false,header:false,recordTitle:a.title,bodyPadding:10,defaults:{border:false},items:[{xtype:"panel",ui:"medium",title:a.title},{itemId:"close-form",xtype:"issues-close-form",padding:"30 50 0 50",margin:"0",defaults:{padding:"0 0 30 0"}},{xtype:"container",padding:"0 155",defaults:{xtype:"button",margin:"0 10 0 0"},items:[{itemId:"Close",name:"close",text:"Close",formBind:true},{itemId:"Cancel",text:"Cancel",name:"cancel",ui:"link",hrefTarget:"",href:"#/workspace/datacollection/issues"}]}]})}});Ext.define("Isu.controller.CloseIssues",{extend:"Ext.app.Controller",requires:[],views:["workspace.issues.Close"],init:function(){this.control({"issues-close issues-close-form":{beforerender:this.issueClosingFormBeforeRenderEvent},"bulk-browse bulk-wizard bulk-step3 issues-close-form":{beforerender:this.issueClosingFormBeforeRenderEvent},"issues-close button[name=close]":{click:this.submitIssueClosing},"message-window":{remove:this.enableButtons}});this.getApplication().on("closeissue",this.submitIssueClosing)},showOverview:function(d){var a=this,b=a.getModel("Issues"),c;b.load(d,{success:function(e){c=Ext.widget("issues-close",{record:e});a.getApplication().fireEvent("changecontentevent",c)}})},enableButtons:function(){var a=Ext.ComponentQuery.query("issues-close button");Ext.each(a,function(b){b.enable()})},issueClosingFormBeforeRenderEvent:function(c){var b=c.down("[name=status]"),a=Ext.state.Manager.get("formCloseValues");Ext.Ajax.request({url:"/api/isu/statuses",method:"GET",success:function(d){var e=Ext.decode(d.responseText).data;Ext.each(e,function(f){if(!Ext.isEmpty(f.allowForClosing)&&f.allowForClosing){b.add({boxLabel:f.name,inputValue:f.id,name:"status"})}});if(Ext.isEmpty(a)){b.items.items[0].setValue(true)}else{b.down("[inputValue="+a.status+"]").setValue(true)}}});if(a){c.down("textarea").setValue(a.comment)}},submitIssueClosing:function(){var i=this,c=Ext.ComponentQuery.query("issues-close")[0],e=c.record,d=c.down("issues-close-form"),b=d.getForm(),f=b.getValues(),a="/api/isu/issue/close",h={},g;if(b.isValid()){h.issues=[{id:e.data.id,version:e.data.version}];h.status=f.status;h.comment=f.comment.trim();g=Ext.create("Ext.LoadMask",{msg:"Closing issue",name:"close-issue-form-submit",target:c});g.show();Ext.Ajax.request({url:a,method:"PUT",jsonData:h,success:function(k){var j=Ext.decode(k.responseText).data;var o={style:"msgHeaderStyle"};if(Ext.isEmpty(j.failure)){window.location.href="#/workspace/datacollection/issues";i.getApplication().fireEvent("acknowledge","Issue closed")}else{var n=[],m={},l=Ext.ComponentQuery.query("issues-close button");Ext.each(l,function(p){p.disable()});o.text="Failed to close issue "+d.recordTitle;n.push(o);m.text=j.failure[0].reason;m.style="msgItemStyle";n.push(m);i.getApplication().fireEvent("isushowmsg",{type:"error",msgBody:n,y:10,closeBtn:true,btns:[{text:"Retry",hnd:function(){d.enable();i.getApplication().fireEvent("closeissue")}},{text:"Cancel",cls:"isu-btn-link",hrefTarget:"",href:"#/workspace/datacollection/issues",hnd:function(){}}],listeners:{close:{fn:function(){d.enable()}}}});d.disable()}},failure:function(k){var j;if(k!=null){j=Ext.decode(k.responseText,true)}if(j!==null){Ext.widget("messagebox",{buttons:[{text:"Close",action:"cancel",handler:function(l){l.up("messagebox").hide()}}]}).show({ui:"notification-error",title:j.error,msg:j.message,icon:Ext.MessageBox.ERROR})}else{Ext.widget("messagebox",{buttons:[{text:"Close",action:"cancel",handler:function(l){l.up("messagebox").hide()}}]}).show({ui:"notification-error",title:"Failed to close issue: "+e.data.title,msg:"Issue already closed",icon:Ext.MessageBox.ERROR})}},callback:function(){g.destroy()}})}}});Ext.define("Isu.view.workspace.issues.bulk.Wizard",{extend:"Ext.form.Panel",alias:"widget.wizard",cls:"wizard",autoHeight:true,border:false,layout:"card",activeItemId:0,inWizard:false,includeSubTitle:false,buttonAlign:"left",bodyCls:"isu-bulk-wizard-no-border",requires:["Ext.layout.container.Card"],listeners:{render:function(){if(this.includeSubTitle){this.setTitle("<b>"+this.titlePrefix+" &#62;</b> Step 1 of "+this.items.length+": "+this.getActiveItem().title)}else{this.setTitle("<b>"+this.titlePrefix+" &#62;</b> Step 1 of "+this.items.length)}this.inWizard=true;this.setButtonsState(this);this.fireEvent("wizardstarted",this)},beforerender:function(){Ext.each(this.getLayout().getLayoutItems(),function(a){a.preventHeader=true})},wizardpagechange:function(a){this.onWizardPageChangeEvent(a)}},onWizardPageChangeEvent:function(a){if(this.includeSubTitle){a.getActiveItem().preventHeader=true;a.setTitle("<b>"+a.titlePrefix+" &#62;</b> Step "+(a.activeItemId+1)+" of "+this.items.length+": "+this.getActiveItem().title)}else{a.setTitle("<b>"+a.titlePrefix+" &#62;</b> Step "+(a.activeItemId+1)+" of "+this.items.length)}this.setButtonsState(a)},setButtonsState:function(b){var a=b.down('toolbar[name="wizar-toolbar"]');var c=b.getActiveItem();a.child("#prev").setDisabled(c.buttonsConfig.prevbuttonDisabled);a.child("#next").setDisabled(c.buttonsConfig.nextbuttonDisabled);a.child("#cancel").setDisabled(c.buttonsConfig.cancelbuttonDisabled);a.child("#finish").setDisabled(c.buttonsConfig.confirmbuttonDisabled);a.child("#prev").setVisible(c.buttonsConfig.prevbuttonVisible);a.child("#next").setVisible(c.buttonsConfig.nextbuttonVisible);a.child("#cancel").setVisible(c.buttonsConfig.cancelbuttonVisible);a.child("#finish").setVisible(c.buttonsConfig.confirmbuttonVisible)},onPrevButtonClick:function(e){var f=e.up("wizard");if(!f.getForm().isValid()){var a=f.down("issues-assign-form").getForm().getFields();a.each(function(h){h.disable()})}else{if(f.down("issues-assign-form")){var g=f.getForm().getValues(),d=f.down("issues-assign-form").down("radiogroup").items.items[0].getGroupValue();Ext.state.Manager.set("formAssignRadio",d);Ext.state.Manager.set("formAssignValues",g)}else{if(f.down("issues-close-form")){var b=f.getForm().getValues(),c=f.down("issues-close-form").down("radiogroup").items.items[0].getGroupValue();Ext.state.Manager.set("formCloseRadio",c);Ext.state.Manager.set("formCloseValues",b)}}}f.getLayout().setActiveItem(--f.activeItemId);f.fireEvent("wizardpagechange",f);f.fireEvent("wizardprev",f)},onNextButtonClick:function(a){var b=a.up("wizard");b.getLayout().setActiveItem(++b.activeItemId);b.fireEvent("wizardpagechange",b);b.fireEvent("wizardnext",b)},onConfirmButtonClick:function(a){var c=a.up("wizard");if(!c.getForm().isValid()){var b="Please correct the following errors before resumitting<br>";c.getForm().getFields().each(function(d){if(!d.isValid()){b+="<br><b>"+d.getFieldLabel()+"</b>";b+="<br>"+d.getErrors(d.getValue());b+="<br>"}});Ext.Msg.show({scope:this,title:"Wizard Invalid",msg:b,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}else{c.inWizard=false;c.fireEvent("wizardfinished",c)}},onCancelButtonClick:function(a){var b=a.up("wizard");if(b.getForm().isDirty()){Ext.Msg.show({scope:this,title:"Cancelling Wizard",msg:"All changes will be lost. Are you sure you want to cancel?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(d,e,c){switch(d){case"yes":b.fireEvent("wizardcancelled",b);break;case"no":break}}})}else{b.fireEvent("wizardcancelled",b)}},getActiveItem:function(){return this.items.items[this.activeItemId]},getActiveItemId:function(){return this.activeItemId},initComponent:function(){Ext.apply(this,{dockedItems:[{itemId:"toolbarbot",xtype:"toolbar",name:"wizar-toolbar",dock:"bottom",border:false,items:[{xtype:"button",text:"Back",itemId:"prev",action:"prevWizard",scope:this,handler:this.onPrevButtonClick},{xtype:"button",text:"Next",itemId:"next",action:"nextWizard",scope:this,handler:this.onNextButtonClick},{xtype:"button",text:"Confirm",itemId:"finish",action:"finishWizard",hidden:true,scope:this,handler:this.onConfirmButtonClick},{xtype:"button",text:"Cancel",ui:"link",itemId:"cancel",action:"cancelWizard",scope:this,handler:this.onCancelButtonClick}]}]});this.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.bulk.IssuesSelectionGrid",{extend:"Uni.view.grid.BulkSelection",xtype:"issues-selection-grid",store:"Isu.store.Issues",counterTextFn:function(a){return Uni.I18n.translatePlural("workspace.issues.bulk.IssuesSelectionGrid.counterText",a,"MDC","{0} issues selected")},allLabel:Uni.I18n.translate("workspace.issues.bulk.IssuesSelectionGrid.allLabel","MDC","All issues"),allDescription:Uni.I18n.translate("workspace.issues.bulk.IssuesSelectionGrid.allDescription","MDC","Select all issues (related to filters and grouping on the issues screen)"),selectedLabel:Uni.I18n.translate("workspace.issues.bulk.IssuesSelectionGrid.selectedLabel","MDC","Selected issues"),selectedDescription:Uni.I18n.translate("workspace.issues.bulk.IssuesSelectionGrid.selectedDescription","MDC","Select issues in table"),cancelHref:"#/search",columns:{defaults:{sortable:false,menuDisabled:true},items:[{itemId:"Title",header:"Title",xtype:"templatecolumn",tpl:'{reason.name}<tpl if="device"> to {device.serialNumber}</tpl>',flex:2},{itemId:"dueDate",header:"Due date",dataIndex:"dueDate",xtype:"datecolumn",format:"M d Y",width:140},{itemId:"status",header:"Status",xtype:"templatecolumn",tpl:'<tpl if="status">{status.name}</tpl>',width:100},{itemId:"assignee",header:"Assignee",xtype:"templatecolumn",tpl:'<tpl if="assignee.type"><span class="isu-icon-{assignee.type} isu-assignee-type-icon"></span></tpl> {assignee.name}',flex:1}]},initComponent:function(){this.callParent(arguments);this.getBottomToolbar().setVisible(false)}});Ext.define("Isu.view.workspace.issues.bulk.Step1",{extend:"Ext.panel.Panel",alias:"widget.bulk-step1",title:"Select issues",border:false,requires:["Isu.view.workspace.issues.List","Isu.util.FormErrorMessage","Isu.view.workspace.issues.bulk.IssuesSelectionGrid"],items:[{name:"step1-errors",layout:"hbox",hidden:true,items:[{itemId:"form-errors",xtype:"uni-form-error-message"}]},{xtype:"issues-selection-grid"}],initComponent:function(){this.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.bulk.Step2",{extend:"Ext.panel.Panel",alias:"widget.bulk-step2",title:"Select action",border:false,requires:["Ext.form.RadioGroup"],items:[{xtype:"panel",border:false,items:[{itemId:"radiogroupStep2",xtype:"radiogroup",columns:1,vertical:true,defaults:{name:"operation",submitValue:false},items:[{itemId:"Assign",boxLabel:"Assign issues",name:"operation",inputValue:"assign",checked:true},{itemId:"Close",boxLabel:"Close issues",name:"operation",inputValue:"close"}]}]}],initComponent:function(){this.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.bulk.Step3",{extend:"Ext.panel.Panel",alias:"widget.bulk-step3",title:"Action details",requires:["Isu.view.workspace.issues.CloseForm","Isu.view.workspace.issues.AssignForm"],initComponent:function(){this.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.bulk.Step4",{extend:"Ext.panel.Panel",alias:"widget.bulk-step4",title:"Confirmation",bodyCls:"isu-bulk-wizard-no-border",initComponent:function(){this.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.bulk.Step5",{extend:"Ext.panel.Panel",alias:"widget.bulk-step5",title:"Status",bodyCls:"isu-bulk-wizard-no-border",initComponent:function(){this.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.bulk.BulkWizard",{extend:"Isu.view.workspace.issues.bulk.Wizard",alias:"widget.bulk-wizard",itemId:"bulk-wizard",titlePrefix:"Bulk action",includeSubTitle:true,requires:["Isu.view.workspace.issues.bulk.Step1","Isu.view.workspace.issues.bulk.Step2","Isu.view.workspace.issues.bulk.Step3","Isu.view.workspace.issues.bulk.Step4","Isu.view.workspace.issues.bulk.Step5"],header:{title:"Wizard",ui:"large",style:{padding:"15px"}},items:[{itemId:"bulk-step1",xtype:"bulk-step1",cls:"bulk-step",buttonsConfig:{prevbuttonDisabled:true,nextbuttonDisabled:false,cancelbuttonDisabled:false,confirmbuttonDisabled:true,prevbuttonVisible:true,nextbuttonVisible:true,cancelbuttonVisible:true,confirmbuttonVisible:false}},{itemId:"bulk-step2",xtype:"bulk-step2",cls:"bulk-step",buttonsConfig:{prevbuttonDisabled:false,nextbuttonDisabled:false,cancelbuttonDisabled:false,confirmbuttonDisabled:true,prevbuttonVisible:true,nextbuttonVisible:true,cancelbuttonVisible:true,confirmbuttonVisible:false}},{itemId:"bulk-step3",xtype:"bulk-step3",cls:"bulk-step",buttonsConfig:{prevbuttonDisabled:false,nextbuttonDisabled:false,cancelbuttonDisabled:false,confirmbuttonDisabled:true,prevbuttonVisible:true,nextbuttonVisible:true,cancelbuttonVisible:true,confirmbuttonVisible:false}},{itemId:"bulk-step4",xtype:"bulk-step4",cls:"bulk-step",buttonsConfig:{prevbuttonDisabled:false,nextbuttonDisabled:true,cancelbuttonDisabled:false,confirmbuttonDisabled:false,prevbuttonVisible:true,nextbuttonVisible:false,cancelbuttonVisible:true,confirmbuttonVisible:true}},{itemId:"bulk-step5",xtype:"bulk-step5",cls:"bulk-step",buttonsConfig:{prevbuttonDisabled:true,nextbuttonDisabled:true,cancelbuttonDisabled:true,confirmbuttonDisabled:true,prevbuttonVisible:false,nextbuttonVisible:false,cancelbuttonVisible:false,confirmbuttonVisible:false}}],initComponent:function(){this.callParent(arguments)},onCancelButtonClick:function(a){var b=a.up("wizard");Ext.state.Manager.clear("formAssignValues");Ext.state.Manager.clear("formCloseValues");b.fireEvent("wizardcancelled",b)},onConfirmButtonClick:function(a){var b=a.up("wizard");var c=b.getDockedItems('toolbar[dock="bottom"]')[0];c.setVisible(false);b.getLayout().setActiveItem(++b.activeItemId);b.fireEvent("wizardpagechange",b);b.fireEvent("wizardfinished",b)},onNextButtonClick:function(a){var c=a.up("wizard"),b="processValidateOnStep"+(c.activeItemId+1);if(this.processValidate(b,c)){c.getLayout().setActiveItem(++c.activeItemId);c.fireEvent("wizardpagechange",c);c.fireEvent("wizardnext",c)}},processValidate:function(a,b){if(a in this){return this[a](b)}else{return true}},processValidateOnStep1:function(c){var b=c.down("issues-selection-grid"),a=c.down("[name=step1-errors]");if(!b.isAllSelected()&&Ext.isEmpty(b.view.getSelectionModel().getSelection())){a.setVisible(true);return false}else{a.setVisible(false);return true}},processValidateOnStep3:function(c){var a=c.down("bulk-step3").down("issues-assign-form"),b,e,d;if(!Ext.isEmpty(a)){b=a.down("[name=form-errors]");b.hide();e=a.down("radiogroup").down("[checked=true]");d=c.down("bulk-step3").down("issues-assign-form").down("combobox[name="+e.inputValue+"]");if(Ext.isEmpty(d.getValue())){b.setText("You must choose '"+e.boxLabel+"' before you can proceed");b.show();return false}}return true}});Ext.define("Isu.view.workspace.issues.bulk.Navigation",{extend:"Uni.view.menu.NavigationMenu",itemId:"bulkNavigation",alias:"widget.bulk-navigation",componentCls:"isu-bulk-navigation",width:200,jumpForward:true,items:[{itemId:"SelectIssues",text:"Select issues"},{itemId:"SelectAction",text:"Select action"},{itemId:"actionDetails",text:"Action details"},{itemId:"Confirmation",text:"Confirmation"},{itemId:"Status",text:"Status"}]});Ext.define("Isu.view.workspace.issues.bulk.Browse",{extend:"Uni.view.container.ContentContainer",alias:"widget.bulk-browse",itemId:"bulk-browse",componentCls:"isu-bulk-browse",requires:["Uni.view.navigation.SubMenu","Isu.view.workspace.issues.bulk.BulkWizard","Isu.view.workspace.issues.bulk.Navigation"],side:{itemId:"Bulkpanel",xtype:"panel",ui:"medium",layout:{type:"vbox",align:"stretch"},items:[{itemId:"bulkNavigation",xtype:"bulk-navigation"}]},content:[{xtype:"bulk-wizard",defaults:{cls:"content-wrapper"}}]});Ext.define("Isu.view.ext.button.IssuesGridAction",{extend:"Ext.button.Split",cls:"isu-grid-action-btn",menuAlign:"tl-bl",menu:{xtype:"menu",name:"issueactionmenu",shadow:false,border:false,plain:true,cls:"issue-action-menu",items:[{text:"Assign"},{text:"Close"}]}});Ext.define("Isu.model.BulkChangeIssues",{extend:"Ext.data.Model",fields:[{name:"operation",type:"string"},{name:"status",type:"string"},{name:"comment",type:"string"},{name:"assignee",type:"auto"}],hasMany:{model:"Isu.model.BulkIssues",name:"issues"}});Ext.define("Isu.store.BulkChangeIssues",{extend:"Ext.data.Store",model:"Isu.model.BulkChangeIssues",requires:["Ext.data.proxy.SessionStorage"],proxy:{type:"sessionstorage",id:"bulkProxy"}});Ext.define("Isu.controller.BulkChangeIssues",{extend:"Ext.app.Controller",requires:[],stores:["Isu.store.Issues","Isu.store.IssuesGroups","Isu.store.BulkChangeIssues"],views:["workspace.issues.bulk.Browse","ext.button.IssuesGridAction","Uni.view.button.SortItemButton"],listeners:{retryRequest:function(b,a){this.setFailedBulkRecordIssues(a);this.onWizardFinishedEvent(b)}},mixins:["Isu.util.IsuGrid"],refs:[{selector:"bulk-browse bulk-navigation",ref:"bulkNavigation"}],init:function(){this.control({"bulk-browse bulk-wizard":{wizardnext:this.onWizardNextEvent,wizardprev:this.onWizardPrevEvent,wizardstarted:this.onWizardStartedEvent,wizardfinished:this.onWizardFinishedEvent,wizardcancelled:this.onWizardCancelledEvent},"bulk-browse bulk-navigation":{movetostep:this.setActivePage},"bulk-browse bulk-wizard bulk-step1 issues-selection-grid":{afterrender:this.onIssuesListAfterRender},"bulk-browse bulk-wizard bulk-step1 issues-list gridview":{refresh:this.setAssigneeTypeIconTooltip},"bulk-browse bulk-wizard bulk-step2 radiogroup":{change:this.onStep2RadiogroupChangeEvent,afterrender:this.getDefaultStep2Operation},"bulk-browse bulk-wizard bulk-step3 issues-close-form radiogroup":{change:this.onStep3RadiogroupCloseChangeEvent,afterrender:this.getDefaultCloseStatus},"bulk-browse bulk-step4":{beforeactivate:this.beforeStep4}})},showOverview:function(){var b=this,d=this.getStore("Isu.store.Issues"),a=d.getProxy(),e=new Isu.model.ExtraParams(),c;a.extraParams={};a.setExtraParam("status",e.getDefaults().status);c=Ext.widget("bulk-browse");b.getApplication().fireEvent("changecontentevent",c)},setActivePage:function(a){var b=this.createdWizard;b.show();b.activeItemId=a-1;b.getLayout().setActiveItem(b.activeItemId);b.fireEvent("wizardpagechange",b)},setFailedBulkRecordIssues:function(d){var b=this.getBulkRecord(),c=b.get("issues"),a=[];Ext.each(c,function(e){if(Ext.Array.contains(d,e.get("id"))){a.push(e)}});b.set("issues",a);b.commit()},onIssuesListAfterRender:function(a){var b=new Isu.model.ExtraParams();a.mask();a.store.load({params:{status:b.getDefaults().status},start:0,limit:99999,callback:function(){a.unmask()}})},onBulkActionEvent:function(){var a=Ext.widget("bulk-browse");this.getApplication().fireEvent("changecontentevent",a)},onWizardPrevEvent:function(b){var a=b.getActiveItemId();this.setBulkActionListActiveItem(b);this.getBulkNavigation().movePrevStep()},onWizardNextEvent:function(c){var a=c.getActiveItemId();this.setBulkActionListActiveItem(c);var b="processNextOnStep"+a;this.processStep(b,c);this.getBulkNavigation().moveNextStep()},onWizardStartedEvent:function(a){this.createdWizard=a;this.setBulkActionListActiveItem(a)},onWizardFinishedEvent:function(f){var g=this,a=Ext.ComponentQuery.query("bulk-browse")[0].down("bulk-wizard").down("bulk-step5"),e=g.getBulkRecord(),b=g.getRequestData(e),c=e.get("operation"),h="/api/isu/issue/"+c,i=[],d=[];this.setBulkActionListActiveItem(f);var j=Ext.create("Ext.ProgressBar",{width:"50%"});a.removeAll(true);a.add(j.wait({interval:50,increment:20,text:(c==="assign"?"Assigning ":"Closing ")+b.issues.length+" issue(s). Please wait..."}));Ext.Ajax.request({url:h,method:"PUT",jsonData:b,success:function(o){var q=Ext.decode(o.responseText).data,s=q.success.length,k=0,l=0,v,z,n,w="",m="";if(!Ext.isEmpty(q.success)){switch(c){case"assign":if(s>0){v="<h3>Successfully assigned "+s+(s>1?" issues":" issue")+" to "+e.get("assignee").title+"</h3><br>"}break;case"close":if(s>0){v="<h3>Successfully closed "+s+(s>1?" issues":" issue")+"</h3><br>"}}}if(!Ext.isEmpty(q.failure)){Ext.each(q.failure,function(A){switch(A.reason){case"Issue doesn't exist":w+="<h4>"+A.reason+':</h4><ul style="list-style: none; padding-left: 1em;">';Ext.each(A.issues,function(B){k+=1;i.push(B.id);w+='<li>- <a href="javascript:void(0)">'+B.title+"</a></li>"});w+="</ul>";break;default:m+="<h4>"+A.reason+':</h4><ul style="list-style: none; padding-left: 1em;">';Ext.each(A.issues,function(B){l+=1;d.push(B.id);m+='<li>- <a href="javascript:void(0)">'+B.title+"</a></li>"});m+="</ul>"}});switch(c){case"assign":if(k>0){z="<h3>Unable to assign "+k+(k>1?" issues":" issue")+"</h3><br>"+w}if(l>0){n="<h3>Failed to assign "+l+(l>1?" issues":" issue")+"</h3><br>"+m}break;case"close":if(k>0){z="<h3>Unable to close "+k+(k>1?" issues":" issue")+"</h3><br>"+w}if(l>0){n="<h3>Failed to close "+l+(l>1?" issues":" issue")+"</h3><br>"+m}}}a.removeAll(true);if(s>0){var r={type:"success",msgBody:[{html:v}],closeBtn:false};if(l==0){r.btns=[{text:"OK",hnd:function(){a.removeAll(true);Ext.History.back()}}]}var y=Ext.widget("message-panel",r);y.addClass("isu-bulk-message-panel");a.add(y)}if(k>0){var p={type:"attention",msgBody:[{html:z}],btns:[],closeBtn:false};var u=Ext.widget("message-panel",p);u.addClass("isu-bulk-message-panel");a.add(u)}if(l>0){var x={type:"error",msgBody:[{html:n}],btns:[{text:"Retry",hnd:function(){g.fireEvent("retryRequest",f,d)}},{text:"Finish",hnd:function(){Ext.History.back()}}],closeBtn:false};var t=Ext.widget("message-panel",x);t.addClass("isu-bulk-message-panel");a.add(t)}},failure:function(k){a.removeAll(true);Ext.History.back()}})},getRequestData:function(d){var c={issues:[]},a=d.get("operation"),b=d.get("issues");Ext.iterate(b,function(e){c.issues.push({id:e.get("id"),version:e.get("version")})});switch(a){case"assign":c.assignee={id:d.get("assignee").id,type:d.get("assignee").type};break;case"close":c.status=d.get("status");break}c.comment=d.get("comment");return c},onWizardCancelledEvent:function(a){window.location.href="#/workspace/datacollection/issues/"},setBulkActionListActiveItem:function(b){var a=b.getActiveItemId()},processStep:function(a,b){if(a in this){this[a](b)}},getBulkRecord:function(){var b=Ext.getStore("Isu.store.BulkChangeIssues"),a=b.getAt(0);if(!a){b.add({operation:"assign"})}return b.getAt(0)},onStep2RadiogroupChangeEvent:function(d,c,b){var a=this.getBulkRecord();a.set("operation",c.operation);a.commit()},onStep3RadiogroupCloseChangeEvent:function(d,c,b){var a=this.getBulkRecord();a.set("status",c.status);a.set("statusName",d.getChecked()[0].boxLabel);a.commit()},getDefaultStep2Operation:function(){var a=Ext.ComponentQuery.query("bulk-browse")[0].down("bulk-wizard").down("bulk-step2").down("panel"),c=a.down("radiogroup").getValue().operation,b=this.getBulkRecord();b.set("operation",c);b.commit()},getDefaultCloseStatus:function(){var a=Ext.ComponentQuery.query("bulk-browse")[0].down("bulk-wizard").down("bulk-step3").down("issues-close-form"),c=a.down("radiogroup").getValue().status,b=this.getBulkRecord();b.set("status",c);b.commit()},processNextOnStep1:function(d){var a=this.getBulkRecord(),b=d.down("bulk-step1").down("issues-selection-grid"),c=b.getSelectionModel().getSelection();if(b.isAllSelected()){c=b.store.data.items}a.set("issues",c);a.commit()},processNextOnStep2:function(f){var b=this.getBulkRecord(),e=f.down("bulk-step3"),c=b.get("operation"),a,d;switch(c){case"assign":a="issues-assign-form";break;case"close":a="issues-close-form";break}d=Ext.widget(a);if(!Ext.isEmpty(d.items.getAt(1))){d.items.getAt(1).margin="0"}if(d){e.removeAll(true);e.add(d)}},processNextOnStep3:function(h){var b=h.down("bulk-step3").down("form"),a=b.getForm();if(a.isValid()){var e=this.getBulkRecord(),i=h.down("bulk-step4"),c=e.get("operation"),j,d;switch(c){case"assign":var f=b.down("radiogroup").down("radio[checked=true]").inputValue,g=b.down("combo[name="+f+"]");e.set("assignee",{id:g.findRecordByValue(g.getValue()).data.id,type:g.name,title:g.rawValue});j="<h3>Assign "+e.get("issues").length+(e.get("issues").length>1?" issues":" issue")+" to "+e.get("assignee").title+"?</h3><br>The selected issue(s) will be assigned to "+e.get("assignee").title;break;case"close":j="<h3>Close "+e.get("issues").length+(e.get("issues").length>1?" issues":" issue")+'?</h3><br>The selected issue(s) will be closed with status "<b>'+e.get("statusName")+'</b>"';break}e.set("comment",b.down("textarea").getValue().trim());d=Ext.widget("container",{cls:"isu-bulk-assign-confirmation-request-panel",html:j});i.removeAll(true);i.add(d)}},beforeStep4:function(){if(this.getBulkRecord().get("operation")=="assign"){var a=Ext.ComponentQuery.query("bulk-step3 issues-assign-form")[0].getForm();return !a||a.isValid()}}});Ext.define("Isu.view.workspace.issues.MessagePanel",{extend:"Ext.panel.Panel",alias:"widget.message-panel",msgHeaderStyle:{fontSize:"16px",margin:"10 0 0 0"},msgItemStyle:{fontSize:"12px",margin:"5 0 0 10"},itemId:"message-panel",autoShow:true,resizable:false,bodyBorder:false,shadow:false,animCollapse:true,border:false,header:false,cls:"isu-msg-panel",margin:"2",defaults:{style:{opacity:1}},layout:{type:"vbox",align:"stretch"},types:{attention:{iconCls:"isu-icon-attention isu-msg-attention-icon",colorCls:"isu-msg-attention"},question:{iconCls:"isu-icon-help isu-msg-question-icon",colorCls:"isu-msg-question"},success:{iconCls:"isu-icon-ok isu-msg-success-icon",colorCls:"isu-msg-success"},error:{iconCls:"isu-icon-attention isu-msg-error-icon",colorCls:"isu-msg-error"},notify:{iconCls:"",colorCls:"isu-msg-notify"}},items:[{xtype:"panel",cls:"isu-msg-panel",defaults:{opacity:1},layout:{type:"hbox",align:"stretch"},items:[{itemId:"msgIcon",xtype:"panel",name:"msgiconpanel",layout:{type:"hbox",align:"middle"},cls:"isu-msg-panel",defaults:{opacity:1}},{itemId:"msgmessage",xtype:"panel",name:"msgmessagepanel",cls:"isu-msg-panel",defaults:{opacity:1},layout:{type:"vbox",align:"left"}},{itemId:"closeBTN",xtype:"panel",name:"msgclosepanel",cls:"isu-msg-panel",defaults:{opacity:1},layout:{type:"hbox"}}]},{xtype:"panel",name:"msgbottompanel",cls:"isu-msg-panel",border:0,defaults:{opacity:1},padding:"0 0 0 40"}]});Ext.define("Isu.view.workspace.issues.MessageWindow",{extend:"Ext.window.Window",alias:"widget.message-window",autoShow:true,resizable:false,bodyBorder:false,shadow:false,y:10,animCollapse:true,border:false,cls:"isu-msg-window",header:false,layout:{type:"vbox",align:"center"}});Ext.define("Isu.controller.MessageWindow",{extend:"Ext.app.Controller",views:["workspace.issues.MessagePanel","workspace.issues.MessageWindow"],init:function(){this.control({"message-panel":{afterrender:this.fillWindow}});this.getApplication().on("isushowmsg",this.showMsg)},randomDirection:function(){var a=[Ext.Component.DIRECTION_TOP,Ext.Component.DIRECTION_BOTTOM,Ext.Component.DIRECTION_RIGHT,Ext.Component.DIRECTION_LEFT];return a[Math.floor(Math.random()*a.length)]},showMsg:function(b){var a;if(this.msgWindow==undefined){a=Ext.widget("message-window");this.msgWindow=a}else{a=this.msgWindow}b.xtype="message-panel";a.add(b);a.center();a.setPosition(a.x,50,false)},initMsgWindow:function(b){var a=b.types[b.type],e=this;if(a.colorCls){b.addCls(a.colorCls)}b.on("collapse",function(f){if(f.isClosing){f.close()}else{f.expand(true)}});b.collapseClose=function(){b.isClosing=true;b.collapse(e.randomDirection(),true)};if(b.showTime){var d=new Ext.util.TaskRunner(),c=d.newTask({interval:b.showTime,run:b.collapseClose});c.start()}},fillMsgPanel:function(a){var b=Ext.ComponentQuery.query("panel[name=msgmessagepanel]",a)[0],c=[];Ext.Array.each(a.msgBody,function(d){d.xtype="label";d.style=a[d.style];d.itemId="msgmessagepanel";c.push(d)});b.add(c)},fillIconPanel:function(b){var c=Ext.ComponentQuery.query("panel[name=msgiconpanel]",b)[0],a=b.types[b.type].iconCls;c.add({xtype:"box",cls:a})},fillClosePanel:function(a){var b=Ext.ComponentQuery.query("panel[name=msgclosepanel]",a)[0];if(a.closeBtn){b.add({xtype:"button",name:"msgwindowclosebtn",iconCls:"isu-icon-cancel-circled2",cls:Ext.baseCSSPrefix+"btn-plain-toolbar-medium",style:{fontSize:"20px",padding:"0px"},width:28,height:24,handler:function(){a.close()}})}},fillBottomPanel:function(b){var c=[],a=Ext.ComponentQuery.query("panel[name=msgbottompanel]",b)[0];Ext.Array.each(b.btns,function(d){d.xtype="button";d.margin="0 0 0 5";d.handler=function(){d.hnd();b.close()};c.push(d)});a.add(c)},fillWindow:function(a){this.initMsgWindow(a);this.fillMsgPanel(a);this.fillIconPanel(a);this.fillClosePanel(a);this.fillBottomPanel(a)}});Ext.define("Isu.view.administration.datacollection.issueassignmentrules.List",{extend:"Ext.grid.Panel",requires:["Ext.layout.container.Column","Ext.grid.column.Template","Ext.grid.column.Action"],alias:"widget.issues-assignment-rules-list",store:"Isu.store.AssignmentRules",height:285,columns:{defaults:{sortable:false,menuDisabled:true},items:[{header:"Description",dataIndex:"description",tdCls:"isu-grid-description",flex:1},{header:"Assign to",xtype:"templatecolumn",tpl:'<tpl if="assignee.type"><span class="isu-icon-{assignee.type} isu-assignee-type-icon"></span></tpl> {assignee.name}',flex:1},{xtype:"uni-actioncolumn",items:"Isu.view.administration.datacollection.issueassignmentrules.ActionMenu"}]},dockedItems:[{xtype:"toolbar",dock:"top"}],initComponent:function(){var b=this,a;b.callParent(arguments);a=b.getStore();b.onStoreLoad(a);a.on({load:{fn:b.onStoreLoad,scope:b}});a.load()},onStoreLoad:function(a){var b=a.getCount();if(b){this.setTotal(b)}},setTotal:function(b){var a=this,c;if(a){c=a.getDockedItems('toolbar[dock="top"]')[0];c.removeAll();c.add({xtype:"component",html:b+" rule"+(b>1?"s":"")})}}});Ext.define("Isu.view.administration.datacollection.issueassignmentrules.Overview",{extend:"Uni.view.container.ContentContainer",requires:["Uni.view.navigation.SubMenu","Isu.view.administration.datacollection.issueassignmentrules.List","Uni.view.container.PreviewContainer","Uni.view.notifications.NoItemsFoundPanel"],alias:"widget.issue-assignment-rules-overview",content:{itemId:"title",xtype:"panel",ui:"large",title:Uni.I18n.translate("issue.administration.assignment","ISE","Issue assignment rules"),items:{itemId:"issues-rules-list",xtype:"preview-container",grid:{xtype:"issues-assignment-rules-list"},emptyComponent:{xtype:"no-items-found-panel",title:Uni.I18n.translate("issueAssignment.empty.title","ISE","No issue assignment rules found"),reasons:[Uni.I18n.translate("issueAssignment.empty.list.item","ISE","No issue assignment rules have been defined yet.")]},previewComponent:null}}});Ext.define("Isu.view.administration.datacollection.issueassignmentrules.ActionMenu",{extend:"Ext.menu.Menu",alias:"widget.rule-action-menu",plain:true,border:false,shadow:false,items:[]});Ext.define("Isu.model.AssignmentRules",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"assignee",type:"auto"},{name:"version",type:"int"}],proxy:{type:"rest",url:"/api/isu/rules/assign",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.AssignmentRules",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],model:"Isu.model.AssignmentRules",pageSize:100,autoLoad:false});Ext.define("Isu.controller.IssueAssignmentRules",{extend:"Ext.app.Controller",requires:[],stores:["Isu.store.AssignmentRules"],views:["administration.datacollection.issueassignmentrules.Overview","ext.button.GridAction","administration.datacollection.issueassignmentrules.ActionMenu"],mixins:{isuGrid:"Isu.util.IsuGrid"},init:function(){this.control({"issue-assignment-rules-overview issues-assignment-rules-list gridview":{refresh:this.onGridRefresh}})},showOverview:function(){var a=Ext.widget("issue-assignment-rules-overview");this.getApplication().fireEvent("changecontentevent",a)},onGridRefresh:function(a){this.setAssigneeTypeIconTooltip(a);this.setDescriptionTooltip(a)}});Ext.define("Isu.view.administration.datacollection.issuecreationrules.List",{extend:"Ext.grid.Panel",requires:["Ext.layout.container.Column","Ext.grid.column.Template","Uni.grid.column.Action","Uni.view.toolbar.PagingTop","Uni.view.toolbar.PagingBottom"],alias:"widget.issues-creation-rules-list",store:"Isu.store.CreationRule",columns:{items:[{itemId:"Name",header:Uni.I18n.translate("general.title.name","ISE","Name"),dataIndex:"name",tdCls:"isu-grid-description",flex:1},{itemId:"templateColumn",header:Uni.I18n.translate("general.title.ruleTemplate","ISE","Rule template"),xtype:"templatecolumn",tpl:'<tpl if="template">{template.name}</tpl>',tdCls:"isu-grid-description",flex:1},{itemId:"issueType",header:Uni.I18n.translate("general.title.issueType","ISE","Issue type"),xtype:"templatecolumn",tpl:'<tpl if="issueType">{issueType.name}</tpl>',tdCls:"isu-grid-description",flex:1},{itemId:"action",xtype:"uni-actioncolumn",items:"Isu.view.administration.datacollection.issuecreationrules.ActionMenu"}]},dockedItems:[{itemId:"pagingtoolbartop",xtype:"pagingtoolbartop",dock:"top",displayMsg:Uni.I18n.translate("administration.issueCreationRules.pagingtoolbartop.displayMsg","ISE","{0} - {1} of {2} issue creation rules"),displayMoreMsg:Uni.I18n.translate("administration.issueCreationRules.pagingtoolbartop.displayMoreMsg","ISE","{0} - {1} of more than {2} issue creation rules"),emptyMsg:Uni.I18n.translate("administration.issueCreationRules.pagingtoolbartop.emptyMsg","ISE","There are no issue creation rules to display"),items:["->",{itemId:"createRule",xtype:"button",text:Uni.I18n.translate("administration.issueCreationRules.add","ISE","Create rule"),href:"#/administration/creationrules/add",action:"create"}]},{itemId:"pagingtoolbarbottom",xtype:"pagingtoolbarbottom",dock:"bottom",itemsPerPageMsg:Uni.I18n.translate("administration.issueCreationRules.pagingtoolbarbottom.itemsPerPage","ISE","Issue creation rules per page")}],initComponent:function(){var b=this.store,a=Ext.Array.findBy(this.dockedItems,function(d){return d.xtype=="pagingtoolbartop"}),c=Ext.Array.findBy(this.dockedItems,function(d){return d.xtype=="pagingtoolbarbottom"});a&&(a.store=b);c&&(c.store=b);this.callParent(arguments)}});Ext.define("Isu.view.administration.datacollection.issuecreationrules.ActionMenu",{extend:"Ext.menu.Menu",alias:"widget.creation-rule-action-menu",plain:true,border:false,shadow:false,items:[{itemId:"edit",text:"Edit",action:"edit"},{itemId:"delete",text:"Delete",action:"delete"}]});Ext.define("Isu.view.administration.datacollection.issuecreationrules.Item",{extend:"Ext.panel.Panel",requires:["Isu.view.administration.datacollection.issuecreationrules.ActionMenu"],alias:"widget.issue-creation-rules-item",title:"Details",itemId:"issue-creation-rules-item",frame:true,tools:[{xtype:"button",text:Uni.I18n.translate("general.actions","ISE","Actions"),iconCls:"x-uni-action-iconD",menu:{xtype:"creation-rule-action-menu"}}],items:{xtype:"form",layout:"column",defaults:{xtype:"container",layout:"form",columnWidth:0.5},items:[{defaults:{xtype:"displayfield",labelWidth:200},items:[{fieldLabel:Uni.I18n.translate("general.title.name","ISE","Name"),name:"name"},{fieldLabel:Uni.I18n.translate("general.title.ruleTemplate","ISE","Rule template"),name:"template_name"},{fieldLabel:Uni.I18n.translate("general.title.issueType","ISE","Issue type"),name:"issueType_name"},{fieldLabel:Uni.I18n.translate("general.title.issueReason","ISE","Issue reason"),name:"reason_name"},{fieldLabel:Uni.I18n.translate("general.title.dueIn","ISE","Due in"),name:"due_in"}]},{defaults:{xtype:"displayfield",labelWidth:200},items:[{fieldLabel:Uni.I18n.translate("general.title.created","ISE","Created"),name:"creationDate",renderer:Ext.util.Format.dateRenderer("M d, Y H:i")},{fieldLabel:Uni.I18n.translate("general.title.lastModified","ISE","Last modified"),name:"modificationDate",renderer:Ext.util.Format.dateRenderer("M d, Y H:i")}]}]}});Ext.define("Isu.view.administration.datacollection.issuecreationrules.Overview",{extend:"Uni.view.container.ContentContainer",requires:["Uni.view.navigation.SubMenu","Isu.view.administration.datacollection.issuecreationrules.List","Isu.view.administration.datacollection.issuecreationrules.Item"],alias:"widget.issue-creation-rules-overview",itemId:"creation-rules-overview",content:[{cls:"content-wrapper",items:[{itemId:"pageTitle",title:"Issue creation rules",ui:"large",margin:"0 0 20 0"},{itemId:"creation-rules-list",xtype:"issues-creation-rules-list",margin:"0 15 20 0"},{itemId:"creation-rules-item",xtype:"issue-creation-rules-item",margin:"0 15 0 0"}]}]});Ext.define("Isu.view.administration.datacollection.issuecreationrules.Overview",{extend:"Uni.view.container.ContentContainer",alias:"widget.issue-creation-rules-overview",itemId:"creation-rules-overview",requires:["Isu.view.administration.datacollection.issuecreationrules.List","Isu.view.administration.datacollection.issuecreationrules.Item","Uni.view.container.PreviewContainer","Uni.view.notifications.NoItemsFoundPanel"],content:[{xtype:"panel",ui:"large",title:Uni.I18n.translate("administration.issueCreationRules.title","ISE","Issue creation rules"),items:[{xtype:"preview-container",grid:{itemId:"creation-rules-list",xtype:"issues-creation-rules-list"},emptyComponent:{xtype:"no-items-found-panel",title:Uni.I18n.translate("administration.issueCreationRules.empty.title","ISE","No issue creation rules found"),reasons:[Uni.I18n.translate("administration.issueCreationRules.empty.list.item1","ISE","No issue creation rules have been defined yet."),Uni.I18n.translate("administration.issueCreationRules.empty.list.item2","ISE","No issue creation rules comply to the filter.")],stepItems:[{itemId:"createRule",text:Uni.I18n.translate("administration.issueCreationRules.add","ISE","Create rule"),href:"#/administration/creationrules/add",action:"create"}]},previewComponent:{xtype:"issue-creation-rules-item"}}]}]});Ext.define("Isu.model.CreationRule",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"int"},{name:"name",type:"string"},{name:"parameters",type:"auto"},{name:"comment",type:"string"},{name:"creationDate",dateFormat:"time",type:"date"},{name:"modificationDate",dateFormat:"time",type:"date"},{name:"version",type:"int"},{name:"template",type:"auto"},{name:"issueType",type:"auto"},{name:"reason",type:"auto"},{name:"dueIn",type:"auto"},{name:"title",mapping:"name"},{name:"issueType_name",mapping:"issueType.name"},{name:"reason_name",mapping:"reason.name"},{name:"template_name",mapping:"template.name"},{name:"due_in",mapping:function(b){var a="";if(b.dueIn&&b.dueIn.number){a=b.dueIn.number+" "+b.dueIn.type}return a}}],associations:[{name:"actions",type:"hasMany",model:"Isu.model.CreationRuleAction",associationKey:"actions"}],proxy:{type:"rest",url:"/api/isu/creationrules",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.CreationRule",{extend:"Ext.data.Store",model:"Isu.model.CreationRule",pageSize:10,autoLoad:false});Ext.define("Isu.controller.IssueCreationRules",{extend:"Ext.app.Controller",requires:[],stores:["Isu.store.CreationRule"],views:["Isu.view.administration.datacollection.issuecreationrules.Overview","Isu.view.ext.button.GridAction","Isu.view.administration.datacollection.issuecreationrules.ActionMenu","Isu.view.workspace.issues.MessagePanel"],mixins:{isuGrid:"Isu.util.IsuGrid"},refs:[{ref:"page",selector:"issue-creation-rules-overview"},{ref:"itemPanel",selector:"issue-creation-rules-overview issue-creation-rules-item"},{ref:"rulesGridPagingToolbarTop",selector:"issue-creation-rules-overview issues-creation-rules-list pagingtoolbartop"}],init:function(){this.control({"issue-creation-rules-overview issues-creation-rules-list":{select:this.loadGridItemDetail},"issue-creation-rules-overview issues-creation-rules-list gridview":{refresh:this.setAssigneeTypeIconTooltip},"issues-creation-rules-list uni-actioncolumn":{menuclick:this.chooseAction},"creation-rule-action-menu":{click:this.chooseAction},"issue-creation-rules-overview button[action=create]":{click:this.createRule}});this.gridItemModel=this.getModel("Isu.model.CreationRule")},showOverview:function(){var a=Ext.widget("issue-creation-rules-overview");this.getApplication().fireEvent("changecontentevent",a)},chooseAction:function(d,b){var c=b.action;var e=d.record.getId();var a=this.getController("Uni.controller.history.Router");switch(c){case"delete":this.showDeleteConfirmation(d.record);break;case"edit":a.getRoute("administration/creationrules/edit").forward({id:e});break}},createRule:function(){var a=this.getController("Uni.controller.history.Router");a.getRoute("administration/creationrules/add").forward()},showDeleteConfirmation:function(b){var a=this;Ext.create("Uni.view.window.Confirmation").show({msg:Uni.I18n.translate("administration.issueCreationRules.deleteConfirmation.msg","ISE","This issue creation rule will disappear from the list.<br>Issues will not be created automatically by this rule."),title:Ext.String.format(Uni.I18n.translate("administration.issueCreationRules.deleteConfirmation.title","ISE",'Delete rule "{0}"?'),b.get("name")),config:{me:a,rule:b},fn:function(c){switch(c){case"confirm":this.close();a.deleteRule(b);break;case"cancel":this.close();break}}})},deleteRule:function(d){var b=this,a=this.getStore("Isu.store.CreationRule"),c=this.getPage();c.setLoading("Removing...");d.destroy({params:{version:d.get("version")},callback:function(f,e){c.setLoading(false);if(e.response.status==204){a.loadPage(1);b.getApplication().fireEvent("acknowledge",Uni.I18n.translate("administration.issueCreationRules.deleteSuccess.msg","ISE","Issue creation rule deleted"))}}})}});Ext.define("Isu.view.workspace.issues.Form",{extend:"Ext.form.Panel",alias:"widget.issue-form",layout:"column",itemId:"issue-detailed-form",defaults:{xtype:"container",layout:"form",columnWidth:0.5},ui:"medium",items:[{items:[{itemId:"_reason",xtype:"displayfield",fieldLabel:"Reason",name:"reason_name"},{itemId:"_customer",xtype:"displayfield",fieldLabel:"Customer",name:"customer"},{itemId:"_location",xtype:"displayfield",fieldLabel:"Location",name:"service_location"},{itemId:"_usagepoint",xtype:"displayfield",fieldLabel:"Usage point",name:"usage_point"},{itemId:"_devicename",xtype:"displayfield",fieldLabel:"Device",name:"devicelink"}]},{items:[{itemId:"_status",xtype:"displayfield",fieldLabel:"Status",name:"status_name"},{itemId:"_dueDate",xtype:"displayfield",fieldLabel:"Due date",name:"dueDate",renderer:Ext.util.Format.dateRenderer("M d, Y")},{itemId:"_assignee",xtype:"displayfield",fieldLabel:"Assignee",name:"assignee_name"},{itemId:"_creationDate",xtype:"displayfield",fieldLabel:"Creation date",name:"creationDate",renderer:Ext.util.Format.dateRenderer("M d, Y H:i")},{itemId:"_serviceCat",xtype:"displayfield",fieldLabel:"Service category",name:"service_category"}]}]});Ext.define("Isu.view.ext.button.Action",{extend:"Ext.button.Split",alias:"widget.action-btn",cls:"isu-action-button-inactive",menuActiveCls:"isu-action-button-active",iconCls:"isu-action-icon",menuAlign:"tr-br?",listeners:{click:{fn:function(a,b){a.showMenu()}},menushow:{fn:function(a,b){a.removeCls("isu-action-button-inactive")}},menuhide:{fn:function(a,b){a.addCls("isu-action-button-inactive")}}}});Ext.define("Isu.model.IssueComments",{extend:"Ext.data.Model",requires:["Ext.data.proxy.Rest"],fields:[{name:"author",type:"auto"},{name:"comment",type:"string"},{name:"creationDate",dateFormat:"time",type:"date"},{name:"version",type:"int"}],proxy:{type:"rest",url:"/api/isu/issue/{issue_id}/comments",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.IssueComments",{extend:"Ext.data.Store",model:"Isu.model.IssueComments",autoLoad:false,proxy:{type:"rest",reader:{type:"json",root:"data"}},sorters:[{sorterFn:function(b,a){return b.get("creationDate")>a.get("creationDate")}}]});Ext.define("Isu.view.workspace.issues.comment.AddForm",{extend:"Ext.form.Panel",title:"Add comment",alias:"widget.comment-add-form",layout:"fit",items:{itemId:"comment-area",xtype:"textareafield",label:"comment",name:"comment"},bbar:{layout:{type:"hbox",align:"left"},items:[{itemId:"add",text:"Add",ui:"action",action:"send",disabled:true},{itemId:"cancel",text:"Cancel",action:"cancel",ui:"link"}]}});Ext.define("Isu.view.workspace.issues.comment.List",{extend:"Ext.panel.Panel",requires:["Isu.view.ext.button.Action","Isu.store.IssueComments","Isu.view.workspace.issues.comment.AddForm"],alias:"widget.issue-comments",title:"Comments",ui:"medium",buttonAlign:"left",items:[{itemId:"dataview",xtype:"dataview",title:"User Images",deferEmptyText:false,emptyText:"<h3>There are no comments yet on this issue </h3>",itemSelector:"div.thumb-wrap",tpl:new Ext.XTemplate('<tpl for=".">','<p><span class="isu-icon-USER"></span><b>{author.name}</b> added a comment - {[values.creationDate ? this.formatCreationDate(values.creationDate) : ""]}</p>',"<p>{comment}</p>","</tpl>",{formatCreationDate:function(a){a=Ext.isDate(a)?a:new Date(a);return Ext.Date.format(a,"M d, Y (H:i)")}}),header:"Name",dataIndex:"name"},{itemId:"comment-add-form",xtype:"comment-add-form",hidden:true}],afterRender:function(){var b=Ext.util.History.getToken(),a=b.lastIndexOf("/"),c=b.substring(a+1);if(c=="addcomment"){this.child("toolbar").child("#Add").hide();this.child("#comment-add-form").show()}this.callParent(arguments)},buttons:[{itemId:"Add",ui:"action",text:"Add comment",action:"add"}]});Ext.define("Isu.view.workspace.issues.DetailOverview",{extend:"Uni.view.container.ContentContainer",requires:["Isu.view.workspace.issues.Form","Isu.view.workspace.issues.comment.List"],alias:"widget.issue-detail-overview",title:"Issue detail overview",content:[{ui:"large",items:[{itemId:"detailedPage",xtype:"issue-form"},{itemId:"issue-comments",xtype:"issue-comments"}],dockedItems:[{xtype:"toolbar",dock:"top",defaultButtonUI:"link",rtl:false,items:[{xtype:"tbfill"},{text:"Previous",action:"prev"},{text:"Next",action:"next"}]}]}]});Ext.define("Isu.controller.IssueDetail",{extend:"Ext.app.Controller",requires:[],stores:["Isu.store.Issues","Isu.store.IssueComments"],views:["workspace.issues.DetailOverview"],refs:[{ref:"page",selector:"issue-detail-overview"},{ref:"detailPanel",selector:"issue-detail-overview issue-detail"},{ref:"commentsPanel",selector:"issue-detail-overview issue-comments dataview"},{ref:"commentForm",selector:"issue-detail-overview issue-comments comment-add-form"},{ref:"commentInput",selector:"issue-detail-overview issue-comments comment-add-form textareafield"},{ref:"addCommentButton",selector:"issue-detail-overview issue-comments button[action=add]"},{ref:"sendCommentButton",selector:"issue-detail-overview form button[action=send]"}],init:function(){this.control({"issue-detail-overview issue-comments button[action=add]":{click:this.showCommentForm},"issue-detail-overview form button[action=cancel]":{click:this.hideCommentForm},"issue-detail-overview form button[action=send]":{click:this.addComment},"issue-detail-overview form textareafield":{change:this.validateCommentForm}})},showOverview:function(f,a){var b=this,e=Ext.widget("issue-detail-overview"),c=b.getModel("Isu.model.Issues"),d=e.down("issue-form");a&&b.showCommentForm();c.load(f,{success:function(g){d.loadRecord(g);d.setTitle(g.get("title"));var h=g.comments();h.getProxy().url=h.getProxy().url.replace("{issue_id}",g.getId());h.clearFilter();h.proxy.url="/api/isu/issue/"+f+"/comments";h.load();b.getApplication().fireEvent("changecontentevent",e);b.getCommentsPanel().bindStore(h);b.setNavigationButtons(g)},failure:function(){window.location.href="#/workspace/datacollection/issues"}})},showCommentForm:function(a){this.getCommentForm().show();this.getCommentInput().focus();a.hide()},hideCommentForm:function(){var b=this.getCommentForm(),a=this.getAddCommentButton();b.down("textareafield").reset();b.hide();a.show()},validateCommentForm:function(b,c){var a=this.getSendCommentButton();a.setDisabled(!c.trim().length)},addComment:function(){var b=this,c=b.getCommentsPanel(),d=c.getStore();var a=c.getStore();a.add(b.getCommentForm().getValues());a.sync();b.hideCommentForm()},setNavigationButtons:function(e){var h=this.getPage().down("[action=prev]"),b=this.getPage().down("[action=next]"),g=this.getStore("Isu.store.Issues"),c=g.indexOf(e),d=this.getController("Uni.controller.history.Router"),f,a;if(c!=-1){c&&(f=c-1);(g.getCount()>(c+1))&&(a=c+1);if(f||f==0){h.on("click",function(){d.getRoute("workspace/datacollection/issues/view").forward({id:g.getAt(f).getId()})})}else{h.setDisabled(true)}if(a){b.on("click",function(){d.getRoute("workspace/datacollection/issues/view").forward({id:g.getAt(a).getId()})})}else{b.setDisabled(true)}h.show();b.show()}else{h.hide();b.hide()}}});Ext.define("Isu.controller.AdministrationDataCollection",{extend:"Ext.app.Controller",requires:[],views:[]});Ext.define("Isu.view.workspace.issues.component.UserCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.issues-user-combo",store:"Isu.store.Users",displayField:"name",valueField:"id",triggerAction:"query",queryMode:"remote",queryParam:"like",allQuery:"",lastQuery:"",queryDelay:100,minChars:0,disableKeyFilter:true,queryCaching:false,typeAhead:true,anchor:"100%",forceSelection:true,formBind:false,emptyText:"select user",listConfig:{getInnerTpl:function(a){return'<img src="../../apps/issue/resources/images/icons/USER.png"/> {'+a+"}"}}});Ext.define("Isu.util.CreatingControl",{requires:["Isu.view.workspace.issues.component.UserCombo"],createControl:function(b){var a=false;switch(b.control.xtype.toLowerCase()){case"textfield":a=Ext.isEmpty(b.suffix)?this.createTextField(b):this.suffixAppender(this.createTextField,b.suffix);break;case"numberfield":a=Ext.isEmpty(b.suffix)?this.createNumberField(b):this.suffixAppender(this.createNumberField(b),b.suffix);break;case"combobox":a=Ext.isEmpty(b.suffix)?this.createCombobox(b):this.suffixAppender(this.createCombobox(b),b.suffix);break;case"textarea":a=Ext.isEmpty(b.suffix)?this.createTextArea(b):this.suffixAppender(this.createTextArea(b),b.suffix);break;case"emaillist":a=Ext.isEmpty(b.suffix)?this.createEmailList(b):this.suffixAppender(this.createEmailList(b),b.suffix);break;case"usercombobox":a=Ext.isEmpty(b.suffix)?this.createUserCombobox(b):this.suffixAppender(this.createUserCombobox(b),b.suffix);break;case"trendperiodcontrol":a=this.createTrendPeriodControl(b);break}return a},createTextField:function(b){var a={xtype:"textfield",name:b.key,fieldLabel:b.label,allowBlank:!b.constraint.required,required:b.constraint.required,formBind:false};b.constraint.max&&(a.maxLength=b.constraint.max);b.constraint.min&&(a.minLength=b.constraint.min);b.constraint.regexp&&(a.regex=new RegExp(b.constraint.regexp));b.defaultValue&&(a.value=b.defaultValue);b.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+b.help+"</span>");b.dependOn&&(a.dependOn=b.dependOn);return a},createNumberField:function(a){var b={xtype:"numberfield",name:a.key,fieldLabel:a.label,allowBlank:!a.constraint.required,required:a.constraint.required,formBind:false};a.constraint.max&&(b.maxValue=a.constraint.max);a.constraint.min&&(b.minValue=a.constraint.min);a.defaultValue&&(b.value=a.defaultValue);a.help&&(b.afterSubTpl='<span style="color: #686868; font-style: italic">'+a.help+"</span>");a.dependOn&&(b.dependOn=a.dependOn);return b},createCombobox:function(c){var b=Ext.create("Ext.data.Store",{fields:["id","title"],data:c.defaultValues}),a={xtype:"combobox",name:c.key,fieldLabel:c.label,allowBlank:!c.constraint.required,required:c.constraint.required,store:b,queryMode:"local",displayField:"title",valueField:"id",editable:false,formBind:false};c.defaultValue&&(a.value=c.defaultValue.id);c.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+c.help+"</span>");c.dependOn&&(a.dependOn=c.dependOn);return a},createTextArea:function(a){var b={xtype:"textareafield",itemId:"emailBody",name:a.key,fieldLabel:a.label,allowBlank:!a.constraint.required,required:a.constraint.required,height:150,formBind:false};a.constraint.max&&(b.maxLength=a.constraint.max);a.constraint.min&&(b.minLength=a.constraint.min);a.constraint.regexp&&(b.regex=new RegExp(a.constraint.regexp));a.defaultValue&&(b.value=a.defaultValue);a.help&&(b.afterSubTpl='<span style="color: #686868; font-style: italic">'+a.help+"</span>");a.dependOn&&(b.dependOn=a.dependOn);return b},createEmailList:function(b){var a={xtype:"textarea",itemId:"emailList",name:b.key,height:150,allowBlank:!b.constraint.required,required:b.constraint.required,fieldLabel:b.label,emptyText:"user@example.com",regex:/^((([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z?]{2,5}){1,25})*(\n?)*)*$/,regexText:"This field should contains one e-mail address per line",formBind:false};b.constraint.max&&(a.maxLength=b.constraint.max);b.constraint.min&&(a.minLength=b.constraint.min);b.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+b.help+"</span>");b.dependOn&&(a.dependOn=b.dependOn);return a},createUserCombobox:function(b){var a={xtype:"issues-user-combo",itemId:"userCombo",name:b.key,fieldLabel:b.label,allowBlank:!b.constraint.required,required:b.constraint.required};b.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+b.help+"</span>");b.dependOn&&(a.dependOn=b.dependOn);return a},createTrendPeriodControl:function(c){var b={xtype:"fieldcontainer",layout:"hbox",fieldLabel:c.label,name:c.key,required:c.constraint.required,items:[]},d=this.createNumberField(c),a=this.createCombobox(c.control.unitParameter);delete d.fieldLabel;delete d.required;d.width=150;d.margin="0 10 0 0";a.flex=1;b.items.push(d,a);return b},suffixAppender:function(b,a){b.columnWidth=1;return{xtype:"fieldcontainer",layout:"column",name:b.name,defaults:{labelWidth:150,anchor:"100%",validateOnChange:false,validateOnBlur:false},items:[b,{xtype:"displayfield",margin:"0 0 0 5",submitValue:false,value:a}]}}});Ext.define("Isu.view.workspace.issues.NotifySend",{extend:"Uni.view.container.ContentContainer",alias:"widget.notify-user",content:[{items:[{xtype:"panel",ui:"large",itemId:"notifyPanel"},{xtype:"form",width:"40%",defaults:{labelWidth:160,validateOnChange:false,validateOnBlur:false,anchor:"100%"},items:[{itemId:"errors",name:"errors",layout:"hbox",margin:"0 0 20 100",hidden:true,defaults:{xtype:"container",cls:"isu-error-panel"}}],buttons:[{itemId:"notifySend",action:"notifySend",ui:"action"},{text:"Cancel",action:"cancel",ui:"link",listeners:{click:{fn:function(){window.location.href="#/workspace/datacollection/issues"}}}}]}]}]});Ext.define("Isu.model.Actions",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"name",type:"text"},{name:"issueType",type:"text"},{name:"parameters",type:"auto"}],proxy:{type:"rest",url:"/api/isu/actions",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.Actions",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],model:"Isu.model.Actions",autoLoad:false,listeners:{beforeload:function(){this.getProxy().setExtraParam("issueType","datacollection")}}});Ext.define("Isu.controller.NotifySend",{extend:"Ext.app.Controller",actionId:null,issId:null,views:["workspace.issues.NotifySend"],stores:["Actions"],refs:[{ref:"notifyView",selector:"notify-user"}],mixins:["Isu.util.CreatingControl"],init:function(){this.control({"notify-user button[action=notifySend]":{click:this.submit}})},showNotifySend:function(d){var b=this,c=Ext.widget("notify-user"),a=b.getNotifyView();b.issId=d;b.getApplication().fireEvent("changecontentevent",c);b.getStore("Actions").load({callback:function(e){var f=window.location.href;if(f.match(/notify/)!==null){a.down("#notifyPanel").setTitle("Notify user");a.down("#notifySend").setText("Notify");b.notifyUser(e,a)}else{a.down("#notifyPanel").setTitle("Send to inspect");a.down("#notifySend").setText("Send to inspect");b.sendSomeone(e,a)}}})},notifyUser:function(c,a){var b=this,d;Ext.Array.each(c,function(e){if(e.data.parameters.recepients&&e.data.parameters.recepients.control.xtype==="emailList"){d=b.createControl(e.data.parameters.recepients);b.actionId=e.data.id;a.down("form").add(d)}if(e.data.parameters.emailBody&&e.data.parameters.emailBody.control.xtype==="textArea"){d=b.createControl(e.data.parameters.emailBody);a.down("form").add(d)}})},sendSomeone:function(c,a){var b=this,d;Ext.Array.each(c,function(e){if(e.data.parameters.user&&e.data.parameters.user.control.xtype==="userCombobox"){b.actionId=e.data.id;d=b.createControl(e.data.parameters.user);a.down("form").add(d)}})},trimFields:function(){var c=this,d=c.getNotifyView().down("#emailList"),e=c.getNotifyView().down("#emailBody"),b,a;if(!Ext.isEmpty(d.value)){b=Ext.util.Format.trim(d.value);d.setValue(b)}if(!Ext.isEmpty(e.value)){a=Ext.util.Format.trim(e.value);e.setValue(a)}},submit:function(){var c=this,a=c.getNotifyView(),d=a.down("form").getForm(),g={},b,f=window.location.href,e=Ext.ComponentQuery.query("notify-user panel[name=errors]")[0];if(f.match(/notify/)!==null){c.trimFields();if(d.isValid()){e.hide();g.id=c.actionId;g.parameters=d.getValues();b=Ext.create("Ext.LoadMask",{msg:"Notifying user",target:a});b.show();c.sendData(g,b)}else{c.showErrorsPanel()}}else{if(a.down("#userCombo").value!==null&&d.isValid()){g.parameters={};a.down("#userCombo").clearInvalid();e.hide();g.id=c.actionId;g.parameters.user=d.getValues().user.toString();b=Ext.create("Ext.LoadMask",{msg:"Sending data",target:a});b.show();c.sendData(g,b)}else{c.showErrorsPanel();a.down("#userCombo").markInvalid("This is a required field")}}},sendData:function(c,a){var b=this;Ext.Ajax.request({url:"/api/isu/issue/"+b.issId+"/action",method:"PUT",jsonData:c,success:function(){window.location.href="#/workspace/datacollection/issues";b.getApplication().fireEvent("acknowledge","Operation completed successfully!")},failure:function(){var e="Error",d="Operation Failed!";b.getApplication().getController("Uni.controller.Error").showError(e,d)},callback:function(){a.destroy()}})},showErrorsPanel:function(){var a=Ext.ComponentQuery.query("notify-user panel[name=errors]")[0];a.hide();a.removeAll();a.add({html:"There are errors on this page that require your attention."});a.show()}});Ext.define("Isu.view.workspace.datavalidation.Overview",{extend:"Uni.view.container.ContentContainer",alias:"widget.datavalidation-overview",requires:["Uni.view.navigation.SubMenu"],side:[{title:"overview",xtype:"menu",itemId:"sideMenu"}],content:[{ui:"large",title:Uni.I18n.translate("workspace.datavalidation.overview.title","ISE","Data validation"),flex:1}]});Ext.define("Isu.controller.DataValidation",{extend:"Ext.app.Controller",views:["Isu.view.workspace.datavalidation.Overview"],showOverview:function(){var a=Ext.widget("datavalidation-overview");this.getApplication().fireEvent("changecontentevent",a)}});Ext.define("Isu.model.User",{extend:"Ext.data.Model",requires:["Ext.data.proxy.Rest"],fields:[{name:"id",displayValue:"ID",type:"int"},{name:"type",displayValue:"Type",type:"auto"},{name:"name",displayValue:"Name",type:"auto"}],proxy:{type:"rest",url:"/api/isu/assignees/users",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.Users",{extend:"Ext.data.Store",model:"Isu.model.User",autoLoad:false});Ext.define("Isu.controller.Main",{extend:"Ext.app.Controller",requires:["Ext.window.Window","Uni.controller.Navigation","Uni.controller.Configuration","Uni.controller.history.EventBus","Uni.model.PortalItem","Uni.store.PortalItems","Uni.store.MenuItems"],controllers:["Isu.controller.history.Workspace","Isu.controller.history.Administration","Isu.controller.Issues","Isu.controller.AssignIssues","Isu.controller.CloseIssues","Isu.controller.BulkChangeIssues","Isu.controller.MessageWindow","Isu.controller.IssueAssignmentRules","Isu.controller.IssueCreationRules","Isu.controller.IssueDetail","Isu.controller.AdministrationDataCollection","Isu.controller.NotifySend","Isu.controller.DataValidation"],stores:["Isu.store.Issues","Isu.store.Users"],config:{navigationController:null,configurationController:null},refs:[{ref:"viewport",selector:"viewport"},{ref:"contentPanel",selector:"viewport > #contentPanel"}],init:function(){this.initNavigation();this.initMenu()},initMenu:function(){var e=this;var b=Ext.create("Uni.model.MenuItem",{text:"Workspace",glyph:"workspace",portal:"workspace",index:30});Uni.store.MenuItems.add(b);var c=Ext.create("Uni.model.MenuItem",{text:"Administration",glyph:"settings",portal:"administration",index:10});Uni.store.MenuItems.add(c);var i=e.getController("Uni.controller.history.Router"),g=e.getController("Isu.controller.history.Workspace"),f=e.getController("Isu.controller.history.Administration");var h=Ext.create("Uni.model.PortalItem",{title:"Data collection",portal:"workspace",route:"datacollection",items:[{text:"Overview",href:i.getRoute("workspace/datacollection").buildUrl()},{text:"Issues",href:i.getRoute("workspace/datacollection/issues").buildUrl()},{text:"My open issues",handler:function(){i.getRoute("workspace/datacollection/issues").forward();e.getController("Isu.controller.Issues").fireEvent("showIssuesAssignedOnMe")}}]});var d=Ext.create("Uni.model.PortalItem",{title:"Data validation",portal:"workspace",route:"datavalidation",items:[{text:"Overview",href:"#/workspace/datavalidation"},{text:"Issues",href:"#/workspace/datavalidation/issues"}]});var a=Ext.create("Uni.model.PortalItem",{title:"Issue management",portal:"administration",route:"issuemanagement",items:[{text:"Issue assignment rules",href:i.getRoute("administration/assignmentrules").buildUrl()},{text:"Issue creation rules",href:i.getRoute("administration/creationrules").buildUrl()}]});Uni.store.PortalItems.add(h,d,a)},initNavigation:function(){var a=this.getController("Uni.controller.Navigation"),b=this.getController("Uni.controller.Configuration");this.setNavigationController(a);this.setConfigurationController(b)}});Ext.define("Isu.model.CreationRuleAction",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"int"},{name:"type",type:"auto"},{name:"phase",type:"auto"},{name:"parameters",type:"auto"}]});Ext.define("Isu.view.administration.datacollection.issuecreationrules.ActionsList",{extend:"Ext.grid.Panel",requires:["Ext.grid.column.Template","Uni.grid.column.Action","Isu.model.CreationRuleAction"],alias:"widget.issues-creation-rules-actions-list",store:Ext.create("Ext.data.Store",{model:"Isu.model.CreationRuleAction"}),enableColumnHide:false,columns:{items:[{itemId:"description",header:"Description",xtype:"templatecolumn",tpl:"{type.name}",flex:1},{itemId:"phase",header:"When to perform",xtype:"templatecolumn",tpl:new Ext.XTemplate("{[this.getWhenToPerform(values.phase.uuid)]}",{getWhenToPerform:function(b){var a=Ext.getStore("Isu.store.CreationRuleActionPhases"),c=a.getById(b).get("title");return(c||"")}}),flex:1},{itemId:"action",xtype:"uni-actioncolumn",items:[{text:Uni.I18n.translate("general.remove","ISE","Remove"),action:"delete"}]}]}});Ext.define("Isu.view.administration.datacollection.issuecreationrules.Edit",{extend:"Uni.view.container.ContentContainer",requires:["Isu.view.administration.datacollection.issuecreationrules.ActionsList"],alias:"widget.issues-creation-rules-edit",content:[{name:"pageTitle",ui:"large",items:[{xtype:"form",defaults:{labelWidth:150,validateOnChange:false,validateOnBlur:false,width:700},items:[{itemId:"form-errors",xtype:"uni-form-error-message",name:"form-errors",hidden:true},{itemId:"name",xtype:"textfield",name:"name",fieldLabel:"Name",required:true,allowBlank:false,maxLength:80},{itemId:"issueType",xtype:"combobox",name:"issueType",fieldLabel:"Issue type",required:true,store:"Isu.store.IssueType",queryMode:"local",displayField:"name",valueField:"uid",allowBlank:false,editable:false},{itemId:"ruleTemplate",xtype:"combobox",name:"template",fieldLabel:"Rule template",required:true,store:"Isu.store.CreationRuleTemplate",queryMode:"local",displayField:"name",valueField:"uid",allowBlank:false,editable:false},{itemId:"templateDetails",xtype:"container",name:"templateDetails",defaults:{labelWidth:150,margin:"0 0 10 0",validateOnChange:false,validateOnBlur:false,width:700}},{itemId:"issueReason",xtype:"combobox",name:"reason",fieldLabel:"Issue reason",required:true,store:"Isu.store.IssueReason",queryMode:"local",displayField:"name",valueField:"id",allowBlank:false,editable:false},{xtype:"fieldcontainer",fieldLabel:"Due date",layout:"hbox",items:[{itemId:"dueDateTrigger",xtype:"radiogroup",name:"dueDateTrigger",formBind:false,columns:1,vertical:true,width:100,defaults:{name:"dueDate",formBind:false,submitValue:false},items:[{itemId:"noDueDate",boxLabel:"No due date",inputValue:false},{itemId:"dueIn",boxLabel:"Due in",inputValue:true}],listeners:{change:{fn:function(b,c,a){this.up("issues-creation-rules-edit").dueDateTrigger(b,c,a)}}}},{itemId:"dueDateValues",xtype:"container",name:"dueDateValues",margin:"30 0 10 0",layout:{type:"hbox"},items:[{itemId:"dueIn.number",xtype:"numberfield",name:"dueIn.number",minValue:1,width:60,margin:"0 10 0 0",listeners:{focus:{fn:function(){var a=Ext.ComponentQuery.query("issues-creation-rules-edit [boxLabel=Due in]")[0];a.setValue(true)}}}},{itemId:"dueIn.type",xtype:"combobox",name:"dueIn.type",store:"Isu.store.DueinType",queryMode:"local",displayField:"displayValue",valueField:"name",editable:false,width:100,listeners:{focus:{fn:function(){var a=Ext.ComponentQuery.query("issues-creation-rules-edit [boxLabel=Due in]")[0];a.setValue(true)}}}}]}]},{itemId:"comment",xtype:"textareafield",name:"comment",fieldLabel:"Comment",emptyText:"Provide a comment (optionally)",height:100},{xtype:"fieldcontainer",fieldLabel:"Actions",width:900,items:[{xtype:"button",itemId:"addAction",text:"Add action",action:"addAction",ui:"action",margin:"0 0 10 0"},{xtype:"issues-creation-rules-actions-list",hidden:true},{name:"noactions",html:"There are no actions added yet to this rule",hidden:true}]},{xtype:"fieldcontainer",ui:"actions",fieldLabel:"&nbsp",defaultType:"button",items:[{itemId:"ruleAction",name:"ruleAction",ui:"action",action:"save"},{itemId:"cancel",text:"Cancel",ui:"link",name:"cancel",href:"#/administration/creationrules"}]}]}]}],dueDateTrigger:function(c,e){var d=this.down("form [name=dueDateValues]"),b=this.down("form [name=dueIn.number]"),a=this.down("form [name=dueIn.type]");if(!e.dueDate){b.reset();a.setValue(a.getStore().getAt(0).get("name"))}}});Ext.define("Isu.model.IssueType",{extend:"Ext.data.Model",fields:[{name:"uid",type:"text"},{name:"name",type:"text"}],idProperty:"uid",proxy:{type:"rest",url:"/api/isu/issuetypes",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.IssueType",{extend:"Ext.data.Store",model:"Isu.model.IssueType",pageSize:10,autoLoad:false});Ext.define("Isu.model.CreationRuleTemplate",{extend:"Ext.data.Model",belongsTo:"Isu.model.CreationRule",fields:[{name:"uid",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"parameters",type:"auto"}],idProperty:"uid",proxy:{type:"rest",url:"/api/isu/rules/templates",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.CreationRuleTemplate",{extend:"Ext.data.Store",model:"Isu.model.CreationRuleTemplate",autoLoad:false,listeners:{beforeload:function(){this.getProxy().setExtraParam("issueType","datacollection")}}});Ext.define("Isu.model.DueinType",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"displayValue",type:"string"}]});Ext.define("Isu.store.DueinType",{extend:"Ext.data.Store",model:"Isu.model.DueinType",data:[{name:"days",displayValue:"day(s)"},{name:"weeks",displayValue:"week(s)"},{name:"months",displayValue:"month(s)"}]});Ext.define("Isu.store.Clipboard",{extend:"Ext.data.Store",fields:[{name:"id",type:"string"},{name:"value",type:"auto"}],set:function(b,c){var a=this.getById(b);if(a){a.set("value",c)}else{this.add({id:b,value:c})}},get:function(b){var a=this.getById(b);if(a){return a.get("value")}else{return a}},clear:function(b){var a=this.getById(b);this.remove(a)}});Ext.define("Isu.model.CreationRuleActionPhases",{extend:"Ext.data.Model",fields:[{name:"uuid",type:"string"},{name:"title",type:"string"},{name:"description",type:"string"}],idProperty:"uuid"});Ext.define("Isu.store.CreationRuleActionPhases",{extend:"Ext.data.Store",model:"Isu.model.CreationRuleActionPhases",pageSize:50,autoLoad:false,proxy:{type:"rest",url:"/api/isu/actions/phases",reader:{type:"json",root:"data"}}});Ext.define("Isu.controller.IssueCreationRulesEdit",{extend:"Ext.app.Controller",requires:[],stores:["Isu.store.CreationRule","Isu.store.IssueType","Isu.store.CreationRuleTemplate","Isu.store.DueinType","Isu.store.Clipboard","Isu.store.CreationRuleActionPhases"],views:["Isu.view.administration.datacollection.issuecreationrules.Edit","Isu.view.workspace.issues.MessagePanel"],models:["Isu.model.CreationRuleAction"],refs:[{ref:"page",selector:"issues-creation-rules-edit"},{ref:"pageTitle",selector:"issues-creation-rules-edit [name=pageTitle]"},{ref:"ruleForm",selector:"issues-creation-rules-edit form"},{ref:"ruleActionBtn",selector:"issues-creation-rules-edit button[name=ruleAction]"},{ref:"templateDetails",selector:"issues-creation-rules-edit form [name=templateDetails]"},{ref:"actionsGrid",selector:"issues-creation-rules-edit issues-creation-rules-actions-list"}],mixins:["Isu.util.IsuGrid","Isu.util.CreatingControl"],init:function(){this.control({"issues-creation-rules-edit form [name=issueType]":{change:this.setRuleTemplateCombobox},"issues-creation-rules-edit form [name=template]":{change:this.setRuleTemplate,resize:this.comboTemplateResize},"issues-creation-rules-edit":{beforedestroy:this.removeTemplateDescription},"issues-creation-rules-edit button[action=save]":{click:this.ruleSave},"issues-creation-rules-edit button[action=addAction]":{click:this.addAction},"issues-creation-rules-edit issues-creation-rules-actions-list uni-actioncolumn":{menuclick:this.chooseActionOperation}});this.on("templateloaded",this.checkDependencies,this)},showCreate:function(b){var a=Ext.widget("issues-creation-rules-edit");this.setPage(b,"create",a);this.getApplication().fireEvent("changecontentevent",a)},showEdit:function(b){var a=Ext.widget("issues-creation-rules-edit");this.setPage(b,"edit",a);this.getApplication().fireEvent("changecontentevent",a)},clearActionsStore:function(c){var b=c?c.down("issues-creation-rules-actions-list"):this.getActionsGrid(),a=b.getStore();a.removeAll()},setPage:function(a,b,d){var g=this,f=g.getRuleActionBtn(),c=this.getStore("Isu.store.Clipboard"),e=c.get("issuesCreationRuleState"),i,h;this.clearActionsStore(d);switch(b){case"edit":i=Uni.I18n.translate("administration.issueCreationRules.title.editIssueCreationRule","ISE","Edit issue creation rule");h=Uni.I18n.translate("general.save","ISE","Save");if(e){g.ruleModel=e;c.clear("issuesCreationRuleState");d.on("afterrender",function(){g.modelToForm(g.ruleModel)},g,{single:true})}else{g.getModel("Isu.model.CreationRule").load(a,{success:function(j){g.ruleModel=j;delete g.ruleModel.data.creationDate;delete g.ruleModel.data.modificationDate;if(d.isVisible()){g.modelToForm(j)}else{d.on("afterrender",function(){g.modelToForm(j)},g,{single:true})}}})}break;case"create":i=Uni.I18n.translate("administration.issueCreationRules.title.addIssueCreationRule","ISE","Add issue creation rule");h=Uni.I18n.translate("general.add","ISE","Add");if(e){g.ruleModel=e;c.clear("issuesCreationRuleState")}else{g.ruleModel=Isu.model.CreationRule.create();delete g.ruleModel.data.id;g.ruleModel.data.actions=[]}d.on("afterrender",function(){g.modelToForm(g.ruleModel)},g,{single:true});break}g.getPageTitle().title=i;f.setText(h)},setDataToModel:function(b,a){for(var c in b){a.set(c,b[c])}},modelToForm:function(h){var k=this,b=k.getRuleForm(),g=h.getData(),m=b.down("[name=name]"),c=b.down("[name=issueType]"),n=b.down("[name=template]"),a=this.getTemplateDetails(),i=b.down("[name=reason]"),f=b.down("[name=dueDateTrigger]"),l=b.down("[name=dueIn.number]"),e=b.down("[name=dueIn.type]"),d=b.down("[name=comment]"),j=k.getPage();if(h.get("template")&&h.get("template").uid){j.setLoading(true);k.on("templateloaded",function(){var q,o,p;if(g.parameters){for(o in g.parameters){q=a.down("[name="+o+"][isFormField=true]");p=g.parameters[o];q&&q.setValue(p)}}j.setLoading(false)},k,{single:true})}m.setValue(g.name);c.getStore().load(function(){c.setValue(g.issueType.uid||c.getStore().getAt(0).get("uid"));n.getStore().on("load",function(){n.setValue(g.template.uid)},k,{single:true})});i.getStore().load(function(){i.setValue(g.reason.id)});if(g.dueIn.number){f.setValue({dueDate:true});l.setValue(g.dueIn.number);e.setValue(g.dueIn.type||e.getStore().getAt(0).get("name"))}else{f.setValue({dueDate:false})}d.setValue(g.comment);k.loadActionsToForm(h.actions().getRange())},formToModel:function(g){var b=this.getRuleForm(),e=g||Isu.model.CreationRule.create(),j=b.down("[name=name]"),c=b.down("[name=issueType]"),l=b.down("[name=template]"),h=b.down("[name=reason]"),i=b.down("[name=dueIn.number]"),f=b.down("[name=dueIn.type]"),d=b.down("[name=comment]"),a=this.getTemplateDetails(),k={};e.set("name",j.getValue());e.set("issueType",{uid:c.getValue()});e.set("template",{uid:l.getValue()});e.set("reason",{id:h.getValue()});e.set("dueIn",{number:i.getValue(),type:f.getValue()});e.set("comment",d.getValue());Ext.Array.each(a.query(),function(m){if(m.isFormField&&m.submitValue){k[m.name]=m.getValue()}});e.set("parameters",k);this.loadActionsToModel(e);return e},setRuleTemplateCombobox:function(f,e){var d=this.getRuleForm(),a=d.down("[name=template]"),c=a.getStore(),b=c.getProxy();if(e){b.setExtraParam("issuetype",e);a.reset();c.load()}},setRuleTemplate:function(e,d){var b=this,f=b.getTemplateDetails(),a=e.getStore().model,c;f.removeAll();if(d){a.load(d,{success:function(g){var i=g.get("description"),h=g.get("parameters");b.addTemplateDescription(e,i);Ext.Array.each(h,function(j){c=b.createControl(j);c&&f.add(c)});b.fireEvent("templateloaded",g)}})}},addTemplateDescription:function(c,a){var b=this.getRuleForm();this.removeTemplateDescription();if(a){c.templateDescriptionIcon=Ext.widget("button",{tooltip:Uni.I18n.translate("administration.issueCreationRules.templateInfo","ISE","Template info"),iconCls:"icon-info-small",ui:"blank",itemId:"creationRuleTplHelp",floating:true,renderTo:b.getEl(),shadow:false,width:16,handler:function(){c.templateDescriptionWindow=Ext.Msg.show({title:Uni.I18n.translate("administration.issueCreationRules.templateDescription","ISE","Template description"),msg:a,buttons:Ext.MessageBox.CANCEL,buttonText:{cancel:Uni.I18n.translate("general.close","ISE","Close")},modal:true,animateTarget:c.templateDescriptionIcon})}});this.comboTemplateResize(c)}},comboTemplateResize:function(c){var b=c.getEl(),a=c.templateDescriptionIcon;a&&a.setXY([b.getX()+b.getWidth(false)+5,b.getY()+(b.getHeight(false)-a.getEl().getHeight(false))/2])},removeTemplateDescription:function(){var a=Ext.ComponentQuery.query("issues-creation-rules-edit form [name=template]")[0];if(a&&a.templateDescriptionIcon){a.templateDescriptionIcon.clearListeners();a.templateDescriptionIcon.destroy();delete a.templateDescriptionIcon}},ruleSave:function(c){var f=this,a=f.getRuleForm().getForm(),g=f.formToModel(f.ruleModel),e=f.getRuleForm().down("[name=form-errors]"),h=f.getStore("Isu.store.CreationRule"),b=f.getRuleForm().down("combobox[name=template]"),i=this.getController("Uni.controller.history.Router"),d=f.getPage();if(a.isValid()){d.setLoading("Saving...");c.setDisabled(true);e.hide();g.save({callback:function(k,j,n){var m,l;d.setLoading(false);c.setDisabled(false);if(n){switch(j.action){case"create":m=Uni.I18n.translate("administration.issueCreationRules.createSuccess.msg","ISE","Issue creation rule added");break;case"update":m=Uni.I18n.translate("administration.issueCreationRules.updateSuccess.msg","ISE","Issue creation rule updated");break}f.getApplication().fireEvent("acknowledge",m);i.getRoute("administration/creationrules").forward()}else{l=Ext.decode(j.response.responseText);if(l&&l.errors){a.markInvalid(l.errors);e.show();f.comboTemplateResize(b)}}}})}else{e.show();f.comboTemplateResize(b)}},addAction:function(){var a=this.getController("Uni.controller.history.Router"),b=this.formToModel(this.ruleModel);this.getStore("Isu.store.Clipboard").set("issuesCreationRuleState",b);a.getRoute("administration/creationrules/add/addaction").forward()},loadActionsToForm:function(e){var d=this.getActionsGrid(),c=d.getStore(),b=this.getPage().down("[name=noactions]"),a=this.getStore("Isu.store.CreationRuleActionPhases");if(e.length){a.load(function(){c.loadData(e,false);d.show();b.hide()})}else{d.hide();b.show()}},loadActionsToModel:function(a){var d=this,c=d.getActionsGrid(),b=c.getStore(),e=b.getRange();a.actions().loadData(e,false)},chooseActionOperation:function(c,b){var a=b.action,d=c.record.getId();switch(a){case"delete":this.deleteAction(d);break}},deleteAction:function(e){var c=this.getActionsGrid(),b=c.getStore(),d=b.getById(e),a=this.getPage().down("[name=noactions]");b.remove(d);if(!b.getCount()){c.hide();a.show()}},checkDependencies:function(b){var c=this,a=b?b.getId():c.getRuleForm().down("#ruleTemplate").getValue(),e=c.getTemplateDetails(),d=e.query("[isFormField=true]");Ext.Array.each(d,function(g){var f=[];if(g.dependOn){f.push(g);Ext.Array.each(g.dependOn,function(h){var i=e.down("[name="+h+"]");f.push(i);i&&i.on("blur",function(){var j={};Ext.Array.each(f,function(k){j[k.name]=k.getValue()});Ext.Ajax.request({url:" /api/isu/rules/templates/"+a+"/parameters/"+g.name,method:"PUT",jsonData:Ext.encode(j),success:function(k){var n=Ext.decode(k.responseText,true),m=c.createControl(n.data),o=e.down("[name="+m.name+"]"),l=e.query().indexOf(o);o.destroy();e.insert(l,m);c.checkDependencies()}})},c,{single:true})})}})}});Ext.define("Isu.view.administration.datacollection.issuecreationrules.EditAction",{extend:"Uni.view.container.ContentContainer",requires:[],alias:"widget.issues-creation-rules-edit-action",content:[{name:"pageTitle",ui:"large",items:[{xtype:"form",width:"75%",defaults:{labelWidth:150,validateOnChange:false,validateOnBlur:false,width:700},items:[{itemId:"form-errors",xtype:"uni-form-error-message",name:"form-errors",hidden:true},{xtype:"radiogroup",itemId:"phasesRadioGroup",name:"phasesRadioGroup",fieldLabel:"When to perform",required:true,columns:1,vertical:true},{itemId:"actionType",xtype:"combobox",name:"actionType",fieldLabel:"Action",required:true,store:"Isu.store.Actions",queryMode:"local",displayField:"name",valueField:"id",allowBlank:false,editable:false},{itemId:"actionTypeDetails",xtype:"container",name:"actionTypeDetails",defaults:{labelWidth:150,margin:"0 0 10 0",validateOnChange:false,validateOnBlur:false,width:700}}],buttons:[{itemId:"actionOperation",name:"actionOperation",ui:"action",formBind:false,action:"actionOperation"},{itemId:"cancel",text:"Cancel",action:"cancel",ui:"link",name:"cancel"}]}]}]});Ext.define("Isu.controller.IssueCreationRulesActionsEdit",{extend:"Ext.app.Controller",stores:["Isu.store.Actions","Isu.store.CreationRuleActionPhases","Isu.store.Clipboard"],views:["Isu.view.administration.datacollection.issuecreationrules.EditAction"],refs:[{ref:"page",selector:"issues-creation-rules-edit-action"},{ref:"pageTitle",selector:"issues-creation-rules-edit-action [name=pageTitle]"},{ref:"actionOperationBtn",selector:"issues-creation-rules-edit-action button[name=actionOperation]"},{ref:"actionForm",selector:"issues-creation-rules-edit-action form"},{ref:"phasesRadioGroup",selector:"issues-creation-rules-edit-action form [name=phasesRadioGroup]"},{ref:"actionTypeDetails",selector:"issues-creation-rules-edit-action form [name=actionTypeDetails]"}],models:["Isu.model.CreationRuleAction"],mixins:["Isu.util.CreatingControl"],init:function(){this.control({"issues-creation-rules-edit-action form [name=actionType]":{change:this.setActionTypeDetails},"issues-creation-rules-edit-action button[action=cancel]":{click:this.finishEdit},"issues-creation-rules-edit-action button[action=actionOperation]":{click:this.saveAction}})},showCreate:function(b){var a=Ext.widget("issues-creation-rules-edit-action");Ext.util.History.on("change",this.checkRoute,this);this.setPage(b,"create");this.getApplication().fireEvent("changecontentevent",a)},checkRoute:function(a){var c=this.getStore("Isu.store.Clipboard"),b=/administration\/creationrules\/add/,d=/administration\/creationrules\/\d+\/edit/;Ext.util.History.un("change",this.checkRoute,this);if(a.search(b)==-1&&a.search(d)==-1){c.clear("issuesCreationRuleState")}},setPage:function(a,d){var i=this,b=i.getStore("Isu.store.Actions"),g=i.getStore("Isu.store.CreationRuleActionPhases"),e=0,f,h;var c=function(){e++;if(e==2){switch(d){case"create":f=h="Add ";i.actionModel=Ext.create("Isu.model.CreationRuleAction");break}i.getPageTitle().setTitle(f+"action");i.getActionOperationBtn().setText(h)}};b.load(c);g.load(function(j){var k=i.getPhasesRadioGroup();Ext.Array.each(j,function(l,m){k.add({boxLabel:l.get("title"),name:"phase",inputValue:l.get("uuid"),afterSubTpl:'<span style="color: #686868; font-style: italic">'+l.get("description")+"</span>",checked:!m})});c()})},formToModel:function(c){var e=this.getActionForm(),b=e.down("[name=phasesRadioGroup]"),a=this.getStore("Isu.store.Actions"),g=e.down("[name=actionType]"),f=a.getById(g.getValue()),d={};c.set("type",f.getData());delete c.get("type").parameters;c.set("phase",{uuid:b.getValue().phase});Ext.Array.each(e.down("[name=actionTypeDetails]").query(),function(h){if(h.isFormField){d[h.name]=h.getValue()}});c.set("parameters",d);return c},setActionTypeDetails:function(f,e){var c=this,a=c.getStore("Isu.store.Actions"),d=a.getById(e).get("parameters"),b=c.getActionTypeDetails();b.removeAll();Ext.Object.each(d,function(g,i){var h=c.createControl(i);h&&b.add(h)})},saveAction:function(){var d=this.getStore("Isu.store.Clipboard").get("issuesCreationRuleState"),a=this.getActionForm().getForm(),b=this.getActionForm().down("[name=form-errors]"),c,e;if(d){if(a.isValid()){c=this.formToModel(this.actionModel);e=d.actions();b.hide();e.add(c);this.finishEdit()}else{b.show()}}else{this.finishEdit()}},finishEdit:function(){var a=this.getController("Uni.controller.history.Router"),b=this.getStore("Isu.store.Clipboard").get("issuesCreationRuleState");if(b){if(b.getId()){a.getRoute("administration/creationrules/edit").forward({id:b.getId()})}else{a.getRoute("administration/creationrules/add").forward()}}else{a.getRoute("administration/creationrules").forward()}}});Ext.define("Isu.Application",{name:"Isu",appProperty:"Current",extend:"Ext.app.Application",controllers:["Isu.controller.Main","Isu.controller.history.Workspace","Isu.controller.Issues","Isu.controller.AssignIssues","Isu.controller.CloseIssues","Isu.controller.BulkChangeIssues","Isu.controller.MessageWindow","Isu.controller.IssueAssignmentRules","Isu.controller.IssueCreationRules","Isu.controller.IssueCreationRulesEdit","Isu.controller.IssueCreationRulesActionsEdit","Isu.controller.history.Workspace","Isu.controller.IssueDetail","Isu.controller.history.Administration","Isu.controller.AdministrationDataCollection","Isu.controller.NotifySend"],init:function(){this.callParent(arguments)},launch:function(){Ext.fly("appLoadingWrapper").destroy();this.callParent(arguments)}});Ext.define("Isu.view.workspace.datacollection.Overview",{extend:"Uni.view.container.ContentContainer",alias:"widget.datacollection-overview",requires:["Uni.view.navigation.SubMenu"],side:[{title:"overview",xtype:"menu",itemId:"sideMenu"}],content:[{ui:"large",title:Uni.I18n.translate("issue.workspace.datacollection","ISE","Data collection"),flex:1}]});Ext.define("Isu.controller.DataCollectionOverview",{extend:"Ext.app.Controller",requires:[],views:["workspace.datacollection.Overview"],init:function(){},showOverview:function(){var a=Ext.widget("datacollection-overview");this.getApplication().fireEvent("changecontentevent",a)}});Ext.define("Isu.model.BulkIssues",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"version",type:"string"}]});var getPath=Ext.Loader.getPath;Ext.define("Isu.override.LoaderOverride",{override:"Ext.Loader",basePath:"",setBasePath:function(a){this.basePath=a},getBasePath:function(){return this.basePath},getPath:function(a){var b=getPath(a);if(b[0]==="/"&&this.getBasePath()){b=this.getBasePath()+b}return b}});Ext.define("Isu.util.Config",{urls:["resources/config/application.json","resources/config/application.local.json"],requires:["Ext.Ajax"],load:function(a){_.each(a,function(c,b){var d=Ext.decode(b);if(d){Ext.override(d,c)}})},onReady:function(b){var a=this;Ext.Ajax.request({url:"resources/config/application.local.json",success:function(c,e){if(c.responseText){var d=Ext.decode(c.responseText);a.load(d)}b()},failure:function(c,d){b()}})}});Ext.define("Isu.util.IssueHydrator",{extend:"Uni.util.Hydrator",extract:function(){var b=this,c=b.callParent(arguments),a;if(c.assignee){a=c.assignee.split(":");c.assigneeId=a[0];c.assigneeType=a[1];delete c.assignee}delete c.id;return c},hydrate:function(e,c){var d=this,b={},f,a;f=Ext.Array.findBy(e,function(g){return g.property==="assigneeId"});a=Ext.Array.findBy(e,function(g){return g.property==="assigneeType"});if(f&&a){b.property="assignee";b.value=f.value+":"+a.value;e.push(b);Ext.Array.remove(e,f);Ext.Array.remove(e,a)}d.callParent([e,c]);return c}});Ext.define("Isu.view.Viewport",{extend:"Uni.view.Viewport",overflowY:true});Ext.define("Isu.view.ext.button.ItemAction",{extend:"Ext.button.Button",text:"Actions",iconCls:"x-uni-action-iconD",alias:"widget.item-action",menuAlign:"tr-br?",handler:function(){this.showMenu()}});Ext.define("Isu.view.workspace.issues.Browse",{itemId:"Panel",extend:"Ext.panel.Panel",alias:"widget.issues-browse",ui:"large",title:"Issues",items:[{itemId:"issues-filter",xtype:"issues-filter"},{itemId:"issues-no-group",xtype:"issue-no-group"},{itemId:"issues-list",xtype:"issues-list"},{itemId:"noIssues",name:"noIssues",hidden:true},{itemId:"issues-item",xtype:"issues-item"}]});Ext.define("Isu.view.workspace.issues.DataCollectionPreviewForm",{extend:"Ext.form.Panel",requires:["Uni.form.field.FilterDisplay"],alias:"widget.datacollection-issue-form",layout:"column",defaults:{xtype:"container",layout:"form",columnWidth:0.5},ui:"medium",showFilters:false,router:null,initComponent:function(){var a=this,b;if(a.showFilters){b="filter-display"}else{b="displayfield"}a.items=[{defaults:{xtype:"displayfield",labelWidth:200},items:[{xtype:b,itemId:"reason",fieldLabel:Uni.I18n.translate("general.title.reason","ISE","Reason"),name:"reason",renderer:function(c){return c.name?c.name:""}},{itemId:"_customer",fieldLabel:Uni.I18n.translate("general.title.customer","ISE","Customer"),name:"customer"},{itemId:"_location",fieldLabel:Uni.I18n.translate("general.title.location","ISE","Location"),name:"service_location"},{itemId:"_usagepoint",fieldLabel:Uni.I18n.translate("general.title.usagePoint","ISE","Usage point"),name:"usage_point"},{xtype:b,itemId:"device",fieldLabel:Uni.I18n.translate("general.title.device","ISE","Device"),name:"device",renderer:function(e){var d="",c="";if(e){if(e.serialNumber){d=a.router.getRoute("devices/device").buildUrl({mRID:e.serialNumber});c='<a href="'+d+'">'+e.name+" "+e.serialNumber+"</a>"}else{c=e.name+" "+e.serialNumber}}return c}}]},{defaults:{xtype:"displayfield",labelWidth:200},items:[{xtype:b,itemId:"status",fieldLabel:Uni.I18n.translate("general.title.status","ISE","Status"),name:"status",renderer:function(c){return c.name?c.name:""}},{itemId:"_dueDate",fieldLabel:Uni.I18n.translate("general.title.dueDate","ISE","Due date"),name:"dueDate",renderer:Ext.util.Format.dateRenderer("M d, Y")},{xtype:b,itemId:"assignee",fieldLabel:Uni.I18n.translate("general.title.assignee","ISE","Assignee"),name:"assignee",renderer:function(c){return c.name?c.name:Uni.I18n.translate("general.none","ISE","None")}},{itemId:"_creationDate",fieldLabel:Uni.I18n.translate("general.title.creationDate","ISE","Creation date"),name:"creationDate",renderer:Ext.util.Format.dateRenderer("M d, Y H:i")},{itemId:"_serviceCat",fieldLabel:Uni.I18n.translate("general.title.serviceCategory","ISE","Service category"),name:"service_category"}]}];a.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.DataValidationPreviewForm",{extend:"Ext.form.Panel",requires:["Uni.form.field.FilterDisplay"],alias:"widget.datavalidation-issue-form",ui:"medium",showFilters:false,router:null,initComponent:function(){var a=this,b;if(a.showFilters){b="filter-display"}else{b="displayfield"}a.items=[{xtype:"container",layout:"column",defaults:{xtype:"container",layout:"form",columnWidth:0.5},items:[{defaults:{xtype:"displayfield",labelWidth:200},items:[{xtype:b,itemId:"reason",fieldLabel:Uni.I18n.translate("general.title.reason","ISE","Reason"),name:"reason",renderer:function(c){return c.name?c.name:""}},{itemId:"_customer",fieldLabel:Uni.I18n.translate("general.title.customer","ISE","Customer"),name:"customer"},{itemId:"_location",fieldLabel:Uni.I18n.translate("general.title.location","ISE","Location"),name:"service_location"},{itemId:"_usagepoint",fieldLabel:Uni.I18n.translate("general.title.usagePoint","ISE","Usage point"),name:"usage_point"},{xtype:b,itemId:"device",fieldLabel:Uni.I18n.translate("general.title.device","ISE","Device"),name:"device",renderer:function(e){var d="",c="";if(e){if(e.serialNumber){d=a.router.getRoute("devices/device").buildUrl({mRID:e.serialNumber});c='<a href="'+d+'">'+e.name+" "+e.serialNumber+"</a>"}else{c=e.name+" "+e.serialNumber}}return c}}]},{defaults:{xtype:"displayfield",labelWidth:200},items:[{xtype:b,itemId:"status",fieldLabel:Uni.I18n.translate("general.title.status","ISE","Status"),name:"status",renderer:function(c){return c.name?c.name:""}},{itemId:"_dueDate",fieldLabel:Uni.I18n.translate("general.title.dueDate","ISE","Due date"),name:"dueDate",renderer:Ext.util.Format.dateRenderer("M d, Y")},{xtype:b,itemId:"assignee",fieldLabel:Uni.I18n.translate("general.title.assignee","ISE","Assignee"),name:"assignee",renderer:function(c){return c.name?c.name:Uni.I18n.translate("general.none","ISE","None")}},{itemId:"_creationDate",fieldLabel:Uni.I18n.translate("general.title.creationDate","ISE","Creation date"),name:"creationDate",renderer:Ext.util.Format.dateRenderer("M d, Y H:i")},{itemId:"_serviceCat",fieldLabel:Uni.I18n.translate("general.title.serviceCategory","ISE","Service category"),name:"service_category"}]}]},{xtype:"container",layout:"form",margin:"20 0 0 0",defaults:{xtype:"displayfield",labelWidth:200},items:[{fieldLabel:"&nbsp;",value:"<b>"+Uni.I18n.translate("workspace.datavalidation.overview.title","ISE","Data validation")+"</b>"},{itemId:"_validationRule",fieldLabel:Uni.I18n.translate("general.title.validationRule","ISE","Validation rule"),name:"validationRule"}]}];a.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.Grid",{extend:"Ext.grid.Panel",requires:["Ext.grid.column.Date","Ext.grid.column.Template","Uni.grid.column.Action","Uni.view.toolbar.PagingTop","Uni.view.toolbar.PagingBottom","Isu.view.workspace.issues.ActionMenu"],alias:"widget.issues-grid",store:"Isu.store.Issues",issueType:null,router:null,initComponent:function(){var a=this;a.columns=[{itemId:"issues-grid-title",header:Uni.I18n.translate("general.title.title","ISE","Title"),dataIndex:"reason",flex:2,renderer:function(f,c,b){var e=b.get("device"),g=f.name+(e?" to "+e.name+" "+e.serialNumber:""),d=a.router.getRoute(a.router.currentRoute+"/view").buildUrl({id:b.getId()});return'<a href="'+d+'">'+g+"</a>"}},{itemId:"issues-grid-due-date",header:Uni.I18n.translate("general.title.dueDate","ISE","Due date"),dataIndex:"dueDate",xtype:"datecolumn",format:"M d Y",width:140},{itemId:"issues-grid-status",header:Uni.I18n.translate("general.title.status","ISE","Status"),dataIndex:"status_name",width:100},{itemId:"issues-grid-assignee",header:Uni.I18n.translate("general.title.assignee","ISE","Assignee"),xtype:"templatecolumn",tpl:'<tpl if="assignee_type"><span class="isu-icon-{assignee_type} isu-assignee-type-icon"></span></tpl> {assignee_name}',flex:1},{itemId:"action",xtype:"uni-actioncolumn",menu:{xtype:"issue-action-menu",itemId:"issue-action-menu",issueType:a.issueType}}];a.dockedItems=[{itemId:"pagingtoolbartop",xtype:"pagingtoolbartop",dock:"top",store:a.store,displayMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.displayMsg","ISE","{0} - {1} of {2} issues"),displayMoreMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.displayMoreMsg","ISE","{0} - {1} of more than {2} issues"),emptyMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.emptyMsg","ISE","There are no issues to display"),items:["->",{itemId:"bulkAction",xtype:"button",text:Uni.I18n.translate("general.title.bulkActions","ISE","Bulk action"),action:"bulkchangesissues",hrefTarget:"",href:a.router.getRoute("workspace/"+a.issueType.toLowerCase()+"/bulk").buildUrl()}]},{itemId:"pagingtoolbarbottom",xtype:"pagingtoolbarbottom",dock:"bottom",store:a.store,itemsPerPageMsg:Uni.I18n.translate("workspace.issues.pagingtoolbarbottom.itemsPerPage","ISE","Issues per page")}];a.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.Preview",{extend:"Ext.panel.Panel",alias:"widget.issues-preview",requires:["Isu.view.workspace.issues.ActionMenu","Isu.view.workspace.issues.DataCollectionPreviewForm","Isu.view.workspace.issues.DataValidationPreviewForm"],title:"",frame:true,issueType:null,router:null,initComponent:function(){var b=this,a;switch(b.issueType){case"datacollection":a="datacollection-issue-form";break;case"datavalidation":a="datavalidation-issue-form";break}b.items={xtype:a,itemId:"issues-preview-form",showFilters:true,router:b.router,bbar:{layout:{type:"vbox",align:"right"},items:{text:Uni.I18n.translate("general.title.viewDetails","ISE","View details"),itemId:"view-details-link",ui:"link",href:location.href}}};b.tools=[{xtype:"button",text:Uni.I18n.translate("general.actions","ISE","Actions"),iconCls:"x-uni-action-iconD",menu:{xtype:"issue-action-menu",itemId:"issue-action-menu",issueType:b.issueType}}];b.callParent(arguments)}});Ext.define("Isu.view.workspace.issues.TopPanel",{extend:"Ext.container.Container",requires:["Isu.view.workspace.issues.FilteringToolbar","Isu.view.workspace.issues.GroupingToolbar","Isu.view.workspace.issues.SortingToolbar","Isu.view.workspace.issues.IssueGroup","Ext.menu.Separator"],alias:"widget.issues-top-panel",items:[{xtype:"filtering-toolbar",itemId:"filtering-toolbar"},{xtype:"menuseparator"},{xtype:"grouping-toolbar",itemId:"grouping-toolbar"},{xtype:"menuseparator"},{xtype:"sorting-toolbar",itemId:"sorting-toolbar"},{xtype:"issue-group",itemId:"issue-group"}]});Ext.define("Isu.view.workspace.issues.Setup",{extend:"Uni.view.container.ContentContainer",alias:"widget.issues-setup",itemId:"issuesOverview",issueType:null,router:null,requires:["Uni.view.container.PreviewContainer","Uni.view.notifications.NoItemsFoundPanel","Uni.view.navigation.SubMenu","Isu.view.workspace.issues.SideFilter","Isu.view.workspace.issues.TopPanel","Isu.view.workspace.issues.Grid","Isu.view.workspace.issues.Preview"],side:{itemId:"navigation",xtype:"panel",ui:"medium",title:"Navigation",layout:{type:"vbox",align:"stretch"},items:[{itemId:"overview",xtype:"menu",title:"Overview",ui:"side-menu",layout:{type:"vbox",align:"stretch"},floating:false,plain:true,items:[{text:"Issues",cls:"current"}]},{itemId:"issues-side-filter",xtype:"issues-side-filter"}]},initComponent:function(){var a=this;a.content=[{xtype:"panel",ui:"large",title:Uni.I18n.translate("workspace.issues.title","ISE","Issues"),items:[{itemId:"issues-top-panel",xtype:"issues-top-panel"},{xtype:"preview-container",grid:{xtype:"issues-grid",itemId:"issues-grid",issueType:a.issueType,router:a.router},emptyComponent:{xtype:"no-items-found-panel",title:Uni.I18n.translate("workspace.issues.empty.title","ISE","No issues found"),reasons:[Uni.I18n.translate("workspace.issues.empty.list.item1","ISE","No issues have been defined yet."),Uni.I18n.translate("workspace.issues.empty.list.item2","ISE","No issues comply to the filter.")]},previewComponent:{xtype:"issues-preview",itemId:"issues-preview",issueType:a.issueType,router:a.router}}]}];a.callParent(arguments)}});