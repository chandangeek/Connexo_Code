Ext.define("Isu.view.component.UserCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.issues-user-combo",store:"Isu.store.Users",displayField:"name",valueField:"id",triggerAction:"query",queryMode:"remote",queryParam:"like",allQuery:"",lastQuery:"",queryDelay:100,minChars:0,disableKeyFilter:true,queryCaching:false,typeAhead:true,forceSelection:true,formBind:false,emptyText:"select user",listConfig:{getInnerTpl:function(a){return'<img src="../../apps/isu/resources/images/icons/USER.png"/> {'+a+"}"}}});Ext.define("Isu.view.component.AssigneeControl",{extend:"Ext.form.FieldContainer",alias:"widget.issues-assignee-control",mixins:{field:"Ext.form.field.Field"},defaults:{xtype:"container",layout:{type:"hbox"},margin:"0 0 8 0"},getValue:function(){return this.down("radiofield[checked=true]").inputValue},markInvalid:function(a){this.down("radiofield[checked=true]").nextSibling().markInvalid(a)}});Ext.define("Isu.util.CreatingControl",{requires:["Isu.view.component.UserCombo","Isu.view.component.AssigneeControl"],createControl:function(b){var a=false;switch(b.control.xtype.toLowerCase()){case"textfield":a=Ext.isEmpty(b.suffix)?this.createTextField(b):this.suffixAppender(this.createTextField,b.suffix);break;case"numberfield":a=Ext.isEmpty(b.suffix)?this.createNumberField(b):this.suffixAppender(this.createNumberField(b),b.suffix);break;case"combobox":a=Ext.isEmpty(b.suffix)?this.createCombobox(b):this.suffixAppender(this.createCombobox(b),b.suffix);break;case"textarea":a=Ext.isEmpty(b.suffix)?this.createTextArea(b):this.suffixAppender(this.createTextArea(b),b.suffix);break;case"emaillist":a=Ext.isEmpty(b.suffix)?this.createEmailList(b):this.suffixAppender(this.createEmailList(b),b.suffix);break;case"usercombobox":a=Ext.isEmpty(b.suffix)?this.createUserCombobox(b):this.suffixAppender(this.createUserCombobox(b),b.suffix);break;case"trendperiodcontrol":a=this.createTrendPeriodControl(b);break;case"checkbox":a=Ext.isEmpty(b.suffix)?this.createCheckBox(b):this.suffixAppender(this.createCheckBox(b),b.suffix);break;case"issueassignee":a=this.createIssueAssignee(b);break}return a},createTextField:function(b){var a={xtype:"textfield",name:b.key,fieldLabel:b.label,allowBlank:!b.constraint.required,required:b.constraint.required,formBind:false};b.constraint.max&&(a.maxLength=b.constraint.max);b.constraint.min&&(a.minLength=b.constraint.min);b.constraint.regexp&&(a.regex=new RegExp(b.constraint.regexp));b.defaultValue&&(a.value=b.defaultValue);b.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+b.help+"</span>");b.dependOn&&(a.dependOn=b.dependOn);return a},createNumberField:function(a){var b={xtype:"numberfield",name:a.key,fieldLabel:a.label,allowBlank:!a.constraint.required,required:a.constraint.required,formBind:false};a.constraint.max&&(b.maxValue=a.constraint.max);a.constraint.min&&(b.minValue=a.constraint.min);a.defaultValue&&(b.value=a.defaultValue);a.help&&(b.afterSubTpl='<span style="color: #686868; font-style: italic">'+a.help+"</span>");a.dependOn&&(b.dependOn=a.dependOn);return b},createCombobox:function(c){var b=Ext.create("Ext.data.Store",{fields:["id","title"],data:c.defaultValues}),a={xtype:"combobox",name:c.key,fieldLabel:c.label,allowBlank:!c.constraint.required,required:c.constraint.required,store:b,queryMode:"local",displayField:"title",valueField:"id",editable:true,forceSelection:true,formBind:false};c.defaultValue&&(a.value=c.defaultValue.id);c.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+c.help+"</span>");c.dependOn&&(a.dependOn=c.dependOn);return a},createTextArea:function(a){var b={xtype:"textareafield",itemId:"emailBody",name:a.key,fieldLabel:a.label,allowBlank:!a.constraint.required,required:a.constraint.required,height:150,formBind:false};a.constraint.max&&(b.maxLength=a.constraint.max);a.constraint.min&&(b.minLength=a.constraint.min);a.constraint.regexp&&(b.regex=new RegExp(a.constraint.regexp));a.defaultValue&&(b.value=a.defaultValue);a.help&&(b.afterSubTpl='<span style="color: #686868; font-style: italic">'+a.help+"</span>");a.dependOn&&(b.dependOn=a.dependOn);return b},createEmailList:function(b){var a={xtype:"textarea",itemId:"emailList",name:b.key,height:150,allowBlank:!b.constraint.required,required:b.constraint.required,fieldLabel:b.label,emptyText:"user@example.com",regex:/^((([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z?]{2,5}){1,25})*(\n?)*)*$/,regexText:"This field should contains one e-mail address per line",formBind:false};b.constraint.max&&(a.maxLength=b.constraint.max);b.constraint.min&&(a.minLength=b.constraint.min);b.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+b.help+"</span>");b.dependOn&&(a.dependOn=b.dependOn);return a},createUserCombobox:function(b){var a={xtype:"issues-user-combo",itemId:"userCombo",name:b.key,fieldLabel:b.label,allowBlank:!b.constraint.required,required:b.constraint.required};b.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+b.help+"</span>");b.dependOn&&(a.dependOn=b.dependOn);return a},createTrendPeriodControl:function(c){var b={xtype:"fieldcontainer",layout:"hbox",fieldLabel:c.label,name:c.key,required:c.constraint.required,items:[]},d=this.createNumberField(c),a=this.createCombobox(c.control.unitParameter);delete d.fieldLabel;delete d.required;d.width=150;d.margin="0 10 0 0";a.flex=1;b.items.push(d,a);return b},createIssueAssignee:function(d){var c=this,b={xtype:"issues-assignee-control",fieldLabel:d.label,name:d.key,required:d.constraint.required,items:[]},a=[d.control.userControl,d.control.groupControl,d.control.roleControl];Ext.Array.each(a,function(g,f){var h=c.createControl(g),e={xtype:"radiofield",name:d.key,boxLabel:g.label,inputValue:g.key,checked:f===0?true:false,width:100,listeners:{focus:{fn:function(){var i=this.nextSibling();Ext.Array.each(this.up("issues-assignee-control").query("radiofield"),function(j){j.nextSibling().allowBlank=true});i.allowBlank=false;i.focus()}}}};h.fieldLabel="";h.allowBlank=f!==0?true:false;h.listeners={focus:{fn:function(){this.previousSibling().setValue(true)}}};h.flex=1;b.items.push({items:[e,h]})});return b},createCheckBox:function(b){var a={xtype:"checkboxfield",name:b.key,fieldLabel:b.label,formBind:false};b.defaultValue&&(a.value=b.defaultValue);b.help&&(a.afterSubTpl='<span style="color: #686868; font-style: italic">'+b.help+"</span>");b.dependOn&&(a.dependOn=b.dependOn);return a},suffixAppender:function(b,a){b.columnWidth=1;return{xtype:"fieldcontainer",layout:"column",name:b.name,defaults:{labelWidth:150,anchor:"100%",validateOnChange:false,validateOnBlur:false},items:[b,{xtype:"displayfield",margin:"0 0 0 5",submitValue:false,value:a}]}}});Ext.define("Isu.view.issues.ActionView",{extend:"Uni.view.container.ContentContainer",requires:["Uni.util.FormErrorMessage"],alias:"widget.issue-action-view",router:null,initComponent:function(){var a=this;a.content=[{xtype:"form",itemId:"issue-action-view-form",title:"&nbsp;",ui:"large",defaults:{labelWidth:150,width:700},items:[{itemId:"issue-action-view-form-errors",xtype:"uni-form-error-message",hidden:true}],buttons:[{itemId:"issue-action-apply",ui:"action",text:Uni.I18n.translate("general.apply","ISU","Apply"),action:"applyAction"},{itemId:"issue-action-cancel",text:Uni.I18n.translate("general.cancel","ISU","Cancel"),ui:"link",action:"cancelAction",href:a.router.getRoute(a.router.currentRoute.replace("/action","")).buildUrl()}],updateRecord:function(b){var c=this.getForm();b=b||c._record;if(!b){return c}b.set("parameters",this.getValues());return c}}];a.callParent(arguments)}});Ext.define("Isu.controller.ApplyIssueAction",{extend:"Ext.app.Controller",views:["Isu.view.issues.ActionView"],mixins:["Isu.util.CreatingControl"],showOverview:function(c,h,a,d){var f=this,e=Ext.widget("issue-action-view",{router:f.getController("Uni.controller.history.Router"),itemId:d}),b=e.down("#issue-action-view-form"),i=f.getModel(c),g=Ext.create(c).actions().model;f.getApplication().fireEvent("changecontentevent",e);e.setLoading(true);i.load(h,{success:function(j){f.getApplication().fireEvent("issueLoad",j)}});g.getProxy().url=i.getProxy().url+"/"+h+"/actions";g.load(a,{success:function(j){f.getApplication().fireEvent("issueActionLoad",j);b.setTitle(j.get("name"));Ext.Object.each(j.get("parameters"),function(k,m){var l=f.createControl(m);l&&b.add(l)});b.loadRecord(j);e.setLoading(false)}})},applyAction:function(){var e=this,f=e.getPage(),d=e.getForm(),a=d.getForm(),c=d.down("#issue-action-view-form-errors"),b=e.getController("Uni.controller.history.Router");c.hide();a.clearInvalid();d.updateRecord();f.setLoading(true);d.getRecord().save({callback:function(h,g,j){var i=Ext.decode(g.response.responseText,true);f.setLoading(false);if(i){if(j){if(i.data.actions[0].success){e.getApplication().fireEvent("acknowledge",i.data.actions[0].message);b.getRoute(b.currentRoute.replace("/action","")).forward()}else{e.getApplication().getController("Uni.controller.Error").showError(d.getRecord().get("name"),i.data.actions[0].message)}}else{if(g.response.status===400){if(i.errors){c.show();a.markInvalid(i.errors)}}}}}})}});Ext.define("Isu.view.component.AssigneeColumn",{extend:"Ext.grid.column.Column",xtype:"isu-assignee-column",header:"",emptyText:"",renderer:function(e,c,b,f,d){var a;if(!Ext.isEmpty(e)){a="";if(e.type){a+='<span class="isu-icon-'+e.type+' isu-assignee-type-icon" data-qtip="'+Uni.I18n.translate("assignee.tooltip."+e.type,"ISU",e.type)+'"></span> '}if(e.name){a+=e.name}}return a||this.columns[d].emptyText}});Ext.define("Isu.view.assignmentrules.List",{extend:"Ext.grid.Panel",requires:["Ext.layout.container.Column","Ext.grid.column.Template","Isu.view.component.AssigneeColumn"],alias:"widget.issues-assignment-rules-list",store:"Isu.store.AssignmentRules",height:285,columns:[{header:"Description",dataIndex:"description",flex:1},{header:"Assign to",xtype:"isu-assignee-column",dataIndex:"assignee",flex:1}],initComponent:function(){var a=this;a.dockedItems=[{xtype:"pagingtoolbartop",dock:"top",store:a.store,isFullTotalCount:true,displayMsg:Uni.I18n.translate("assignmentrules.list.pagingtoolbartop.displayMsg","ISU","{2} rules"),emptyMsg:Uni.I18n.translate("assignmentrules.list.pagingtoolbartop.emptyMsg","ISU","There are no rules to display")}];a.callParent(arguments)}});Ext.define("Isu.view.assignmentrules.Overview",{extend:"Uni.view.container.ContentContainer",requires:["Uni.view.navigation.SubMenu","Isu.view.assignmentrules.List","Uni.view.container.PreviewContainer","Uni.view.notifications.NoItemsFoundPanel"],alias:"widget.issue-assignment-rules-overview",content:{itemId:"title",xtype:"panel",ui:"large",title:Uni.I18n.translate("issue.administration.assignment","ISU","Issue assignment rules"),items:{itemId:"issues-rules-list",xtype:"preview-container",grid:{xtype:"issues-assignment-rules-list"},emptyComponent:{xtype:"no-items-found-panel",title:Uni.I18n.translate("issueAssignment.empty.title","ISU","No issue assignment rules found"),reasons:[Uni.I18n.translate("issueAssignment.empty.list.item","ISU","No issue assignment rules have been defined yet.")]},previewComponent:null}}});Ext.define("Isu.model.AssignmentRule",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"assignee",type:"auto"},{name:"version",type:"int"}],proxy:{type:"rest",url:"/api/isu/rules/assign",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.AssignmentRules",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],model:"Isu.model.AssignmentRule",autoLoad:false,proxy:{type:"rest",url:"/api/isu/rules/assign",reader:{type:"json",root:"data"},pageParam:false,startParam:false,limitParam:false}});Ext.define("Isu.controller.AssignmentRules",{extend:"Ext.app.Controller",requires:[],stores:["Isu.store.AssignmentRules"],views:["Isu.view.assignmentrules.Overview"],showOverview:function(){var a=Ext.widget("issue-assignment-rules-overview");this.getApplication().fireEvent("changecontentevent",a);this.getStore("Isu.store.AssignmentRules").load()}});Ext.define("Isu.view.creationrules.EditAction",{extend:"Uni.view.container.ContentContainer",alias:"widget.issues-creation-rules-edit-action",content:[{name:"pageTitle",ui:"large",items:[{xtype:"form",width:"75%",defaults:{labelWidth:150,validateOnChange:false,validateOnBlur:false,width:700},items:[{itemId:"form-errors",xtype:"uni-form-error-message",name:"form-errors",hidden:true},{xtype:"radiogroup",itemId:"phasesRadioGroup",name:"phasesRadioGroup",fieldLabel:"When to perform",required:true,columns:1,vertical:true},{itemId:"actionType",xtype:"combobox",name:"actionType",fieldLabel:"Action",required:true,store:"Isu.store.CreationRuleActions",queryMode:"local",displayField:"name",valueField:"id",allowBlank:false,editable:false},{itemId:"actionTypeDetails",xtype:"container",name:"actionTypeDetails",defaults:{labelWidth:150,margin:"0 0 10 0",validateOnChange:false,validateOnBlur:false,width:700}}],buttons:[{itemId:"actionOperation",name:"actionOperation",ui:"action",formBind:false,action:"actionOperation"},{itemId:"cancel",text:"Cancel",action:"cancel",ui:"link",name:"cancel"}]}]}]});Ext.define("Isu.model.CreationRuleAction",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"int"},{name:"type",type:"auto"},{name:"phase",type:"auto"},{name:"parameters",type:"auto"}]});Ext.define("Isu.model.Action",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"name",type:"text"},{name:"issueType",type:"text"},{name:"parameters",type:"auto"}],proxy:{type:"rest",url:"/api/idc/actions",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.CreationRuleActions",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],model:"Isu.model.Action",autoLoad:false,proxy:{type:"rest",url:"/api/isu/actions",reader:{type:"json",root:"data"}}});Ext.define("Isu.model.CreationRuleActionPhase",{extend:"Ext.data.Model",fields:[{name:"uuid",type:"string"},{name:"title",type:"string"},{name:"description",type:"string"}],idProperty:"uuid"});Ext.define("Isu.store.CreationRuleActionPhases",{extend:"Ext.data.Store",model:"Isu.model.CreationRuleActionPhase",autoLoad:false,proxy:{type:"rest",url:"/api/isu/actions/phases",reader:{type:"json",root:"data"},pageParam:false,startParam:false,limitParam:false}});Ext.define("Isu.store.Clipboard",{extend:"Ext.data.Store",fields:[{name:"id",type:"string"},{name:"value",type:"auto"}],set:function(b,c){var a=this.getById(b);if(a){a.set("value",c)}else{this.add({id:b,value:c})}},get:function(b){var a=this.getById(b);if(a){return a.get("value")}else{return a}},clear:function(b){var a=this.getById(b);this.remove(a)}});Ext.define("Isu.model.User",{extend:"Ext.data.Model",requires:["Ext.data.proxy.Rest"],fields:[{name:"id",displayValue:"ID",type:"int"},{name:"type",displayValue:"Type",type:"auto"},{name:"name",displayValue:"Name",type:"auto"}],proxy:{type:"rest",url:"/api/isu/assignees/users",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.Users",{extend:"Ext.data.Store",model:"Isu.model.User",autoLoad:false});Ext.define("Isu.controller.CreationRuleActionEdit",{extend:"Ext.app.Controller",stores:["Isu.store.CreationRuleActions","Isu.store.CreationRuleActionPhases","Isu.store.Clipboard","Isu.store.Users"],views:["Isu.view.creationrules.EditAction"],refs:[{ref:"page",selector:"issues-creation-rules-edit-action"},{ref:"pageTitle",selector:"issues-creation-rules-edit-action [name=pageTitle]"},{ref:"actionOperationBtn",selector:"issues-creation-rules-edit-action button[name=actionOperation]"},{ref:"actionForm",selector:"issues-creation-rules-edit-action form"},{ref:"phasesRadioGroup",selector:"issues-creation-rules-edit-action form [name=phasesRadioGroup]"},{ref:"actionTypeDetails",selector:"issues-creation-rules-edit-action form [name=actionTypeDetails]"}],models:["Isu.model.CreationRuleAction"],mixins:["Isu.util.CreatingControl"],init:function(){this.control({"issues-creation-rules-edit-action form [name=actionType]":{change:this.setActionTypeDetails},"issues-creation-rules-edit-action button[action=cancel]":{click:this.finishEdit},"issues-creation-rules-edit-action button[action=actionOperation]":{click:this.saveAction}})},showCreate:function(b){var a;if(!this.getStore("Isu.store.Clipboard").get("issuesCreationRuleState")){this.getController("Uni.controller.history.Router").getRoute("administration/creationrules/add").forward();return}a=Ext.widget("issues-creation-rules-edit-action");Ext.util.History.on("change",this.checkRoute,this);this.setPage(b,"create");this.getApplication().fireEvent("changecontentevent",a);a.setLoading(true)},checkRoute:function(a){var c=this.getStore("Isu.store.Clipboard"),b=/administration\/creationrules\/add/,d=/administration\/creationrules\/\d+\/edit/;Ext.util.History.un("change",this.checkRoute,this);if(a.search(b)==-1&&a.search(d)==-1){c.clear("issuesCreationRuleState")}},setPage:function(a,d){var h=this,b=h.getStore("Isu.store.CreationRuleActions"),g=h.getStore("Isu.store.CreationRuleActionPhases"),e=0,f,i;var c=function(){e++;if(e==2){switch(d){case"create":f=i="Add ";h.actionModel=Ext.create("Isu.model.CreationRuleAction");break}h.getPageTitle().setTitle(f+"action");h.getActionOperationBtn().setText(i);h.getPage().setLoading(false)}};b.getProxy().setExtraParam("issueType",h.getStore("Isu.store.Clipboard").get("issuesCreationRuleState").get("issueType").uid);b.load(c);g.load(function(j){var k=h.getPhasesRadioGroup();Ext.Array.each(j,function(l,m){k.add({boxLabel:l.get("title"),name:"phase",inputValue:l.get("uuid"),afterSubTpl:'<span style="color: #686868; font-style: italic">'+l.get("description")+"</span>",checked:!m})});c()})},formToModel:function(c){var e=this.getActionForm(),b=e.down("[name=phasesRadioGroup]"),a=this.getStore("Isu.store.CreationRuleActions"),g=e.down("[name=actionType]"),f=a.getById(g.getValue()),d={};c.set("type",f.getData());delete c.get("type").parameters;c.set("phase",{uuid:b.getValue().phase});Ext.Array.each(e.down("[name=actionTypeDetails]").query(),function(h){if(h.isFormField){d[h.name]=h.getValue()}});c.set("parameters",d);return c},setActionTypeDetails:function(f,e){var d=this,a=d.getStore("Isu.store.CreationRuleActions"),c=a.getById(e).get("parameters"),b=d.getActionTypeDetails();b.removeAll();Ext.Object.each(c,function(g,i){var h=d.createControl(i);h&&b.add(h)})},saveAction:function(){var d=this.getStore("Isu.store.Clipboard").get("issuesCreationRuleState"),a=this.getActionForm().getForm(),b=this.getActionForm().down("[name=form-errors]"),c,e;if(d){if(a.isValid()){c=this.formToModel(this.actionModel);e=d.actions();b.hide();e.add(c);this.finishEdit()}else{b.show()}}else{this.finishEdit()}},finishEdit:function(){var a=this.getController("Uni.controller.history.Router"),b=this.getStore("Isu.store.Clipboard").get("issuesCreationRuleState");if(b){if(b.getId()){a.getRoute("administration/creationrules/edit").forward({id:b.getId()})}else{a.getRoute("administration/creationrules/add").forward()}}else{a.getRoute("administration/creationrules").forward()}}});Ext.define("Isu.view.creationrules.ActionsList",{extend:"Ext.grid.Panel",requires:["Ext.grid.column.Template","Uni.grid.column.Action","Isu.model.CreationRuleAction"],alias:"widget.issues-creation-rules-actions-list",store:Ext.create("Ext.data.Store",{model:"Isu.model.CreationRuleAction"}),enableColumnHide:false,columns:{items:[{itemId:"description",header:"Description",xtype:"templatecolumn",tpl:"{type.name}",flex:1},{itemId:"phase",header:"When to perform",xtype:"templatecolumn",tpl:new Ext.XTemplate("{[this.getWhenToPerform(values.phase.uuid)]}",{getWhenToPerform:function(b){var a=Ext.getStore("Isu.store.CreationRuleActionPhases"),c=a.getById(b).get("title");return(c||"")}}),flex:1},{itemId:"action",xtype:"uni-actioncolumn",items:[{text:Uni.I18n.translate("general.remove","ISU","Remove"),action:"delete"}]}]}});Ext.define("Isu.view.creationrules.Edit",{extend:"Uni.view.container.ContentContainer",requires:["Isu.view.creationrules.ActionsList","Uni.util.FormErrorMessage"],alias:"widget.issues-creation-rules-edit",content:[{name:"pageTitle",ui:"large",items:[{xtype:"form",defaults:{labelWidth:150,validateOnChange:false,validateOnBlur:false,width:700},items:[{itemId:"form-errors",xtype:"uni-form-error-message",name:"form-errors",hidden:true},{itemId:"name",xtype:"textfield",name:"name",fieldLabel:"Name",required:true,allowBlank:false,maxLength:80},{itemId:"issueType",xtype:"combobox",name:"issueType",fieldLabel:"Issue type",required:true,store:"Isu.store.IssueTypes",queryMode:"local",displayField:"name",valueField:"uid",allowBlank:false,editable:false},{itemId:"ruleTemplate",xtype:"combobox",name:"template",fieldLabel:"Rule template",required:true,store:"Isu.store.CreationRuleTemplates",queryMode:"local",displayField:"name",valueField:"uid",allowBlank:false,editable:false},{itemId:"templateDetails",xtype:"container",name:"templateDetails",defaults:{labelWidth:150,margin:"0 0 10 0",validateOnChange:false,validateOnBlur:false,width:700}},{itemId:"issueReason",xtype:"combobox",name:"reason",fieldLabel:"Issue reason",required:true,store:"Isu.store.IssueReasons",queryMode:"local",displayField:"name",valueField:"id",allowBlank:false,editable:false},{xtype:"fieldcontainer",fieldLabel:"Due date",layout:"hbox",items:[{itemId:"dueDateTrigger",xtype:"radiogroup",name:"dueDateTrigger",formBind:false,columns:1,vertical:true,width:100,defaults:{name:"dueDate",formBind:false,submitValue:false},items:[{itemId:"noDueDate",boxLabel:"No due date",inputValue:false},{itemId:"dueIn",boxLabel:"Due in",inputValue:true}],listeners:{change:{fn:function(b,c,a){this.up("issues-creation-rules-edit").dueDateTrigger(b,c,a)}}}},{itemId:"dueDateValues",xtype:"container",name:"dueDateValues",margin:"30 0 10 0",layout:{type:"hbox"},items:[{itemId:"dueIn.number",xtype:"numberfield",name:"dueIn.number",minValue:1,width:60,margin:"0 10 0 0",listeners:{focus:{fn:function(){var a=Ext.ComponentQuery.query("issues-creation-rules-edit [boxLabel=Due in]")[0];a.setValue(true)}}}},{itemId:"dueIn.type",xtype:"combobox",name:"dueIn.type",store:"Isu.store.DueinTypes",queryMode:"local",displayField:"displayValue",valueField:"name",editable:false,width:100,listeners:{focus:{fn:function(){var a=Ext.ComponentQuery.query("issues-creation-rules-edit [boxLabel=Due in]")[0];a.setValue(true)}}}}]}]},{itemId:"comment",xtype:"textareafield",name:"comment",fieldLabel:"Comment",emptyText:"Provide a comment (optionally)",height:100},{xtype:"fieldcontainer",fieldLabel:"Actions",width:900,items:[{xtype:"button",itemId:"addAction",text:"Add action",action:"addAction",margin:"0 0 10 0"},{xtype:"issues-creation-rules-actions-list",hidden:true},{name:"noactions",html:"There are no actions added yet to this rule",hidden:true}]},{xtype:"fieldcontainer",ui:"actions",fieldLabel:"&nbsp",defaultType:"button",items:[{itemId:"ruleAction",name:"ruleAction",ui:"action",action:"save"},{itemId:"cancel",text:"Cancel",ui:"link",name:"cancel",href:"#/administration/creationrules"}]}]}]}],dueDateTrigger:function(c,e){var d=this.down("form [name=dueDateValues]"),b=this.down("form [name=dueIn.number]"),a=this.down("form [name=dueIn.type]");if(!e.dueDate){b.reset();a.setValue(a.getStore().getAt(0).get("name"))}}});Ext.define("Isu.model.CreationRule",{extend:"Ext.data.Model",requires:["Isu.model.CreationRuleAction"],idProperty:"id",fields:[{name:"id",type:"int"},{name:"name",type:"string"},{name:"parameters",type:"auto"},{name:"comment",type:"string"},{name:"creationDate",dateFormat:"time",type:"date"},{name:"modificationDate",dateFormat:"time",type:"date"},{name:"version",type:"int"},{name:"template",type:"auto"},{name:"issueType",type:"auto"},{name:"reason",type:"auto"},{name:"dueIn",type:"auto"},{name:"title",mapping:"name"},{name:"issueType_name",mapping:"issueType.name"},{name:"reason_name",mapping:"reason.name"},{name:"template_name",mapping:"template.name"},{name:"due_in",mapping:function(b){var a="";if(b.dueIn&&b.dueIn.number){a=b.dueIn.number+" "+b.dueIn.type}return a}}],associations:[{name:"actions",type:"hasMany",model:"Isu.model.CreationRuleAction",associationKey:"actions"}],proxy:{type:"rest",url:"/api/isu/creationrules",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.CreationRules",{extend:"Ext.data.Store",model:"Isu.model.CreationRule",pageSize:10,autoLoad:false});Ext.define("Isu.model.IssueType",{extend:"Ext.data.Model",fields:[{name:"uid",type:"text"},{name:"name",type:"text"}],idProperty:"uid",proxy:{type:"rest",url:"/api/isu/issuetypes",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.IssueTypes",{extend:"Ext.data.Store",model:"Isu.model.IssueType",pageSize:10,autoLoad:false});Ext.define("Isu.model.CreationRuleTemplate",{extend:"Ext.data.Model",requires:["Isu.model.CreationRule"],belongsTo:"Isu.model.CreationRule",fields:[{name:"uid",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"parameters",type:"auto"}],idProperty:"uid",proxy:{type:"rest",url:"/api/isu/rules/templates",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.CreationRuleTemplates",{extend:"Ext.data.Store",model:"Isu.model.CreationRuleTemplate",autoLoad:false,proxy:{type:"rest",url:"/api/isu/rules/templates",reader:{type:"json",root:"data"},pageParam:false,startParam:false,limitParam:false}});Ext.define("Isu.model.DueinType",{extend:"Ext.data.Model",fields:[{name:"name",type:"string"},{name:"displayValue",type:"string"}]});Ext.define("Isu.store.DueinTypes",{extend:"Ext.data.Store",model:"Isu.model.DueinType",data:[{name:"days",displayValue:"day(s)"},{name:"weeks",displayValue:"week(s)"},{name:"months",displayValue:"month(s)"}]});Ext.define("Isu.model.IssueReason",{extend:"Ext.data.Model",requires:["Ext.data.proxy.Rest"],fields:[{name:"id",type:"auto"},{name:"name",type:"string"}],proxy:{type:"rest",url:"/api/isu/reasons",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.IssueReasons",{extend:"Ext.data.Store",model:"Isu.model.IssueReason",autoLoad:false});Ext.define("Isu.controller.CreationRuleEdit",{extend:"Ext.app.Controller",requires:[],stores:["Isu.store.CreationRules","Isu.store.IssueTypes","Isu.store.CreationRuleTemplates","Isu.store.DueinTypes","Isu.store.Clipboard","Isu.store.CreationRuleActionPhases","Isu.store.IssueReasons"],views:["Isu.view.creationrules.Edit"],models:["Isu.model.CreationRuleAction"],refs:[{ref:"page",selector:"issues-creation-rules-edit"},{ref:"pageTitle",selector:"issues-creation-rules-edit [name=pageTitle]"},{ref:"ruleForm",selector:"issues-creation-rules-edit form"},{ref:"ruleActionBtn",selector:"issues-creation-rules-edit button[name=ruleAction]"},{ref:"templateDetails",selector:"issues-creation-rules-edit form [name=templateDetails]"},{ref:"actionsGrid",selector:"issues-creation-rules-edit issues-creation-rules-actions-list"}],mixins:["Isu.util.CreatingControl"],init:function(){this.control({"issues-creation-rules-edit form [name=issueType]":{change:this.setRuleTemplateCombobox},"issues-creation-rules-edit form [name=template]":{change:this.setRuleTemplate,resize:this.comboTemplateResize},"issues-creation-rules-edit":{beforedestroy:this.removeTemplateDescription},"issues-creation-rules-edit button[action=save]":{click:this.ruleSave},"issues-creation-rules-edit button[action=addAction]":{click:this.addAction},"issues-creation-rules-edit issues-creation-rules-actions-list uni-actioncolumn":{menuclick:this.chooseActionOperation}});this.on("templateloaded",this.checkDependencies,this)},showCreate:function(b){var a=Ext.widget("issues-creation-rules-edit");this.setPage(b,"create",a);this.getApplication().fireEvent("changecontentevent",a)},showEdit:function(b){var a=Ext.widget("issues-creation-rules-edit");this.setPage(b,"edit",a);this.getApplication().fireEvent("changecontentevent",a)},clearActionsStore:function(c){var b=c?c.down("issues-creation-rules-actions-list"):this.getActionsGrid(),a=b.getStore();a.removeAll()},setPage:function(a,b,d){var g=this,f=g.getRuleActionBtn(),c=this.getStore("Isu.store.Clipboard"),e=c.get("issuesCreationRuleState"),i,h;this.clearActionsStore(d);switch(b){case"edit":i=Uni.I18n.translate("administration.issueCreationRules.title.editIssueCreationRule","ISU","Edit issue creation rule");h=Uni.I18n.translate("general.save","ISU","Save");if(e){g.ruleModel=e;c.clear("issuesCreationRuleState");d.on("afterrender",function(){g.modelToForm(g.ruleModel)},g,{single:true})}else{g.getModel("Isu.model.CreationRule").load(a,{success:function(j){g.ruleModel=j;delete g.ruleModel.data.creationDate;delete g.ruleModel.data.modificationDate;if(d.isVisible()){g.modelToForm(j)}else{d.on("afterrender",function(){g.modelToForm(j)},g,{single:true})}}})}break;case"create":i=Uni.I18n.translate("administration.issueCreationRules.title.addIssueCreationRule","ISU","Add issue creation rule");h=Uni.I18n.translate("general.add","ISU","Add");if(e){g.ruleModel=e;c.clear("issuesCreationRuleState")}else{g.ruleModel=Isu.model.CreationRule.create();delete g.ruleModel.data.id;g.ruleModel.data.actions=[]}d.on("afterrender",function(){g.modelToForm(g.ruleModel)},g,{single:true});break}g.getPageTitle().title=i;f.setText(h)},setDataToModel:function(b,a){for(var c in b){a.set(c,b[c])}},modelToForm:function(h){var k=this,b=k.getRuleForm(),g=h.getData(),m=b.down("[name=name]"),c=b.down("[name=issueType]"),n=b.down("[name=template]"),a=this.getTemplateDetails(),i=b.down("[name=reason]"),f=b.down("[name=dueDateTrigger]"),l=b.down("[name=dueIn.number]"),e=b.down("[name=dueIn.type]"),d=b.down("[name=comment]"),j=k.getPage();if(h.get("template")&&h.get("template").uid){j.setLoading(true);k.on("templateloaded",function(){var q,o,p;if(g.parameters){for(o in g.parameters){q=a.down("[name="+o+"][isFormField=true]");p=g.parameters[o];q&&q.setValue(p)}}},k,{single:true})}m.setValue(g.name);c.getStore().load(function(){c.setValue(g.issueType.uid||c.getStore().getAt(0).get("uid"));i.getStore().getProxy().setExtraParam("issueType",c.getValue());j.setLoading(true);i.getStore().load(function(){j.setLoading(false);if(!i.isDestroyed){i.setValue(g.reason.id)}});n.getStore().on("load",function(){n.setValue(g.template.uid)},k,{single:true})});if(g.dueIn.number){f.setValue({dueDate:true});l.setValue(g.dueIn.number);e.setValue(g.dueIn.type||e.getStore().getAt(0).get("name"))}else{f.setValue({dueDate:false})}d.setValue(g.comment);k.loadActionsToForm(h.actions().getRange())},formToModel:function(g){var b=this.getRuleForm(),e=g||Isu.model.CreationRule.create(),j=b.down("[name=name]"),c=b.down("[name=issueType]"),l=b.down("[name=template]"),h=b.down("[name=reason]"),i=b.down("[name=dueIn.number]"),f=b.down("[name=dueIn.type]"),d=b.down("[name=comment]"),a=this.getTemplateDetails(),k={};e.set("name",j.getValue());e.set("issueType",{uid:c.getValue()});e.set("template",{uid:l.getValue()});e.set("reason",{id:h.getValue()});e.set("dueIn",{number:i.getValue(),type:f.getValue()});e.set("comment",d.getValue());Ext.Array.each(a.query(),function(m){if(m.isFormField&&m.submitValue){k[m.name]=m.getValue()}});e.set("parameters",k);this.loadActionsToModel(e);return e},setRuleTemplateCombobox:function(d,a){var b=this.getRuleForm(),h=b.down("[name=template]"),i=h.getStore(),c=i.getProxy(),e=b.down("[name=reason]"),f=e.getStore(),g=f.getProxy();c.setExtraParam("issueType",a);h.reset();i.load();g.setExtraParam("issueType",a);e.reset();f.load()},setRuleTemplate:function(e,d){var b=this,f=b.getTemplateDetails(),a=e.getStore().model,c;f.removeAll();if(d){a.load(d,{success:function(g){var i=g.get("description"),h=g.get("parameters");b.addTemplateDescription(e,i);Ext.Array.each(h,function(j){c=b.createControl(j);c&&f.add(c)});b.fireEvent("templateloaded",g)}})}},addTemplateDescription:function(c,a){var b=this.getRuleForm();this.removeTemplateDescription();if(a){c.templateDescriptionIcon=Ext.widget("button",{tooltip:Uni.I18n.translate("administration.issueCreationRules.templateInfo","ISU","Template info"),iconCls:"icon-info-small",ui:"blank",itemId:"creationRuleTplHelp",floating:true,renderTo:b.getEl(),shadow:false,width:16,handler:function(){c.templateDescriptionWindow=Ext.Msg.show({title:Uni.I18n.translate("administration.issueCreationRules.templateDescription","ISU","Template description"),msg:a,buttons:Ext.MessageBox.CANCEL,buttonText:{cancel:Uni.I18n.translate("general.close","ISU","Close")},modal:true,animateTarget:c.templateDescriptionIcon})}});this.comboTemplateResize(c)}},comboTemplateResize:function(c){var b=c.getEl(),a=c.templateDescriptionIcon;a&&a.setXY([b.getX()+b.getWidth(false)+5,b.getY()+(b.getHeight(false)-a.getEl().getHeight(false))/2])},removeTemplateDescription:function(){var a=Ext.ComponentQuery.query("issues-creation-rules-edit form [name=template]")[0];if(a&&a.templateDescriptionIcon){a.templateDescriptionIcon.clearListeners();a.templateDescriptionIcon.destroy();delete a.templateDescriptionIcon}},ruleSave:function(c){var f=this,a=f.getRuleForm().getForm(),g=f.formToModel(f.ruleModel),e=f.getRuleForm().down("[name=form-errors]"),h=f.getStore("Isu.store.CreationRules"),b=f.getRuleForm().down("combobox[name=template]"),i=this.getController("Uni.controller.history.Router"),d=f.getPage();if(a.isValid()){d.setLoading("Saving...");c.setDisabled(true);e.hide();g.save({callback:function(k,j,n){var m,l;d.setLoading(false);c.setDisabled(false);if(n){switch(j.action){case"create":m=Uni.I18n.translate("administration.issueCreationRules.createSuccess.msg","ISU","Issue creation rule added");break;case"update":m=Uni.I18n.translate("administration.issueCreationRules.updateSuccess.msg","ISU","Issue creation rule updated");break}f.getApplication().fireEvent("acknowledge",m);i.getRoute("administration/creationrules").forward()}else{l=Ext.decode(j.response.responseText);if(l&&l.errors){a.markInvalid(l.errors);e.show();f.comboTemplateResize(b)}}}})}else{e.show();f.comboTemplateResize(b)}},addAction:function(){var a=this.getController("Uni.controller.history.Router"),b=this.formToModel(this.ruleModel);this.getStore("Isu.store.Clipboard").set("issuesCreationRuleState",b);a.getRoute("administration/creationrules/add/addaction").forward()},loadActionsToForm:function(e){var d=this.getActionsGrid(),c=d.getStore(),b=this.getPage().down("[name=noactions]"),a=this.getStore("Isu.store.CreationRuleActionPhases");if(e.length){a.load(function(){c.loadData(e,false);d.show();b.hide()})}else{d.hide();b.show()}},loadActionsToModel:function(a){var d=this,c=d.getActionsGrid(),b=c.getStore(),e=b.getRange();a.actions().loadData(e,false)},chooseActionOperation:function(c,b){var a=b.action,d=c.record.getId();switch(a){case"delete":this.deleteAction(d);break}},deleteAction:function(e){var c=this.getActionsGrid(),b=c.getStore(),d=b.getById(e),a=this.getPage().down("[name=noactions]");b.remove(d);if(!b.getCount()){c.hide();a.show()}},checkDependencies:function(b){var c=this,a=b?b.getId():c.getRuleForm().down("#ruleTemplate").getValue(),e=c.getTemplateDetails(),d=e.query("[isFormField=true]");Ext.Array.each(d,function(g){var f=[];if(g.dependOn){f.push(g);Ext.Array.each(g.dependOn,function(h){var i=e.down("[name="+h+"]");f.push(i);i&&i.on("blur",function(){var j={};Ext.Array.each(f,function(k){j[k.name]=k.getValue()});Ext.Ajax.request({url:" /api/isu/rules/templates/"+a+"/parameters/"+g.name,method:"PUT",jsonData:Ext.encode(j),success:function(k){var n=Ext.decode(k.responseText,true),m=c.createControl(n.data),o=e.down("[name="+m.name+"]"),l=e.query().indexOf(o);o.destroy();e.insert(l,m);c.checkDependencies()}})},c,{single:true})})}})}});Ext.define("Isu.view.creationrules.List",{extend:"Ext.grid.Panel",requires:["Ext.layout.container.Column","Ext.grid.column.Template","Uni.grid.column.Action","Uni.view.toolbar.PagingTop","Uni.view.toolbar.PagingBottom"],alias:"widget.issues-creation-rules-list",store:"Isu.store.CreationRules",columns:{items:[{itemId:"Name",header:Uni.I18n.translate("general.title.name","ISU","Name"),dataIndex:"name",flex:1},{itemId:"templateColumn",header:Uni.I18n.translate("general.title.ruleTemplate","ISU","Rule template"),xtype:"templatecolumn",tpl:'<tpl if="template">{template.name}</tpl>',flex:1},{itemId:"issueType",header:Uni.I18n.translate("general.title.issueType","ISU","Issue type"),xtype:"templatecolumn",tpl:'<tpl if="issueType">{issueType.name}</tpl>',flex:1},{itemId:"action",xtype:"uni-actioncolumn",hidden:Uni.Auth.hasNoPrivilege("privilege.administrate.creationRule"),items:"Isu.view.creationrules.ActionMenu"}]},initComponent:function(){var a=this;a.dockedItems=[{itemId:"pagingtoolbartop",xtype:"pagingtoolbartop",store:a.store,dock:"top",displayMsg:Uni.I18n.translate("administration.issueCreationRules.pagingtoolbartop.displayMsg","ISU","{0} - {1} of {2} issue creation rules"),displayMoreMsg:Uni.I18n.translate("administration.issueCreationRules.pagingtoolbartop.displayMoreMsg","ISU","{0} - {1} of more than {2} issue creation rules"),emptyMsg:Uni.I18n.translate("administration.issueCreationRules.pagingtoolbartop.emptyMsg","ISU","There are no issue creation rules to display"),items:["->",{itemId:"createRule",xtype:"button",text:Uni.I18n.translate("administration.issueCreationRules.add","ISU","Add rule"),hidden:Uni.Auth.hasNoPrivilege("privilege.administrate.creationRule"),href:"#/administration/creationrules/add",action:"create"}]},{itemId:"pagingtoolbarbottom",xtype:"pagingtoolbarbottom",store:a.store,dock:"bottom",itemsPerPageMsg:Uni.I18n.translate("administration.issueCreationRules.pagingtoolbarbottom.itemsPerPage","ISU","Issue creation rules per page")}];this.callParent(arguments)}});Ext.define("Isu.view.creationrules.ActionMenu",{extend:"Ext.menu.Menu",alias:"widget.creation-rule-action-menu",plain:true,border:false,shadow:false,items:[{itemId:"edit",text:"Edit",action:"edit"},{itemId:"delete",text:"Delete",action:"delete"}]});Ext.define("Isu.view.creationrules.Item",{extend:"Ext.panel.Panel",requires:["Isu.view.creationrules.ActionMenu"],alias:"widget.issue-creation-rules-item",title:"Details",itemId:"issue-creation-rules-item",frame:true,tools:[{xtype:"button",text:Uni.I18n.translate("general.actions","ISU","Actions"),hidden:Uni.Auth.hasNoPrivilege("privilege.administrate.creationRule"),iconCls:"x-uni-action-iconD",menu:{xtype:"creation-rule-action-menu"}}],items:{xtype:"form",layout:"column",defaults:{xtype:"container",layout:"form",columnWidth:0.5},items:[{defaults:{xtype:"displayfield",labelWidth:200},items:[{fieldLabel:Uni.I18n.translate("general.title.name","ISU","Name"),name:"name"},{fieldLabel:Uni.I18n.translate("general.title.ruleTemplate","ISU","Rule template"),name:"template_name"},{fieldLabel:Uni.I18n.translate("general.title.issueType","ISU","Issue type"),name:"issueType_name"},{fieldLabel:Uni.I18n.translate("general.title.issueReason","ISU","Issue reason"),name:"reason_name"},{fieldLabel:Uni.I18n.translate("general.title.dueIn","ISU","Due in"),name:"due_in"}]},{defaults:{xtype:"displayfield",labelWidth:200},items:[{fieldLabel:Uni.I18n.translate("general.title.created","ISU","Created"),name:"creationDate",renderer:Ext.util.Format.dateRenderer("M d, Y H:i")},{fieldLabel:Uni.I18n.translate("general.title.lastModified","ISU","Last modified"),name:"modificationDate",renderer:Ext.util.Format.dateRenderer("M d, Y H:i")}]}]}});Ext.define("Isu.view.creationrules.Overview",{extend:"Uni.view.container.ContentContainer",alias:"widget.issue-creation-rules-overview",itemId:"creation-rules-overview",requires:["Isu.view.creationrules.List","Isu.view.creationrules.Item","Uni.view.container.PreviewContainer","Uni.view.notifications.NoItemsFoundPanel"],content:[{xtype:"panel",ui:"large",title:Uni.I18n.translate("administration.issueCreationRules.title","ISU","Issue creation rules"),items:[{xtype:"preview-container",grid:{itemId:"creation-rules-list",xtype:"issues-creation-rules-list"},emptyComponent:{xtype:"no-items-found-panel",title:Uni.I18n.translate("administration.issueCreationRules.empty.title","ISU","No issue creation rules found"),reasons:[Uni.I18n.translate("administration.issueCreationRules.empty.list.item1","ISU","No issue creation rules have been defined yet."),Uni.I18n.translate("administration.issueCreationRules.empty.list.item2","ISU","No issue creation rules comply to the filter.")],stepItems:[{itemId:"createRule",text:Uni.I18n.translate("administration.issueCreationRules.add","ISU","Add rule"),privileges:["privilege.administrate.creationRule"],href:"#/administration/creationrules/add",action:"create"}]},previewComponent:{xtype:"issue-creation-rules-item"}}]}]});Ext.define("Isu.controller.CreationRules",{extend:"Ext.app.Controller",stores:["Isu.store.CreationRules"],views:["Isu.view.creationrules.Overview"],refs:[{ref:"page",selector:"issue-creation-rules-overview"},{ref:"itemPanel",selector:"issue-creation-rules-overview issue-creation-rules-item"},{ref:"rulesGridPagingToolbarTop",selector:"issue-creation-rules-overview issues-creation-rules-list pagingtoolbartop"}],init:function(){this.control({"issue-creation-rules-overview issues-creation-rules-list":{select:this.showPreview},"issues-creation-rules-list uni-actioncolumn":{menuclick:this.chooseAction},"creation-rule-action-menu":{click:this.chooseAction},"issue-creation-rules-overview button[action=create]":{click:this.createRule}})},showOverview:function(){var a=Ext.widget("issue-creation-rules-overview");this.getApplication().fireEvent("changecontentevent",a)},showPreview:function(a,b){var c=this.getItemPanel(),d=c.down("form");c.setLoading(true);this.getModel("Isu.model.CreationRule").load(b.getId(),{success:function(e){if(!d.isDestroyed){d.loadRecord(e);d.up("panel").down("menu").record=e;c.setLoading(false);c.fireEvent("afterChange",c);c.setTitle(e.data.title)}}})},chooseAction:function(d,b){var c=b.action;var e=d.record.getId();var a=this.getController("Uni.controller.history.Router");switch(c){case"delete":this.showDeleteConfirmation(d.record);break;case"edit":a.getRoute("administration/creationrules/edit").forward({id:e});break}},createRule:function(){var a=this.getController("Uni.controller.history.Router");a.getRoute("administration/creationrules/add").forward()},showDeleteConfirmation:function(b){var a=this;Ext.create("Uni.view.window.Confirmation").show({msg:Uni.I18n.translate("administration.issueCreationRules.deleteConfirmation.msg","ISU","This issue creation rule will disappear from the list.<br>Issues will not be created automatically by this rule."),title:Ext.String.format(Uni.I18n.translate("administration.issueCreationRules.deleteConfirmation.title","ISU",'Delete rule "{0}"?'),b.get("name")),config:{me:a,rule:b},fn:function(c){switch(c){case"confirm":this.close();a.deleteRule(b);break;case"cancel":this.close();break}}})},deleteRule:function(d){var b=this,a=this.getStore("Isu.store.CreationRules"),c=this.getPage();c.setLoading("Removing...");d.destroy({params:{version:d.get("version")},callback:function(f,e){c.setLoading(false);if(e.response.status==204){c.down("#creation-rules-list pagingtoolbartop").totalCount=0;a.loadPage(1);b.getApplication().fireEvent("acknowledge",Uni.I18n.translate("administration.issueCreationRules.deleteSuccess.msg","ISU","Issue creation rule deleted"))}}})}});Ext.define("Isu.controller.IssueDetail",{extend:"Ext.app.Controller",showOverview:function(g,d,f,a){var c=this,b=c.getController("Uni.controller.history.Router"),e=Ext.widget(a,{router:b});c.getApplication().fireEvent("changecontentevent",e);e.setLoading(true);c.getModel(d).load(g,{callback:function(){e.setLoading(false)},success:function(h){if(!e.isDestroyed){c.getApplication().fireEvent("issueLoad",h);e.down("#issue-detail-top-title").setTitle(h.get("title"));c.getDetailForm().loadRecord(h);e.down("issues-action-menu").record=h;c.loadComments(h);c.setNavigationButtons(h,c.getStore(f))}},failure:function(){b.getRoute(b.currentRoute.replace("/view","")).forward()}})},loadComments:function(b){var a=this.getPage().down("#issue-comments-view"),c=b.comments();c.getProxy().url=b.getProxy().url+"/"+b.getId()+"/comments";a.bindStore(c);a.setLoading(true);c.load(function(d){if(!a.isDestroyed){c.add(d);a.setLoading(false);a.previousSibling("#no-issue-comments").setVisible(!d.length)}});if(this.getController("Uni.controller.history.Router").queryParams.addComment){this.showCommentForm()}},showCommentForm:function(){var a=this.getCommentsPanel();a.down("#issue-add-comment-form").show();a.down("#issue-add-comment-area").focus();a.down("#issue-comments-add-comment-button").hide()},hideCommentForm:function(){var a=this.getCommentsPanel();a.down("#issue-add-comment-form").hide();a.down("#issue-add-comment-area").reset();a.down("#issue-comments-add-comment-button").show()},validateCommentForm:function(a,b){this.getCommentsPanel().down("#issue-comment-save-button").setDisabled(!b.trim().length)},addComment:function(){var c=this,a=c.getCommentsPanel(),b=a.down("#issue-comments-view").getStore();b.add(a.down("#issue-add-comment-form").getValues());b.sync();a.down("#no-issue-comments").hide();c.hideCommentForm()},setNavigationButtons:function(g,c){var i=this,e=this.getNavigation(),d=e.down("[action=prev]"),a=e.down("[action=next]"),h=c.indexOf(g),j=this.getController("Uni.controller.history.Router"),b,f;if(h!==-1){h&&(b=h-1);(c.getCount()>(h+1))&&(f=h+1);if(b||b==0){d.setHref(j.getRoute(j.currentRoute).buildUrl({issueId:c.getAt(b).getId()}));d.on("click",function(){j.getRoute(j.currentRoute).forward({issueId:c.getAt(b).getId()})},i,{single:true})}else{d.setDisabled(true)}if(f){a.setHref(j.getRoute(j.currentRoute).buildUrl({issueId:c.getAt(f).getId()}));a.on("click",function(){j.getRoute(j.currentRoute).forward({issueId:c.getAt(f).getId()})},i,{single:true})}else{a.setDisabled(true)}e.show()}else{e.hide()}},chooseAction:function(b,a){if(!Ext.isEmpty(a.actionRecord)){this.applyActionImmediately(b.record,a.actionRecord)}},applyActionImmediately:function(a,d){var c=this,b=Ext.create(a.actions().model);b.setId(d.getId());b.set("parameters",{});b.getProxy().url=a.getProxy().url+"/"+a.getId()+"/actions";b.save({callback:function(f,e,h){var g=Ext.decode(e.response.responseText,true);if(g){if(g.data.actions[0].success){c.getApplication().fireEvent("acknowledge",g.data.actions[0].message);c.getModel(a.$className).load(a.getId(),{success:function(i){var j=c.getDetailForm();if(j){j.loadRecord(i)}}})}else{c.getApplication().getController("Uni.controller.Error").showError(f.get("name"),g.data.actions[0].message)}}}})}});Ext.define("Isu.util.IsuComboTooltip",{setComboTooltip:function(a){a.tooltip=Ext.DomHelper.append(Ext.getBody(),{tag:"div",html:a.tooltipText||"Start typing",cls:"isu-combo-tooltip"},true);a.tooltip.hide();a.on("destroy",function(){a.tooltip.destroy()});a.on("focus",this.onFocusComboTooltip,this);a.on("blur",this.onBlurComboTooltip,this)},onFocusComboTooltip:function(c){var b=c.tooltip,a=Ext.get(c.getEl());b.setStyle({width:a.getWidth(false)+"px",top:a.getY()+a.getHeight(false)+"px",left:a.getX()+"px"});if(!c.getValue()){b.show()}c.on("change",this.clearComboTooltip,this)},onBlurComboTooltip:function(b){var a=b.tooltip;a&&a.hide();b.un("change",this.clearComboTooltip,this)},clearComboTooltip:function(d,c){var a=d.picker,b=d.tooltip;if(c==null){d.reset();a&&a.hide();b&&b.show()}else{b&&b.hide();if(a){a.show();Ext.get(a.getEl()).setStyle({visibility:"visible"})}}},limitNotification:function(b){var a=b.getPicker();if(a){a.un("refresh",this.triggerLimitNotification,this);a.on("refresh",this.triggerLimitNotification,this)}},triggerLimitNotification:function(a){var b=a.getStore(),c=a.getEl().down("."+Ext.baseCSSPrefix+"list-plain");if(b.getTotalCount()>b.getCount()){c.appendChild({tag:"li",html:"Keep typing to narrow down",cls:Ext.baseCSSPrefix+"boundlist-item isu-combo-limit-notification"})}}});Ext.define("Isu.controller.IssuesOverview",{extend:"Ext.app.Controller",mixins:["Isu.util.IsuComboTooltip"],showOverview:function(a,b){var e=this,c=e.getController("Uni.controller.history.Router"),d=c.filter.get("grouping");if(c.queryParams.myopenissues){delete c.queryParams.myopenissues;e.getStore("Isu.store.IssueAssignees").load({params:{me:true},callback:function(f){c.filter.set("assignee",f[0].getId());c.filter.set("status","status.open");c.filter.set("sorting",[{type:"dueDate",value:Uni.component.sort.model.Sort.ASC}]);c.filter.save()}})}else{if(!c.queryParams.filter){c.filter.set("status","status.open");c.filter.set("sorting",[{type:"dueDate",value:Uni.component.sort.model.Sort.ASC}]);c.filter.save()}else{e.getStore("Isu.store.IssueStatuses").getProxy().setExtraParam("issueType",a);e.getStore("Isu.store.IssueReasons").getProxy().setExtraParam("issueType",a);e.getApplication().fireEvent("changecontentevent",Ext.widget(b,{router:c,groupingType:d&&d.type?d.type:"none"}));e.setFilter()}}},showPreview:function(a,b){var c=this.getPreview();c.setLoading(true);this.getModel(b.$className).load(b.getId(),{success:function(d){if(!c.isDestroyed){c.loadRecord(d);c.down("issues-action-menu").record=d;c.down("#issue-view-details-link").setHref(c.router.getRoute(c.router.currentRoute+"/view").buildUrl({issueId:d.getId()}));c.setTitle(d.get("title"))}},callback:function(){if(!c.isDestroyed){c.setLoading(false)}}})},chooseAction:function(b,a){if(!Ext.isEmpty(a.actionRecord)){this.applyActionImmediately(b.record,a.actionRecord)}},applyActionImmediately:function(a,d){var c=this,b=Ext.create(a.actions().model);b.setId(d.getId());b.set("parameters",{});b.getProxy().url=a.getProxy().url+"/"+a.getId()+"/actions";b.save({callback:function(g,f,h){var e=Ext.decode(f.response.responseText,true);if(e){if(e.data.actions[0].success){c.getApplication().fireEvent("acknowledge",e.data.actions[0].message);c.getIssuesGrid().getStore().load()}else{c.getApplication().getController("Uni.controller.Error").showError(g.get("name"),responseText.data.actions[0].message)}}}})},setFilter:function(){var b=this,a=b.getController("Uni.controller.history.Router"),c=b.getFilterForm();c.setLoading(true);b.loadFilterFormDependencies(a.filter,function(){c.loadRecord(a.filter);c.setLoading(false);b.setFilterToolbar(c)});b.setGrouping(a.filter);b.setSortingToolbar(a.filter)},setFilterToolbar:function(c){var a=this.getFilterToolbar(),b=c.down("[name=status]"),d=b.getFieldLabel();Ext.Array.each(b.query("checkbox"),function(e){if(e.getValue()){a.setFilter(e.getName()+"|"+e.inputValue,d,e.boxLabel)}});Ext.Array.each(c.query("combobox"),function(f){var e=f.getRawValue();if(!_.isEmpty(e)){a.setFilter(f.getName(),f.getFieldLabel(),e)}})},loadFilterFormDependencies:function(c,k){var h=this,e=this.getStore("Isu.store.IssueAssignees"),g=this.getStore("Isu.store.IssueReasons"),j=this.getStore("Isu.store.Devices"),f=c.get("assignee"),d=c.get("reason"),b=c.get("meter"),a=1,i=function(){a--;if(a===0){k()}};if(!Ext.isEmpty(f)){a++}if(!Ext.isEmpty(d)){a++}if(!Ext.isEmpty(b)){a++}this.getStore("Isu.store.IssueStatuses").load(i);if(!Ext.isEmpty(f)){if(e.getById(f)){i()}else{this.getModel("Isu.model.IssueAssignee").load(f,{callback:i,success:function(l){e.add(l)}})}}if(!Ext.isEmpty(d)){if(g.getById(d)){i()}else{this.getModel("Isu.model.IssueReason").load(d,{callback:i,success:function(l){g.add(l)}})}}if(!Ext.isEmpty(b)){if(j.getById(b)){i()}else{this.getModel("Isu.model.Device").load(b,{callback:i,success:function(l){j.add(l)}})}}},applyFilter:function(){var a=this,b=a.getFilterForm();b.updateRecord();b.getRecord().save()},resetFilter:function(){this.getController("Uni.controller.history.Router").filter.getProxy().destroy()},setFilterItem:function(a){var c=this,b=c.getController("Uni.controller.history.Router").filter;switch(a.filterBy){case"status":b.set(a.filterBy,[a.filterValue.id]);break;case"assignee":if(a.filterValue){b.set(a.filterBy,[a.filterValue.id,a.filterValue.type].join(":"))}else{b.set(a.filterBy,"-1:UnexistingType")}break;case"device":b.set("meter",a.filterValue.serialNumber);break;default:b.set(a.filterBy,a.filterValue.id)}b.save()},removeFilterItem:function(a){var b=this.getController("Uni.controller.history.Router").filter,c=/status\|\w+/;if(a.indexOf("status|")===0){if(Ext.isArray(b.get("status"))){Ext.Array.remove(b.get("status"),a.split("|")[1])}}else{b.set(a,null)}b.save()},setGroupingType:function(c,b){var a=this.getController("Uni.controller.history.Router").filter;a.set("grouping",{type:b});a.save()},setGroupingValue:function(a,b){var c=this.getController("Uni.controller.history.Router").filter;c.get("grouping").value=b.getId();c.save()},setGrouping:function(d){var g=this,f=d.get("grouping"),b=g.getGroupGrid(),e=b.getStore(),a={issueType:"datacollection"},c=g.getPreviewContainer();if(f&&f.type!=="none"){b.show();a.field=f.type;Ext.iterate(d.getData(),function(h,i){if(i){switch(h){case"assignee":a.assigneeId=i.split(":")[0];a.assigneeType=i.split(":")[1];break;case"grouping":break;case f.type:a.id=i;break;default:a[h]=i}}});e.load({params:a,callback:function(){var i=g.getGroupingTitle(),h=e.getById(f.value);if(f.value&&h){b.getSelectionModel().select(h);i.setTitle(Ext.String.format(i.title,f.type,h.get("reason")));i.show()}else{i.hide()}}});if(!f.value){c.hide();g.getNoGroupSelectedPanel().show()}}else{b.hide()}},setSortingToolbar:function(a){var b=this;b.getSortingToolbar().addSortButtons(a.get("sorting"))},addSortingItem:function(d,b){var a=this.getController("Uni.controller.history.Router").filter,c=a.get("sorting");if(Ext.isArray(c)){c.push({type:b.action,value:Uni.component.sort.model.Sort.ASC})}else{c=[{type:b.action,value:Uni.component.sort.model.Sort.ASC}]}a.save()},removeSortingItem:function(c){var a=this.getController("Uni.controller.history.Router").filter,b=a.get("sorting");if(Ext.isArray(b)){Ext.Array.remove(b,Ext.Array.findBy(b,function(d){return d.type===c}))}a.save()},changeSortDirection:function(d){var a=this.getController("Uni.controller.history.Router").filter,c=a.get("sorting"),b;if(Ext.isArray(c)){b=Ext.Array.findBy(c,function(e){return e.type===d});if(b){if(b.value===Uni.component.sort.model.Sort.ASC){b.value=Uni.component.sort.model.Sort.DESC}else{b.value=Uni.component.sort.model.Sort.ASC}}}a.save()}});Ext.define("Isu.controller.history.Administration",{extend:"Uni.controller.history.Converter",rootToken:"administration",previousPath:"",currentPath:null,routeConfig:{administration:{title:Uni.I18n.translate("route.administration","ISU","Administration"),route:"administration",disabled:true,items:{assignmentrules:{title:Uni.I18n.translate("route.assignmentRules","ISU","Assignment Rules"),route:"assignmentrules",controller:"Isu.controller.AssignmentRules",privileges:["privilege.view.assignmentRule"]},creationrules:{title:Uni.I18n.translate("route.issueCreationRules","ISU","Issue creation rules"),route:"creationrules",controller:"Isu.controller.CreationRules",privileges:["privilege.administrate.creationRule","privilege.view.creationRule"],items:{add:{title:Uni.I18n.translate("route.addIssueCreationRule","ISU","Add issue creation rule"),route:"add",controller:"Isu.controller.CreationRuleEdit",privileges:["privilege.administrate.creationRule"],action:"showCreate",items:{addaction:{title:Uni.I18n.translate("route.addAction","ISU","Add action"),route:"addaction",controller:"Isu.controller.CreationRuleActionEdit",action:"showCreate"}}},edit:{title:"Edit",route:"{id}/edit",controller:"Isu.controller.CreationRuleEdit",action:"showEdit",privileges:["privilege.administrate.creationRule"]}}}}}},init:function(){var a=this.getController("Uni.controller.history.Router");a.addConfig(this.routeConfig)}});Ext.define("Isu.controller.Main",{extend:"Ext.app.Controller",requires:["Ext.window.Window","Uni.controller.Navigation","Uni.controller.Configuration","Uni.controller.history.EventBus","Uni.model.PortalItem","Uni.store.PortalItems","Uni.store.MenuItems"],controllers:["Isu.controller.history.Administration","Isu.controller.AssignmentRules","Isu.controller.CreationRules","Isu.controller.CreationRuleEdit","Isu.controller.CreationRuleActionEdit","Isu.controller.IssuesOverview","Isu.controller.IssueDetail","Isu.controller.ApplyIssueAction"],init:function(){this.initMenu()},initMenu:function(){var d=this,c=null,b=[],a=d.getController("Uni.controller.history.Router"),e=d.getController("Isu.controller.history.Administration");if(Uni.Auth.hasAnyPrivilege(["privilege.view.assignmentRule","privilege.administrate.creationRule","privilege.view.creationRule"])){Uni.store.MenuItems.add(Ext.create("Uni.model.MenuItem",{text:"Administration",glyph:"settings",portal:"administration",index:10}))}if(Uni.Auth.hasAnyPrivilege(["privilege.view.assignmentRule","privilege.administrate.creationRule","privilege.view.creationRule"])){if(Uni.Auth.hasAnyPrivilege(["privilege.view.assignmentRule"])){b.push({text:"Issue assignment rules",href:a.getRoute("administration/assignmentrules").buildUrl()})}if(Uni.Auth.hasAnyPrivilege(["privilege.administrate.creationRule","privilege.view.creationRule"])){b.push({text:"Issue creation rules",href:a.getRoute("administration/creationrules").buildUrl()})}c=Ext.create("Uni.model.PortalItem",{title:"Issue management",portal:"administration",route:"issuemanagement",items:b})}if(c!==null){Uni.store.PortalItems.add(c)}}});Ext.define("Isu.model.Device",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"name",type:"string"},{name:"serialNumber",type:"string"},{name:"usagePoint",type:"auto"},{name:"serviceLocation",type:"auto"},{name:"serviceCategory",type:"auto"},{name:"version",type:"int"}],proxy:{type:"rest",url:"/api/isu/meters",reader:{type:"json",root:"data"}}});Ext.define("Isu.model.IssueStatus",{extend:"Ext.data.Model",fields:[{name:"id",type:"auto"},{name:"name",type:"string"},{name:"allowForClosing",type:"boolean"}],proxy:{type:"rest",url:"/api/isu/statuses",reader:{type:"json",root:"data"}}});Ext.define("Isu.model.IssueAssignee",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"idx",type:"string",convert:function(d,b){var a=null,e=b.get("id"),c=b.get("type");if(e&&c){a=e+":"+c}return a}},{name:"type",type:"auto"},{name:"name",type:"auto"}],idProperty:"idx",proxy:{type:"rest",url:"/api/isu/assignees",reader:{type:"json",root:"data"},buildUrl:function(b){var a=b.params.id,c;if(a){c=a.split(":");return this.url+"/"+c[0]+"?assigneeType="+c[1]}else{return this.url}}}});Ext.define("Isu.model.IssueComment",{extend:"Ext.data.Model",requires:["Ext.data.proxy.Rest"],fields:[{name:"author",type:"auto"},{name:"comment",type:"string"},{name:"creationDate",dateFormat:"time",type:"date"},{name:"version",type:"int"}],proxy:{type:"rest",url:"/api/idc/issue/{issue_id}/comments",reader:{type:"json",root:"data"}}});Ext.define("Isu.model.IssueAction",{extend:"Isu.model.Action",proxy:{type:"rest",reader:{type:"json",root:"data"}}});Ext.define("Isu.model.Issue",{extend:"Ext.data.Model",requires:["Isu.model.IssueReason","Isu.model.IssueStatus","Isu.model.Device","Isu.model.IssueAssignee","Isu.model.IssueComment","Isu.model.IssueAction"],fields:[{name:"id",type:"int"},{name:"dueDate",type:"date",dateFormat:"time"},{name:"creationDate",type:"date",dateFormat:"time"},{name:"version",type:"int"},{name:"status",type:"auto"},{name:"assignee",type:"auto"},{name:"reason",type:"auto"},{name:"device",type:"auto"},{name:"title",persist:false,mapping:function(a){return a.reason.name+(a.device?" to "+a.device.name+" "+a.device.serialNumber:"")}},{name:"reason_name",persist:false,mapping:"reason.name"},{name:"status_name",persist:false,mapping:"status.name"},{name:"device_name",persist:false,mapping:"device.name"},{name:"assignee_name",persist:false,mapping:"assignee.name"},{name:"assignee_type",persist:false,mapping:"assignee.type"},{name:"usage_point",persist:false,mapping:"device.usagePoint.info"},{name:"service_location",persist:false,mapping:"device.serviceLocation.info"},{name:"service_category",persist:false,mapping:"device.serviceCategory.info"}],associations:[{type:"hasOne",model:"Isu.model.IssueReason",associationKey:"reason",name:"reason",getterName:"getReason",setterName:"setReason"},{type:"hasOne",model:"Isu.model.IssueStatus",associationKey:"status",name:"status",getterName:"getStatus",setterName:"setStatus"},{type:"hasOne",model:"Isu.model.Device",associationKey:"device",name:"device",getterName:"getDevice",setterName:"setDevice"},{type:"hasOne",model:"Isu.model.IssueAssignee",associationKey:"assignee",name:"assignee",getterName:"getAssignee",setterName:"setAssignee"},{type:"hasMany",model:"Isu.model.IssueComment",associationKey:"comments",name:"comments"},{type:"hasMany",model:"Isu.model.IssueAction",associationKey:"actions",name:"actions"}]});Ext.define("Isu.model.IssuesFilter",{extend:"Ext.data.Model",requires:["Uni.data.proxy.QueryStringProxy"],fields:["status","assignee","reason","meter","grouping","sorting"],proxy:{type:"querystring",root:"filter",destroy:function(){var a=Ext.decode(this.router.queryParams[this.root]);Ext.iterate(a,function(b,c){if(b!=="grouping"&&b!=="sorting"){a[b]=""}});this.router.queryParams[this.root]=Ext.encode(a);this.router.getRoute().forward(this.router.arguments,this.router.queryParams)}}});Ext.define("Isu.store.Devices",{extend:"Ext.data.Store",model:"Isu.model.Device",pageSize:50,autoLoad:false});Ext.define("Isu.store.IssueActions",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],model:"Isu.model.Action",autoLoad:false,proxy:{type:"rest",reader:{type:"json",root:"data"}}});Ext.define("Isu.store.IssueAssignees",{extend:"Ext.data.Store",requires:["Ext.data.proxy.Rest"],model:"Isu.model.IssueAssignee",pageSize:100,groupField:"type",autoLoad:false,sorters:[{sorterFn:function(b,a){return b.get("name").toUpperCase()>a.get("name").toUpperCase()}}]});Ext.define("Isu.store.IssueGrouping",{extend:"Ext.data.Store",fields:[{name:"id",type:"string"},{name:"value",type:"string"}],data:[{id:"none",value:"None"},{id:"reason",value:"Reason"}]});Ext.define("Isu.store.IssueStatuses",{extend:"Ext.data.Store",model:"Isu.model.IssueStatus",autoLoad:false});Ext.define("Isu.view.component.AssigneeCombo",{extend:"Ext.ux.Rixo.form.field.GridPicker",alias:"widget.issues-assignee-combo",store:"Isu.store.IssueAssignees",displayField:"name",valueField:"idx",triggerAction:"query",queryMode:"remote",queryParam:"like",allQuery:"",lastQuery:"",queryDelay:100,minChars:0,disableKeyFilter:true,queryCaching:false,formBind:true,typeAhead:true,anchor:"100%",forceSelection:true,gridConfig:{emptyText:"No assignee found",resizable:false,stripeRows:true,features:[{ftype:"grouping",groupHeaderTpl:"{name}",collapsible:false}],columns:[{header:false,xtype:"templatecolumn",tpl:'<tpl if="type"><span class="isu-icon-{type} isu-assignee-type-icon"></span></tpl> {name}',flex:1}]},listeners:{focus:{fn:function(a){if(!a.getValue()){a.doQuery(a.getValue())}}},change:{fn:function(b,a){if(!a){b.reset()}}},beforequery:{fn:function(b){var a=b.combo.store;if(b.query){a.group("type")}else{a.clearGrouping()}}}}});Ext.define("Isu.view.issues.ActionMenu",{extend:"Ext.menu.Menu",alias:"widget.issues-action-menu",store:"Isu.store.IssueActions",plain:true,border:false,shadow:false,defaultAlign:"tr-br?",minHeight:60,router:null,mixins:{bindable:"Ext.util.Bindable"},predefinedItems:[{text:Uni.I18n.translate("issues.actionMenu.addComment","ISU","Add comment"),hidden:Uni.Auth.hasNoPrivilege("privilege.comment.issue"),action:"addComment"}],listeners:{show:{fn:function(){var a=this;a.removeAll();if(a.record){a.store.getProxy().url=a.record.getProxy().url+"/"+a.record.getId()+"/actions";a.store.load(function(){a.onLoad();a.setLoading(false)});setTimeout(function(){a.setLoading(true)},1)}else{}}}},initComponent:function(){var a=this;a.bindStore(a.store||"ext-empty-store",true);this.callParent(arguments)},onLoad:function(){var f=this,e,b,a,d,c;if(!f.router){return}f.removeAll();f.store.each(function(g){var h=false;switch(g.get("name")){case"Assign issue":h=Uni.Auth.hasNoPrivilege("privilege.assign.issue");break;case"Close issue":h=Uni.Auth.hasNoPrivilege("privilege.close.issue");break;case"Retry now":h=Uni.Auth.hasNoPrivilege("privilege.view.scheduleDevice");break;case"Send someone to inspect":h=Uni.Auth.hasNoPrivilege("privilege.action.issue");break;case"Notify user":h=Uni.Auth.hasNoPrivilege("privilege.action.issue");break}var i={text:g.get("name"),hidden:h};if(Ext.isEmpty(g.get("parameters"))){i.actionRecord=g}else{i.href=f.router.getRoute(f.router.currentRoute.replace("/view","")+"/view/action").buildUrl({issueId:f.record.getId(),actionId:g.getId()})}f.add(i)});if(f.predefinedItems&&f.predefinedItems.length){Ext.Array.each(f.predefinedItems,function(g){switch(g.action){case"addComment":delete g.action;g.href=f.router.getRoute(f.router.currentRoute.replace("/view","")+"/view").buildUrl({issueId:f.record.getId()},{addComment:true});break}});f.add(f.predefinedItems)}if(Uni.Auth.hasAnyPrivilege(["privilege.administrate.device","privilege.view.device"])){e=f.record.get("deviceMRID");if(e){b=f.record.get("comTaskId");a=f.record.get("comTaskSessionId");d=f.record.get("connectionTaskId");c=f.record.get("comSessionId");if(b&&a){f.add({text:Uni.I18n.translate("issues.actionMenu.viewCommunicationLog","ISU","View communication log"),href:f.router.getRoute("devices/device/communicationtasks/history/viewlog").buildUrl({mRID:e,comTaskId:b,historyId:a},{filter:{logLevels:["Error","Warning","Information"]}}),hrefTarget:"_blank"})}if(d&&c){f.add({text:Uni.I18n.translate("issues.actionMenu.viewConnectionLog","ISU","View connection log"),href:f.router.getRoute("devices/device/connectionmethods/history/viewlog").buildUrl({mRID:e,connectionMethodId:d,historyId:c},{filter:{logLevels:["Error","Warning","Information"],logTypes:["connections","communications"]}}),hrefTarget:"_blank"})}}}}});Ext.define("Isu.view.issues.AddCommentForm",{extend:"Ext.form.Panel",alias:"widget.issue-add-comment-form",layout:"fit",items:{itemId:"issue-add-comment-area",xtype:"textareafield",height:100,fieldLabel:"Comment",labelAlign:"top",name:"comment"},bbar:{layout:{type:"hbox",align:"left"},items:[{itemId:"issue-comment-save-button",text:"Add",ui:"action",action:"send",disabled:true},{itemId:"issue-comment-cancel-adding-button",text:"Cancel",action:"cancel",ui:"link"}]}});Ext.define("Isu.view.issues.CommentsList",{extend:"Ext.panel.Panel",requires:["Isu.view.issues.AddCommentForm","Uni.view.notifications.NoItemsFoundPanel"],alias:"widget.issue-comments",title:"Comments",ui:"medium",buttonAlign:"left",items:[{xtype:"no-items-found-panel",itemId:"no-issue-comments",title:"No comments found",reasons:["No comments created yet on this issue"],hidden:true},{xtype:"dataview",itemId:"issue-comments-view",title:"User Images",itemSelector:"div.thumb-wrap",tpl:new Ext.XTemplate('<tpl for=".">','{[xindex > 1 ? "<hr>" : ""]}','<p><span class="isu-icon-USER"></span><b>{author.name}</b> added a comment - {[values.creationDate ? this.formatCreationDate(values.creationDate) : ""]}</p>',"<p>{comment}</p>","</tpl>",{formatCreationDate:function(a){a=Ext.isDate(a)?a:new Date(a);return Ext.Date.format(a,"M d, Y (H:i)")}}),header:"Name",dataIndex:"name"},{xtype:"issue-add-comment-form",itemId:"issue-add-comment-form",hidden:true}],buttons:[{itemId:"issue-comments-add-comment-button",ui:"action",text:"Add comment",hidden:Uni.Auth.hasNoPrivilege("privilege.comment.issue"),action:"add"}]});Ext.define("Isu.view.issues.DetailNavigation",{extend:"Ext.toolbar.Toolbar",alias:"widget.issue-detail-navigation",defaultButtonUI:"link",rtl:false,items:[{xtype:"tbfill"},{itemId:"data-collection-issue-navigation-previous",text:Uni.I18n.translate("general.previous","ISU","Previous"),action:"prev"},{itemId:"data-collection-issue-navigation-next",text:Uni.I18n.translate("general.next","ISU","Next"),action:"next"}]});Ext.define("Isu.view.issues.DetailTop",{extend:"Ext.container.Container",alias:"widget.issue-detail-top",requires:["Isu.view.issues.ActionMenu"],layout:{type:"hbox",align:"middle"},router:null,initComponent:function(){var a=this;a.items=[{itemId:"issue-detail-top-title",title:"&nbsp;",ui:"large",flex:1},{xtype:"button",itemId:"issue-detail-top-actions-button",text:Uni.I18n.translate("general.actions","ISU","Actions"),hidden:Uni.Auth.hasAnyPrivilege(["privilege.comment.issue","privilege.close.issue","privilege.assign.issue","privilege.action.issue","privilege.administrate.device","privilege.view.device","privilege.view.scheduleDevice"]),iconCls:"x-uni-action-iconD",menu:{xtype:"issues-action-menu",itemId:"issue-detail-action-menu",predefinedItems:null,router:a.router},listeners:{click:function(){this.showMenu()}}}];a.callParent(arguments)}});Ext.define("Isu.view.issues.Grid",{extend:"Ext.grid.Panel",requires:["Ext.grid.column.Date","Ext.grid.column.Template","Uni.grid.column.Action","Uni.view.toolbar.PagingTop","Uni.view.toolbar.PagingBottom","Isu.view.issues.ActionMenu","Isu.view.component.AssigneeColumn"],alias:"widget.issues-grid",router:null,initComponent:function(){var a=this;a.columns=[{itemId:"issues-grid-title",header:Uni.I18n.translate("general.title.title","ISU","Title"),dataIndex:"title",flex:2,renderer:function(e,c,b){var d=a.router.getRoute(a.router.currentRoute+"/view").buildUrl({issueId:b.getId()});return'<a href="'+d+'">'+e+"</a>"}},{itemId:"issues-grid-due-date",header:Uni.I18n.translate("general.title.dueDate","ISU","Due date"),dataIndex:"dueDate",xtype:"datecolumn",format:"M d Y",width:140},{itemId:"issues-grid-status",header:Uni.I18n.translate("general.title.status","ISU","Status"),dataIndex:"status_name",width:100},{itemId:"issues-grid-assignee",header:Uni.I18n.translate("general.title.assignee","ISU","Assignee"),xtype:"isu-assignee-column",dataIndex:"assignee",flex:1},{itemId:"action",xtype:"uni-actioncolumn",hidden:Uni.Auth.hasAnyPrivilege(["privilege.comment.issue","privilege.close.issue","privilege.assign.issue","privilege.action.issue","privilege.administrate.device","privilege.view.device","privilege.view.scheduleDevice"]),menu:{xtype:"issues-action-menu",itemId:"issues-overview-action-menu",router:a.router}}];a.dockedItems=[{itemId:"pagingtoolbartop",xtype:"pagingtoolbartop",dock:"top",store:a.store,displayMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.displayMsg","ISU","{0} - {1} of {2} issues"),displayMoreMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.displayMoreMsg","ISU","{0} - {1} of more than {2} issues"),emptyMsg:Uni.I18n.translate("workspace.issues.pagingtoolbartop.emptyMsg","ISU","There are no issues to display"),items:["->",{xtype:"button",itemId:"issues-bulk-action",text:Uni.I18n.translate("general.title.bulkActions","ISU","Bulk action"),hidden:!Uni.Auth.hasAnyPrivilege(["privilege.close.issue","privilege.assign.issue"]),action:"issuesBulkAction",href:a.router.getRoute(a.router.currentRoute+"/bulkaction").buildUrl()}]},{itemId:"pagingtoolbarbottom",xtype:"pagingtoolbarbottom",dock:"bottom",store:a.store,itemsPerPageMsg:Uni.I18n.translate("workspace.issues.pagingtoolbarbottom.itemsPerPage","ISU","Issues per page")}];a.callParent(arguments)}});Ext.define("Isu.view.issues.GroupGrid",{extend:"Ext.grid.Panel",requires:["Uni.view.toolbar.PagingTop","Uni.view.toolbar.PagingBottom"],alias:"widget.issues-group-grid",columns:[{itemId:"reason",text:"Reason",dataIndex:"reason",flex:1},{itemId:"issues_num",text:"Issues",dataIndex:"number",width:100}],initComponent:function(){var a=this;a.dockedItems=[{xtype:"pagingtoolbartop",dock:"top",store:a.store,displayMsg:Uni.I18n.translate("workspace.issues.groupGrid.pagingtoolbartop.displayMsg","ISU","{0} - {1} of {2} items"),displayMoreMsg:Uni.I18n.translate("workspace.issues.groupGrid.pagingtoolbartop.displayMoreMsg","ISU","{0} - {1} of more than {2} items"),emptyMsg:"0 reasons"},{xtype:"pagingtoolbarbottom",dock:"bottom",store:a.store,deferLoading:true,itemsPerPageMsg:Uni.I18n.translate("workspace.issues.groupGrid.pagingtoolbartop.itemsPerPageMsg","ISU","Items per page")}];a.callParent(arguments)}});Ext.define("Isu.view.issues.GroupingTitle",{extend:"Ext.panel.Panel",alias:"widget.issues-grouping-title",ui:"medium",title:Uni.I18n.translate("general.issuesFor","ISU","Issues for {0}: {1}"),padding:0});Ext.define("Isu.view.issues.GroupingToolbar",{extend:"Uni.view.panel.FilterToolbar",alias:"widget.issues-grouping-toolbar",title:Uni.I18n.translate("general.group","ISU","Group"),showClearButton:false,store:"Isu.store.IssueGrouping",groupingType:null,initComponent:function(){var a=this;a.content={xtype:"combobox",itemId:"issues-grouping-toolbar-combo",store:a.store,editable:true,forceSelection:true,value:a.groupingType,queryMode:"local",displayField:"value",valueField:"id"};a.callParent(arguments)}});Ext.define("Isu.view.issues.NoGroupSelectedPanel",{extend:"Uni.view.notifications.NoItemsFoundPanel",alias:"widget.no-issues-group-selected-panel",title:Uni.I18n.translate("issues.group.empty.title","ISU","No group selected"),reasons:[Uni.I18n.translate("issues.group.empty.list.item1","ISU","No group have been selected yet.")],stepItems:[{xtype:"component",html:Uni.I18n.translate("issues.group.selectGroup","ISU","Select a group of issues.")}]});Ext.define("Isu.view.issues.NoIssuesFoundPanel",{extend:"Uni.view.notifications.NoItemsFoundPanel",alias:"widget.no-issues-found-panel",title:Uni.I18n.translate("issues.empty.title","ISU","No issues found"),reasons:[Uni.I18n.translate("workspace.issues.empty.list.item1","ISU","No issues have been defined yet."),Uni.I18n.translate("workspace.issues.empty.list.item2","ISU","No issues comply to the filter.")]});Ext.define("Isu.view.issues.SideFilter",{extend:"Ext.form.Panel",alias:"widget.issues-side-filter",cls:"filter-form",width:200,title:Uni.I18n.translate("general.title.filter","ISU","Filter"),ui:"filter",requires:["Isu.view.component.AssigneeCombo","Uni.view.form.CheckboxGroup","Uni.component.filter.view.Filter"],defaults:{labelAlign:"top"},items:[{itemId:"filter-by-status",xtype:"checkboxstore",store:"Isu.store.IssueStatuses",name:"status",fieldLabel:Uni.I18n.translate("general.title.status","ISU","Status"),columns:1,vertical:true},{itemId:"filter-by-assignee",xtype:"issues-assignee-combo",name:"assignee",fieldLabel:Uni.I18n.translate("general.title.assignee","ISU","Assignee"),forceSelection:true,anyMatch:true,emptyText:"select an assignee",tooltipText:"Start typing for assignee"},{itemId:"filter-by-reason",xtype:"combobox",name:"reason",fieldLabel:Uni.I18n.translate("general.title.reason","ISU","Reason"),displayField:"name",valueField:"id",forceSelection:true,store:"Isu.store.IssueReasons",listConfig:{cls:"isu-combo-color-list",emptyText:"No reason found"},queryMode:"remote",queryParam:"like",queryDelay:100,queryCaching:false,minChars:1,triggerAction:"query",anchor:"100%",emptyText:"select a reason",tooltipText:"Start typing for reason"},{itemId:"filter-by-meter",xtype:"combobox",name:"meter",fieldLabel:Uni.I18n.translate("general.title.meter","ISU","Meter"),displayField:"name",valueField:"name",forceSelection:true,store:"Isu.store.Devices",listConfig:{cls:"isu-combo-color-list",emptyText:"No meter found"},queryMode:"remote",queryParam:"like",queryDelay:100,queryCaching:false,minChars:1,triggerAction:"query",anchor:"100%",emptyText:"select a MRID of the meter",tooltipText:"Start typing for a MRID"}],dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{itemId:"issues-filter-apply",ui:"action",text:Uni.I18n.translate("general.apply","ISU","Apply"),action:"applyFilter"},{itemId:"issues-filter-reset",text:Uni.I18n.translate("general.clearAll","ISU","Clear all"),action:"resetFilter"}]}]});Ext.define("Isu.view.issues.SortingMenu",{extend:"Ext.menu.Menu",alias:"widget.issues-sorting-menu",shadow:false,border:false,plain:true,items:[{itemId:"issues-sorting-menu-item-by-due-date",text:"Due date",action:"dueDate"}]});Ext.define("Isu.view.issues.SortingToolbar",{extend:"Uni.view.panel.FilterToolbar",requires:["Uni.view.button.SortItemButton","Isu.view.issues.SortingMenu"],alias:"widget.issues-sorting-toolbar",title:Uni.I18n.translate("general.sort","ISU","Sort"),emptyText:Uni.I18n.translate("general.none","ISU","None"),showClearButton:false,tools:[{itemId:"addSort",xtype:"button",action:"addSort",text:"Add sort",menu:{xtype:"issues-sorting-menu",itemId:"issues-sorting-menu"}}],addSortButtons:function(e){var d=this,b=d.getContainer(),c,a;b.removeAll();if(Ext.isArray(e)){Ext.Array.each(e,function(f){if(f.value){c=d.down("#issues-sorting-menu [action="+f.type+"]");a=f.value===Uni.component.sort.model.Sort.ASC?"x-btn-sort-item-asc":"x-btn-sort-item-desc";c.hide();b.add({xtype:"sort-item-btn",itemId:"issues-sort-by-"+f.type+"-button",text:c.text,sortType:f.type,sortDirection:f.value,iconCls:a,listeners:{closeclick:function(){d.fireEvent("removeSort",this.sortType,this.sortDirection)},click:function(){d.fireEvent("changeSortDirection",this.sortType,this.sortDirection)}}})}})}}});